const t={money:0,playerStats:{atk:10,maxHp:100,hp:100},costs:{atk:50,hp:50,unlockWeak2:50,unlockWeak3:100,unlockStrong:150,unlockCombo1:250,unlockCombo2:400,unlockAutoAim:300,upSDmg:100,upSRng:100,upC1Dmg:150,upC1Rng:150,upC2Dmg:200,upC2Rng:200},unlocks:{weak2:!1,weak3:!1,strong:!1,combo1:!1,combo2:!1,autoAim:!1},comboLevels:{sDmg:1,sRng:1,c1Dmg:1,c1Rng:1,c2Dmg:1,c2Rng:1},stats:{zCount:0,xCount:0,kills:0,critCount:0,upgradeCount:0},inventory:[],currentWave:1,maxWave:1,selectedWave:1,sessionMoney:0,sessionDrops:[],itemDB:[{icon:"üî©",name:"Êõ≤„Åå„Å£„Åü„Éú„É´„Éà",desc:"Ë¶èÊ†ºÂ§ñ„ÅÆÈÉ®ÂìÅ„ÄÇ"},{icon:"üîã",name:"ÊûØÊ∏á„Åó„ÅüÈõªÊ±†",desc:"ÂæÆ„Åã„Å´ÁÜ±„ÇíÂ∏Ø„Å≥„Å¶„ÅÑ„Çã„ÄÇ"},{icon:"üíæ",name:"Á†¥Êêç„Åó„ÅüË®òÊÜ∂Â™í‰Ωì",desc:"„Éá„Éº„Çø„ÅØÂÆåÂÖ®„Å´È£õ„Çì„Åß„ÅÑ„Çã„ÄÇ"},{icon:"üß∏",name:"ÁÑ¶„Åí„Åü„Å¨„ÅÑ„Åê„Çã„Åø",desc:"Ë™∞„Åã„ÅÆÂÆùÁâ©„Å†„Å£„Åü„ÄÇ"}],storyData:{journalIndex:0}},me=[{reqUpgrades:1,title:"ÊâãË®ò #001",text:"Èò≤Ë°õ„Ç∑„Çπ„ÉÜ„É†Ëµ∑Âãï„ÄÇ„Ç∑„Çπ„ÉÜ„É†Ê≠£Â∏∏„ÄÇÁîü‰ΩìÂèçÂøú„ÄÅËá™ÂàÜ„ÅÆ„Åø„ÄÇËá™ÂàÜ„ÅåË™∞„Å™„ÅÆ„Åã„ÄÅ„Å™„Åú„Åì„Åì„Å´„ÅÑ„Çã„ÅÆ„ÅãÊÄù„ÅÑÂá∫„Åõ„Å™„ÅÑ„ÄÇ"},{reqUpgrades:3,title:"ÊâãË®ò #002",text:"Ê©ü‰Ωì„ÅÆÂº∑Âåñ„Éó„É≠„Çª„Çπ„Å´ÈÅïÂíåÊÑü„Åå„ÅÇ„Çã„ÄÇÂäπÁéá„ÅåËâØ„Åô„Åé„Çã„ÄÇ„Åæ„Çã„Åß„ÄÅ„ÅÇ„Çâ„Åã„Åò„ÇÅ„Åì„ÅÜ„Å™„Çã„Åì„Å®„Åå‰∫àÊúü„Åï„Çå„Å¶„ÅÑ„Åü„Åã„ÅÆ„Çà„ÅÜ„Å´„ÄÇ"},{reqUpgrades:6,title:"ÊâãË®ò #003",text:"ËøéÊíÉAI„ÅÆË£úÂä©„ÄÇÁßÅ„ÅÆÊÄùËÄÉ„ÇíÂÖàË™≠„Åø„Åó„Å¶„ÅÑ„Çã„Åã„ÅÆ„Çà„ÅÜ„Å†„ÄÇÁßÅ„ÅåÊ©ü‰Ωì„ÇíÊìçÁ∏¶„Åó„Å¶„ÅÑ„Çã„ÅÆ„Åã„ÄÅ„Åù„Çå„Å®„ÇÇÊ©ü‰Ωì„ÅåÁßÅ„ÇíÊìçÁ∏¶„Åó„Å¶„ÅÑ„Çã„ÅÆ„Åã„ÄÇ"},{reqUpgrades:10,title:"ÊâãË®ò #004",text:"„Åµ„Å®ÊìçÁ∏¶Ê°ø„Åã„ÇâÊâã„ÇíÈõ¢„Åó„Å¶„Åø„Åü„ÄÇÊ©ü‰Ωì„ÅØ‚Ä¶ÂÆåÁíß„Å™ËøéÊíÉ„ÇíÁ∂ö„Åë„Åü„ÄÇÁßÅ„Å®„ÅÑ„ÅÜÂ≠òÂú®„Å´ÊÑèÂë≥„ÅØ„ÅÇ„Çã„ÅÆ„ÅãÔºü"},{reqUpgrades:15,title:"ÊâãË®ò #005",text:"ÁßÅ„ÅØÈò≤Ë°õ„Éó„É≠„Ç∞„É©„É†„Å†„ÄÇ„Åã„Å§„Å¶‰∫∫Èñì„Å†„Å£„Åü„ÄåË™∞„Åã„Äç„ÅÆË®òÊÜ∂„ÇíÁÑº„Åç‰ªò„Åë„Çâ„Çå„Åü„ÄÅ„Åü„Å†„ÅÆÈò≤Ë°õÂÖµÂô®„ÄÇ‚Ä¶„Åù„Çå„Åß„ÇÇ„ÄÅ„Åì„ÅÆÊã†ÁÇπ„ÇíÂÆà„ÇäÊäú„Åè„ÄÇ"}],Ee=[{id:"arc_5",targetWave:5,icon:"üì±",name:"Ê±öÊüìÊ∏¨ÂÆöÂô®",desc:"ÊóßÊôÇ‰ª£„ÅÆÈÅ∫Áâ©„ÄÇ",storyTitle:"ÊñáÊòéË®òÈå≤: Â¥©Â£ä",storyText:"„ÄåÂ§ßÊ∞óÊ±öÊüìÂ∫¶99%„ÄÇÂú∞Ë°®„ÅÆÂÆåÂÖ®ÊîæÊ£Ñ„ÇíÊ±∫ÂÆö„ÄÇËá™ÂæãÂûãÁí∞Â¢ÉÊµÑÂåñÊ©üÊßã„ÇíËµ∑Âãï„Åô„Çã„ÄÇ„Äç"},{id:"arc_10",targetWave:10,icon:"‚öôÔ∏è",name:"Ëá™ÂæãÊ©üÊ¢∞„ÅÆ„Ç≥„Ç¢",desc:"ÊïµÊ©ü„ÅÆÂøÉËáìÈÉ®„ÄÇ",storyTitle:"ÊñáÊòéË®òÈå≤: Êö¥Ëµ∞",storyText:"„ÄåÊµÑÂåñÊ©üÊßã„ÅØÂú∞Ë°®„ÅÆ„ÄéÊúâÊ©üÁâ©„Åô„Åπ„Å¶„Äè„ÇíÊ±öÊüìÊ∫ê„Å®„Åø„Å™„Åó„ÄÅÊéíÈô§„ÇíÈñãÂßã„Åó„Åü„ÄÇÊàë„ÄÖ„ÅØËá™„Çâ‰Ωú„Å£„ÅüÊ©üÊ¢∞„Å´ÊÆ∫„Åï„Çå„Çã„ÄÇ„Äç"},{id:"arc_15",targetWave:15,icon:"üß™",name:"„Ç´„Éó„Çª„É´„ÅÆÁ†¥Áâá",desc:"Êã†ÁÇπ„ÅÆÊ∑±ÈÉ®„Å®Âêå„ÅòÊùêË≥™„ÄÇ",storyTitle:"ÊñáÊòéË®òÈå≤: Áú†„Çä",storyText:"„ÄåÊàë„ÄÖ„ÅØ„Åì„ÅÆÂú∞‰∏ãÊã†ÁÇπ„ÅßÁú†„Çä„Å´„Å§„Åè„ÄÇÊµÑÂåñ„ÅåÁµÇ„Çè„Çä„ÄÅÂÜç„Å≥Èùí„ÅÑÁ©∫„ÅåË¶ã„Åà„ÇãÊó•„Åæ„Åß„ÄÇÈò≤Ë°õ„Ç∑„Çπ„ÉÜ„É†„Çà„ÄÅÊàë„ÄÖ„ÇíÂÆà„Å£„Å¶„Åè„Çå„ÄÇ„Äç"},{id:"arc_20",targetWave:20,icon:"üëë",name:"Êóß‰∫∫È°û„ÅÆÁéãÂÜ†",desc:"Ê®©Âäõ„ÅÆË±°Âæ¥„ÄÇ",storyTitle:"ÊñáÊòéË®òÈå≤: ÁµÇÁÑâ",storyText:"ÊµÑÂåñÊ©üÊßã„Å´ÁµÇ„Çè„Çä„ÅØË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Å™„Åã„Å£„Åü„ÄÇÂΩº„Çâ„ÅØ„Åö„Å£„Å®„ÄÅÂ≠òÂú®„Åó„Å™„ÅÑÊïµ„Å®Êà¶„ÅÑÁ∂ö„Åë„Å¶„ÅÑ„Çã„ÄÇÁßÅ„ÇÇ„Åæ„ÅüÂêå„Åò„Å†„ÄÇ"}],ue=[{id:"z100",type:"zCount",target:500,name:"Á¥†ÊåØ„ÇäËÅ∑‰∫∫",desc:"Âº±ÊîªÊíÉ„ÇíÁ¥ØË®à500Âõû‰ΩøÁî®",rewardDesc:"Âü∫Á§éÊîªÊíÉÂäõ +5",unlocked:!1},{id:"z500",type:"zCount",target:2500,name:"ÈÄ£Êâì„ÅÆÈ¨º",desc:"Âº±ÊîªÊíÉ„ÇíÁ¥ØË®à2500Âõû‰ΩøÁî®",rewardDesc:"Âü∫Á§éÊîªÊíÉÂäõ +10",unlocked:!1},{id:"x50",type:"xCount",target:250,name:"Èáç„ÅÑ‰∏ÄÊíÉ",desc:"Âº∑ÊîªÊíÉ„ÇíÁ¥ØË®à250Âõû‰ΩøÁî®",rewardDesc:"Âü∫Á§éÊîªÊíÉÂäõ +5",unlocked:!1},{id:"x200",type:"xCount",target:1e3,name:"Á†¥Â£äË°ùÂãï",desc:"Âº∑ÊîªÊíÉ„ÇíÁ¥ØË®à1000Âõû‰ΩøÁî®",rewardDesc:"Âü∫Á§éÊîªÊíÉÂäõ +10",unlocked:!1},{id:"k100",type:"kills",target:500,name:"Êñ∞Á±≥Èò≤Ë°õËÄÖ",desc:"Êïµ„ÇíÁ¥ØË®à500‰ΩìË®é‰ºê",rewardDesc:"ÊúÄÂ§ßHP +50",unlocked:!1},{id:"k500",type:"kills",target:2500,name:"ÁÜüÁ∑¥„ÅÆÊéÉÈô§Â±ã",desc:"Êïµ„ÇíÁ¥ØË®à2500‰ΩìË®é‰ºê",rewardDesc:"ÊúÄÂ§ßHP +100",unlocked:!1},{id:"c10",type:"critCount",target:10,name:"Â•áË∑°„ÅÆ‰∏ÄÊíÉ",desc:"„ÇØ„É™„ÉÜ„Ç£„Ç´„É´„ÇíÁ¥ØË®à10ÂõûÁô∫Âãï",rewardDesc:"Âü∫Á§éÊîªÊíÉÂäõ +15",unlocked:!1},{id:"c50",type:"critCount",target:50,name:"Á•ûÊá∏„Åã„Çä",desc:"„ÇØ„É™„ÉÜ„Ç£„Ç´„É´„ÇíÁ¥ØË®à50ÂõûÁô∫Âãï",rewardDesc:"Âü∫Á§éÊîªÊíÉÂäõ +30",unlocked:!1}],p={base:document.getElementById("screen-base"),battle:document.getElementById("screen-battle")},Le=document.getElementById("base-money"),Ie=document.getElementById("stat-atk"),Te=document.getElementById("stat-hp"),Be=document.getElementById("cost-atk"),Ce=document.getElementById("cost-hp"),N=document.getElementById("btn-upgrade-atk"),j=document.getElementById("btn-upgrade-hp"),S=document.getElementById("btn-ul-weak2"),Me=document.getElementById("txt-ul-weak2"),Se=document.getElementById("cost-ul-weak2"),D=document.getElementById("btn-ul-weak3"),De=document.getElementById("txt-ul-weak3"),We=document.getElementById("cost-ul-weak3"),Re=document.getElementById("skill-weak3"),W=document.getElementById("btn-ul-strong"),Ae=document.getElementById("cost-ul-strong"),ze=document.getElementById("skill-strong"),He=document.getElementById("strong-upgrades"),P=document.getElementById("btn-up-s-dmg"),Ue=document.getElementById("lvl-s-dmg"),$e=document.getElementById("cost-s-dmg"),Y=document.getElementById("btn-up-s-rng"),Ne=document.getElementById("lvl-s-rng"),je=document.getElementById("cost-s-rng"),R=document.getElementById("btn-ul-combo1"),Pe=document.getElementById("cost-ul-combo1"),Ye=document.getElementById("skill-combo1"),qe=document.getElementById("combo1-upgrades"),q=document.getElementById("btn-up-c1-dmg"),Oe=document.getElementById("lvl-c1-dmg"),Xe=document.getElementById("cost-c1-dmg"),O=document.getElementById("btn-up-c1-rng"),Fe=document.getElementById("lvl-c1-rng"),Ge=document.getElementById("cost-c1-rng"),A=document.getElementById("btn-ul-combo2"),Je=document.getElementById("cost-ul-combo2"),Ve=document.getElementById("skill-combo2"),Ke=document.getElementById("combo2-upgrades"),X=document.getElementById("btn-up-c2-dmg"),Qe=document.getElementById("lvl-c2-dmg"),Ze=document.getElementById("cost-c2-dmg"),F=document.getElementById("btn-up-c2-rng"),_e=document.getElementById("lvl-c2-rng"),et=document.getElementById("cost-c2-rng"),z=document.getElementById("btn-unlock-autoaim"),tt=document.getElementById("cost-ul-autoaim"),st=document.getElementById("txt-unlocked-autoaim"),ge=document.getElementById("btn-wave-prev"),he=document.getElementById("btn-wave-next"),nt=document.getElementById("disp-selected-wave"),ot=document.getElementById("btn-sortie"),ie=document.getElementById("shelf-container"),ae=document.getElementById("item-description"),c=document.getElementById("game-canvas"),x=c.getContext("2d"),it=document.getElementById("hud-wave"),at=document.getElementById("hud-base-money"),lt=document.getElementById("hud-session-money"),le=document.getElementById("hud-hp-bar"),rt=document.getElementById("hud-hp-val"),dt=document.getElementById("hud-max-hp-val"),ct=document.getElementById("hud-enemies"),mt=document.getElementById("hud-skill-name"),te=document.getElementById("wave-modal"),ut=document.getElementById("modal-money"),re=document.getElementById("drop-notification"),gt=document.getElementById("drop-item-icon"),ht=document.getElementById("drop-item-name"),ft=document.getElementById("drop-title"),yt=document.getElementById("btn-return"),pt=document.getElementById("btn-next-wave"),fe=document.getElementById("death-modal"),bt=document.getElementById("btn-death-return"),d=document.getElementById("practice-canvas"),T=d.getContext("2d"),vt=document.getElementById("prac-hud-skill");function U(){const s=document.getElementById("canvas-container");s&&(c.width=s.clientWidth,c.height=s.clientHeight);const e=d.parentElement;e&&(d.width=e.clientWidth,d.height=e.clientHeight),p.base.classList.contains("active")&&document.getElementById("tab-status").classList.contains("block")&&oe()}function kt(s,e,n="bg-blue-900"){const o=document.getElementById("general-toast");document.getElementById("toast-title").innerText=s,document.getElementById("toast-desc").innerText=e,o.className=o.className.replace(/bg-[a-z]+-\d+/g,""),o.classList.add(n.split(" ")[0]),o.classList.remove("opacity-0","-translate-y-20"),o.classList.add("translate-y-0","opacity-100"),setTimeout(()=>{o.classList.add("opacity-0","-translate-y-20"),o.classList.remove("translate-y-0","opacity-100")},4e3)}window.switchTab=function(s){document.querySelectorAll(".tab-content").forEach(o=>{o.classList.add("hidden"),o.classList.remove("block")});const e=document.getElementById("tab-"+s);e.classList.remove("hidden"),e.classList.add("block"),document.querySelectorAll(".tab-btn").forEach(o=>{o.classList.remove("border-blue-500","text-blue-400"),o.classList.add("border-transparent","text-gray-400")});const n=document.getElementById("tab-btn-"+s);n.classList.remove("border-transparent","text-gray-400"),n.classList.add("border-blue-500","text-blue-400"),s==="status"&&setTimeout(U,50),s==="upgrade"&&se(),s==="item"&&(ne(),ye())};function V(s){Object.values(p).forEach(e=>e.classList.remove("active")),p[s].classList.add("active"),s==="base"?(y(),se(),ne(),ye(),document.getElementById("tab-status").classList.contains("block")&&setTimeout(U,50)):s==="battle"&&(U(),Bt())}function k(){t.stats.upgradeCount++;const s=me.find(e=>e.reqUpgrades===t.stats.upgradeCount);if(s){t.storyData.journalIndex++;const e=document.getElementById("story-toast");document.getElementById("toast-story-name").innerText=s.title,e.classList.remove("opacity-0","-translate-y-20"),e.classList.add("translate-y-0","opacity-100"),setTimeout(()=>{e.classList.add("opacity-0","-translate-y-20"),e.classList.remove("translate-y-0","opacity-100")},4e3)}}function ye(){const s=document.getElementById("journal-list");if(s.innerHTML="",t.storyData.journalIndex===0)s.innerHTML='<div class="text-center text-gray-500 py-4 text-sm border border-gray-700 rounded bg-gray-900">Ë®òÈå≤„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì</div>';else for(let o=0;o<t.storyData.journalIndex;o++){const i=me[o],a=document.createElement("div");a.className="p-3 rounded border bg-blue-900/20 border-blue-800",a.innerHTML=`
                <div class="font-bold text-blue-300 text-sm mb-1">${i.title}</div>
                <div class="text-sm text-gray-300 leading-relaxed">${i.text}</div>
            `,s.appendChild(a)}const e=document.getElementById("archive-list");e.innerHTML="";const n=t.inventory.filter(o=>o.storyTitle);n.length===0?e.innerHTML='<div class="text-center text-gray-500 py-4 text-sm border border-gray-700 rounded bg-gray-900">ÈÅ∫Áâ©„ÇíÂõûÂèé„Åó„Å¶„ÅÑ„Åæ„Åõ„Çì</div>':n.forEach(o=>{const i=document.createElement("div");i.className="p-3 rounded border bg-yellow-900/20 border-yellow-800",i.innerHTML=`
                <div class="font-bold text-yellow-300 text-sm mb-1">${o.icon} ${o.storyTitle}</div>
                <div class="text-sm text-gray-300 leading-relaxed">${o.storyText}</div>
            `,e.appendChild(i)})}function xt(){let s=!1;ue.forEach(e=>{!e.unlocked&&t.stats[e.type]>=e.target&&(e.unlocked=!0,e.id==="z100"&&(t.playerStats.atk+=5),e.id==="z500"&&(t.playerStats.atk+=10),e.id==="x50"&&(t.playerStats.atk+=5),e.id==="x200"&&(t.playerStats.atk+=10),e.id==="k100"&&(t.playerStats.maxHp+=50,t.playerStats.hp+=50),e.id==="k500"&&(t.playerStats.maxHp+=100,t.playerStats.hp+=100),e.id==="c10"&&(t.playerStats.atk+=15),e.id==="c50"&&(t.playerStats.atk+=30),wt(e),s=!0)}),s&&p.base.classList.contains("active")&&(y(),se())}function wt(s){const e=document.getElementById("achievement-toast");document.getElementById("toast-achieve-name").innerText=s.name,document.getElementById("toast-achieve-reward").innerText=s.rewardDesc,e.classList.remove("opacity-0","-translate-y-20"),e.classList.add("translate-y-0","opacity-100"),setTimeout(()=>{e.classList.add("opacity-0","-translate-y-20"),e.classList.remove("translate-y-0","opacity-100")},4e3)}function se(){const s=document.getElementById("achievement-list");s.innerHTML="",ue.forEach(e=>{const n=document.createElement("div");n.className=`p-3 rounded border ${e.unlocked?"bg-yellow-900/40 border-yellow-600":"bg-gray-800 border-gray-600 opacity-60"}`,n.innerHTML=`
            <div class="flex justify-between items-center mb-1">
                <div class="font-bold ${e.unlocked?"text-yellow-400":"text-gray-400"}">${e.unlocked?"üèÜ ":""}${e.name}</div>
                <div class="text-xs ${e.unlocked?"text-green-400":"text-gray-500"}">${e.unlocked?"ÈÅîÊàêÊ∏à":`${t.stats[e.type]} / ${e.target}`}</div>
            </div>
            <div class="text-sm text-gray-300">${e.desc}</div>
            <div class="text-xs text-blue-300 mt-1">Â†±ÈÖ¨: ${e.rewardDesc}</div>
        `,s.appendChild(n)})}function y(){Le.innerText=t.money,Ie.innerText=t.playerStats.atk,Te.innerText=t.playerStats.maxHp,Be.innerText=t.costs.atk,Ce.innerText=t.costs.hp;const s=document.getElementById("stat-max-wave"),e=document.getElementById("stat-kills");s&&(s.innerText=t.maxWave),e&&(e.innerText=t.stats.kills),N.disabled=t.money<t.costs.atk,j.disabled=t.money<t.costs.hp,N.className=N.disabled?"w-full bg-gray-600 text-gray-400 px-2 py-1 rounded font-bold cursor-not-allowed text-xs flex justify-between items-center mt-1":"w-full bg-blue-600 hover:bg-blue-500 text-white px-2 py-1 rounded font-bold transition text-xs flex justify-between items-center mt-1 cursor-pointer",j.className=j.disabled?"w-full bg-gray-600 text-gray-400 px-2 py-1 rounded font-bold cursor-not-allowed text-xs flex justify-between items-center mt-1":"w-full bg-green-600 hover:bg-green-500 text-white px-2 py-1 rounded font-bold transition text-xs flex justify-between items-center mt-1 cursor-pointer",Re.classList.toggle("hidden",!t.unlocks.weak2),ze.classList.toggle("hidden",!t.unlocks.weak3),Ye.classList.toggle("hidden",!t.unlocks.strong),Ve.classList.toggle("hidden",!t.unlocks.combo1),t.unlocks.weak2?(S.classList.add("hidden"),Me.classList.remove("hidden")):(Se.innerText=t.costs.unlockWeak2,S.disabled=t.money<t.costs.unlockWeak2,S.className=S.disabled?"bg-gray-600 text-gray-400 px-3 py-1 rounded font-bold cursor-not-allowed text-sm flex-shrink-0 ml-2":"bg-purple-600 hover:bg-purple-500 text-white px-3 py-1 rounded font-bold transition text-sm flex-shrink-0 ml-2"),t.unlocks.weak3?(D.classList.add("hidden"),De.classList.remove("hidden")):(We.innerText=t.costs.unlockWeak3,D.disabled=t.money<t.costs.unlockWeak3,D.className=D.disabled?"bg-gray-600 text-gray-400 px-3 py-1 rounded font-bold cursor-not-allowed text-sm flex-shrink-0 ml-2":"bg-purple-600 hover:bg-purple-500 text-white px-3 py-1 rounded font-bold transition text-sm flex-shrink-0 ml-2"),t.unlocks.strong?(W.classList.add("hidden"),He.classList.remove("hidden"),$e.innerText=t.costs.upSDmg,Ue.innerText=t.comboLevels.sDmg,P.disabled=t.money<t.costs.upSDmg,P.className=P.disabled?"flex-1 bg-gray-600 text-gray-400 px-2 py-1 text-xs rounded font-bold cursor-not-allowed":"flex-1 bg-blue-600 hover:bg-blue-500 text-white px-2 py-1 text-xs rounded transition font-bold",je.innerText=t.costs.upSRng,Ne.innerText=t.comboLevels.sRng,Y.disabled=t.money<t.costs.upSRng,Y.className=Y.disabled?"flex-1 bg-gray-600 text-gray-400 px-2 py-1 text-xs rounded font-bold cursor-not-allowed":"flex-1 bg-teal-600 hover:bg-teal-500 text-white px-2 py-1 text-xs rounded transition font-bold"):(Ae.innerText=t.costs.unlockStrong,W.disabled=t.money<t.costs.unlockStrong,W.className=W.disabled?"bg-gray-600 text-gray-400 px-3 py-1 rounded font-bold cursor-not-allowed text-sm flex-shrink-0 ml-2":"bg-purple-600 hover:bg-purple-500 text-white px-3 py-1 rounded font-bold transition text-sm flex-shrink-0 ml-2"),t.unlocks.combo1?(R.classList.add("hidden"),qe.classList.remove("hidden"),Xe.innerText=t.costs.upC1Dmg,Oe.innerText=t.comboLevels.c1Dmg,q.disabled=t.money<t.costs.upC1Dmg,q.className=q.disabled?"flex-1 bg-gray-600 text-gray-400 px-2 py-1 text-xs rounded font-bold cursor-not-allowed":"flex-1 bg-blue-600 hover:bg-blue-500 text-white px-2 py-1 text-xs rounded transition font-bold",Ge.innerText=t.costs.upC1Rng,Fe.innerText=t.comboLevels.c1Rng,O.disabled=t.money<t.costs.upC1Rng,O.className=O.disabled?"flex-1 bg-gray-600 text-gray-400 px-2 py-1 text-xs rounded font-bold cursor-not-allowed":"flex-1 bg-teal-600 hover:bg-teal-500 text-white px-2 py-1 text-xs rounded transition font-bold"):(Pe.innerText=t.costs.unlockCombo1,R.disabled=t.money<t.costs.unlockCombo1,R.className=R.disabled?"bg-gray-600 text-gray-400 px-3 py-1 rounded font-bold cursor-not-allowed text-sm flex-shrink-0 ml-2":"bg-purple-600 hover:bg-purple-500 text-white px-3 py-1 rounded font-bold transition text-sm flex-shrink-0 ml-2"),t.unlocks.combo2?(A.classList.add("hidden"),Ke.classList.remove("hidden"),Ze.innerText=t.costs.upC2Dmg,Qe.innerText=t.comboLevels.c2Dmg,X.disabled=t.money<t.costs.upC2Dmg,X.className=X.disabled?"flex-1 bg-gray-600 text-gray-400 px-2 py-1 text-xs rounded font-bold cursor-not-allowed":"flex-1 bg-blue-600 hover:bg-blue-500 text-white px-2 py-1 text-xs rounded transition font-bold",et.innerText=t.costs.upC2Rng,_e.innerText=t.comboLevels.c2Rng,F.disabled=t.money<t.costs.upC2Rng,F.className=F.disabled?"flex-1 bg-gray-600 text-gray-400 px-2 py-1 text-xs rounded font-bold cursor-not-allowed":"flex-1 bg-teal-600 hover:bg-teal-500 text-white px-2 py-1 text-xs rounded transition font-bold"):(Je.innerText=t.costs.unlockCombo2,A.disabled=t.money<t.costs.unlockCombo2,A.className=A.disabled?"bg-gray-600 text-gray-400 px-3 py-1 rounded font-bold cursor-not-allowed text-sm flex-shrink-0 ml-2":"bg-purple-600 hover:bg-purple-500 text-white px-3 py-1 rounded font-bold transition text-sm flex-shrink-0 ml-2"),t.unlocks.autoAim?(z.classList.add("hidden"),st.classList.remove("hidden")):(tt.innerText=t.costs.unlockAutoAim,z.disabled=t.money<t.costs.unlockAutoAim,z.className=z.disabled?"bg-gray-600 text-gray-400 px-3 py-1 rounded font-bold cursor-not-allowed text-sm flex-shrink-0 ml-2":"bg-purple-600 hover:bg-purple-500 text-white px-3 py-1 rounded font-bold transition text-sm flex-shrink-0 ml-2"),nt.innerText=t.selectedWave,ge.disabled=t.selectedWave<=1,he.disabled=t.selectedWave>=t.maxWave}N.addEventListener("click",()=>{t.money>=t.costs.atk&&(t.money-=t.costs.atk,t.playerStats.atk+=2,t.costs.atk=Math.floor(t.costs.atk*1.5),y(),k())});j.addEventListener("click",()=>{t.money>=t.costs.hp&&(t.money-=t.costs.hp,t.playerStats.maxHp+=20,t.costs.hp=Math.floor(t.costs.hp*1.5),y(),k())});z.addEventListener("click",()=>{t.money>=t.costs.unlockAutoAim&&(t.money-=t.costs.unlockAutoAim,t.unlocks.autoAim=!0,y(),k())});S.addEventListener("click",()=>{t.money>=t.costs.unlockWeak2&&(t.money-=t.costs.unlockWeak2,t.unlocks.weak2=!0,y(),k())});D.addEventListener("click",()=>{t.money>=t.costs.unlockWeak3&&(t.money-=t.costs.unlockWeak3,t.unlocks.weak3=!0,y(),k())});W.addEventListener("click",()=>{t.money>=t.costs.unlockStrong&&(t.money-=t.costs.unlockStrong,t.unlocks.strong=!0,y(),k())});P.addEventListener("click",()=>{t.money>=t.costs.upSDmg&&(t.money-=t.costs.upSDmg,t.comboLevels.sDmg++,t.costs.upSDmg=Math.floor(t.costs.upSDmg*1.5),y(),k())});Y.addEventListener("click",()=>{t.money>=t.costs.upSRng&&(t.money-=t.costs.upSRng,t.comboLevels.sRng++,t.costs.upSRng=Math.floor(t.costs.upSRng*1.5),y(),k())});R.addEventListener("click",()=>{t.money>=t.costs.unlockCombo1&&(t.money-=t.costs.unlockCombo1,t.unlocks.combo1=!0,y(),k())});q.addEventListener("click",()=>{t.money>=t.costs.upC1Dmg&&(t.money-=t.costs.upC1Dmg,t.comboLevels.c1Dmg++,t.costs.upC1Dmg=Math.floor(t.costs.upC1Dmg*1.5),y(),k())});O.addEventListener("click",()=>{t.money>=t.costs.upC1Rng&&(t.money-=t.costs.upC1Rng,t.comboLevels.c1Rng++,t.costs.upC1Rng=Math.floor(t.costs.upC1Rng*1.5),y(),k())});A.addEventListener("click",()=>{t.money>=t.costs.unlockCombo2&&(t.money-=t.costs.unlockCombo2,t.unlocks.combo2=!0,y(),k())});X.addEventListener("click",()=>{t.money>=t.costs.upC2Dmg&&(t.money-=t.costs.upC2Dmg,t.comboLevels.c2Dmg++,t.costs.upC2Dmg=Math.floor(t.costs.upC2Dmg*1.5),y(),k())});F.addEventListener("click",()=>{t.money>=t.costs.upC2Rng&&(t.money-=t.costs.upC2Rng,t.comboLevels.c2Rng++,t.costs.upC2Rng=Math.floor(t.costs.upC2Rng*1.5),y(),k())});ge.addEventListener("click",()=>{t.selectedWave>1&&(t.selectedWave--,y(),p.base.classList.contains("active")&&document.getElementById("tab-status").classList.contains("block")&&oe())});he.addEventListener("click",()=>{t.selectedWave<t.maxWave&&(t.selectedWave++,y(),p.base.classList.contains("active")&&document.getElementById("tab-status").classList.contains("block")&&oe())});ot.addEventListener("click",()=>{t.currentWave=t.selectedWave,V("battle")});function ne(){ie.innerHTML="";for(let s=0;s<40;s++){const e=document.createElement("div");e.className="shelf-cell rounded",e.id=`cell_${s}`,e.addEventListener("dragover",n=>{n.preventDefault(),e.classList.add("drag-over")}),e.addEventListener("dragleave",()=>e.classList.remove("drag-over")),e.addEventListener("drop",n=>{n.preventDefault(),e.classList.remove("drag-over"),Et(n.dataTransfer.getData("text/plain"),e.id)}),ie.appendChild(e)}t.inventory.forEach(s=>{const e=document.getElementById(s.cellId);if(e){const n=document.createElement("div");n.className="item text-3xl",n.id=s.id,n.innerText=s.icon,n.draggable=!0,n.addEventListener("mouseenter",()=>{let o=`<span class="font-bold ${s.storyTitle?"text-yellow-300":"text-white"}">${s.name}</span><br>${s.desc}`;ae.innerHTML=o}),n.addEventListener("mouseleave",()=>ae.innerHTML="„Ç¢„Ç§„ÉÜ„É†„Çí„Éõ„Éê„Éº„ÅßË©≥Á¥∞Ë°®Á§∫"),n.addEventListener("dragstart",o=>{o.dataTransfer.setData("text/plain",s.id),setTimeout(()=>n.style.opacity="0.5",0)}),n.addEventListener("dragend",()=>n.style.opacity="1"),e.appendChild(n)}})}function Et(s,e){const n=t.inventory.findIndex(o=>o.id===s);n>-1&&document.getElementById(e).children.length===0&&(t.inventory[n].cellId=e,ne())}const b=80;let f=1;function w(s,e,n){const o=n*b;return e/2-o/2+b/2+s*b}function pe(s,e,n){const o=n*b,i=e/2-o/2;let a=Math.floor((s-i)/b);return Math.max(0,Math.min(n-1,a))}function Lt(s,e){let n=null,o=1,i=null,a=null,u=!1,r=0;return e==="x"?(s==="zzx"&&t.unlocks.combo2?(n={type:"wide",range:(150+(t.comboLevels.c2Rng-1)*30)/4,height:b*3,color:"rgba(250, 204, 21, 0.7)",maxDuration:.3,knockback:10},o=1.2+(t.comboLevels.c2Dmg-1)*.2,i="„Ç∞„É©„É≥„Éâ„Éª„ÇØ„É≠„Çπ",a="from-yellow-300 to-orange-500",r=.4):s==="zx"&&t.unlocks.combo1?(n={type:"pierce",range:250+(t.comboLevels.c1Rng-1)*60,height:60,color:"rgba(56, 189, 248, 0.7)",maxDuration:.2,knockback:15},o=1.3+(t.comboLevels.c1Dmg-1)*.25,i="„Éî„Ç¢„Ç∑„É≥„Ç∞„Éª„É¨„Ç§",a="from-cyan-400 to-blue-600",r=.4):t.unlocks.strong&&(n={type:"front-wide",range:120+(t.comboLevels.sRng-1)*30,height:b*3,color:"rgba(248, 113, 113, 0.6)",maxDuration:.3,knockback:12},o=1.5+(t.comboLevels.sDmg-1)*.2,i="„ÉØ„Ç§„Éâ„Éª„Çπ„Ç¶„Ç£„Éº„Éó",a="from-red-400 to-red-600",r=1.2),u=!0):s==="z"?(n={type:"normal",range:100,height:30,color:"rgba(255, 255, 255, 0.5)",maxDuration:.1,knockback:2},o=1,r=.15):s==="zz"&&t.unlocks.weak2?(n={type:"normal",range:120,height:35,color:"rgba(255, 255, 255, 0.6)",maxDuration:.1,knockback:3},o=1.2,r=.15):s==="zzz"&&t.unlocks.weak3?(n={type:"normal",range:150,height:40,color:"rgba(255, 255, 255, 0.8)",maxDuration:.15,knockback:5},o=1.5,u=!0,r=.6):(n={type:"normal",range:100,height:30,color:"rgba(255, 255, 255, 0.5)",maxDuration:.1,knockback:2},o=1,u="z",r=.15),{ad:n,dmgMult:o,skillName:i,skillColor:a,resetCombo:u,cd:r}}class be{constructor(){this.row=Math.floor(f/2),this.facing=1,this.size=24,this.color="#3b82f6",this.comboHistory=[],this.comboTimer=0,this.attackCooldown=0,this.lastMaxCooldown=0,this.isAttacking=!1,this.attackData=null}move(e){this.isAttacking||(this.row=Math.max(0,Math.min(f-1,this.row+e)))}turn(e){this.isAttacking||(this.facing=e)}update(e,n){this.attackCooldown>0&&(this.attackCooldown-=e),this.comboTimer>0&&(this.comboTimer-=e,this.comboTimer<=0&&(this.comboHistory=[],n&&n())),this.isAttacking&&this.attackData&&(this.attackData.duration-=e,this.attackData.duration<=0&&(this.isAttacking=!1))}draw(e,n,o){const i=n/2,a=w(this.row,o,f);e.save(),e.fillStyle="rgba(0,0,0,0.3)",e.beginPath(),e.ellipse(i,a+16,12,4,0,0,Math.PI*2),e.fill(),this.facing===-1&&(e.translate(i,a),e.scale(-1,1),e.translate(-i,-a)),e.fillStyle="#1e3a8a",e.fillRect(i-6,a+6,4,10),e.fillRect(i+2,a+6,4,10),e.fillStyle=this.color,e.fillRect(i-8,a-8,16,16),e.fillStyle="#60a5fa",e.fillRect(i-4,a-4,8,10),e.fillStyle="#cbd5e1",e.fillRect(i-6,a-20,12,12),e.fillStyle="#38bdf8",e.fillRect(i+2,a-16,6,4),e.fillStyle="#94a3b8",e.fillRect(i-4,a-6,12,4);let u=0,r=i+6,m=a-4;if(this.isAttacking&&this.attackData){let g=1-this.attackData.duration/this.attackData.maxDuration;u=Math.PI/4+g*Math.PI,r+=4}else u=-Math.PI/6;if(e.translate(r,m),e.rotate(u),e.fillStyle="#b45309",e.fillRect(-2,-2,4,8),e.fillStyle="#fbbf24",e.fillRect(-6,-4,12,2),e.fillStyle="#e2e8f0",e.beginPath(),e.moveTo(-3,-4),e.lineTo(-2,-30),e.lineTo(0,-34),e.lineTo(2,-30),e.lineTo(3,-4),e.fill(),e.rotate(-u),e.translate(-r,-m),e.restore(),this.isAttacking&&this.attackData){const g=this.attackData;e.fillStyle=g.color,e.globalAlpha=Math.max(0,g.duration/g.maxDuration);const h=this.facing;if(g.type==="normal")e.beginPath(),e.arc(i+10*h,a,g.range,-Math.PI/3,Math.PI/3,h===-1),e.lineTo(i+10*h,a),e.fill();else if(g.type==="pierce")e.fillRect(i+16*h,a-g.height/2,g.range*h,g.height),e.fillStyle="#fff",e.fillRect(i+16*h,a-2,g.range*h,4);else if(g.type==="wide"||g.type==="front-wide"){const Q=Math.max(0,this.row-1),C=Math.min(f-1,this.row+1),l=w(Q,o,f),L=w(C,o,f)-l+b;g.type==="wide"?(e.fillRect(i-25,a-b/2,(g.range+25)*h,b),e.fillRect(i+g.range/2*h-b/2,l-b/2,b,L)):(e.beginPath(),e.arc(i+10*h,a,g.range,-Math.PI/1.5,Math.PI/1.5,h===-1),e.lineTo(i+10*h,a),e.fill())}e.globalAlpha=1}if(this.attackCooldown>0&&this.lastMaxCooldown>0){const g=Math.max(0,this.attackCooldown/this.lastMaxCooldown),h=40;e.fillStyle="rgba(0,0,0,0.7)",e.fillRect(i-h/2,a+25,h,6),e.fillStyle=this.attackCooldown>.4?"rgba(255, 100, 100, 0.9)":"rgba(255, 200, 0, 0.9)",e.fillRect(i-h/2,a+25,h*g,6)}}}class ee{constructor(e,n,o,i){this.row=e,this.side=n,this.size=i?18:12,this.speed=(i?30:45+Math.random()*20)*(1+(o-1)*.2),this.x=0,this.y=0,this.maxHp=(i?60:20)*o,this.hp=this.maxHp,this.color=i?"#b91c1c":"#ef4444",this.damage=(i?20:10)*o,this.value=Math.max(1,Math.floor((i?7.5:1.5)*Math.sqrt(o))),this.knockback=0}update(e,n){const o=n/2;this.knockback>0?(this.x-=this.side*this.knockback*e*10,this.knockback-=e*20):(this.x+=this.side*this.speed*e,this.side===1&&this.x>o-35&&(this.x=o-35),this.side===-1&&this.x<o+35&&(this.x=o+35))}draw(e){e.save(),e.fillStyle="rgba(0,0,0,0.3)",e.beginPath(),e.ellipse(this.x,this.y+this.size,this.size*.8,4,0,0,Math.PI*2),e.fill(),this.side===-1&&(e.translate(this.x,this.y),e.scale(-1,1),e.translate(-this.x,-this.y)),e.fillStyle=this.color,this.maxHp>=60?(e.fillRect(this.x-this.size,this.y-this.size,this.size*2,this.size*2),e.fillStyle="#450a0a",e.beginPath(),e.moveTo(this.x,this.y-this.size),e.lineTo(this.x+8,this.y-this.size-12),e.lineTo(this.x+12,this.y-this.size),e.fill(),e.fillStyle="#fef08a",e.fillRect(this.x+4,this.y-4,8,4),e.fillStyle="#334155",e.fillRect(this.x-this.size-2,this.y+this.size-4,this.size*2+4,6)):(e.beginPath(),e.arc(this.x,this.y,this.size,0,Math.PI*2),e.fill(),e.fillStyle="#fff",e.beginPath(),e.arc(this.x+this.size*.4,this.y-2,this.size/3,0,Math.PI*2),e.fill(),e.fillStyle="#000",e.beginPath(),e.arc(this.x+this.size*.5,this.y-2,this.size/6,0,Math.PI*2),e.fill(),e.strokeStyle="#94a3b8",e.lineWidth=2,e.beginPath(),e.ellipse(this.x,this.y+this.size*.5,this.size*1.2,this.size*.4,0,0,Math.PI*2),e.stroke()),e.restore(),this.hp<this.maxHp&&(e.fillStyle="red",e.fillRect(this.x-10,this.y-this.size-10,20,3),e.fillStyle="lightgreen",e.fillRect(this.x-10,this.y-this.size-10,20*(this.hp/this.maxHp),3))}}class _{constructor(e,n,o,i,a,u,r){this.x=e,this.y=n,this.vx=o,this.vy=i,this.maxLife=a,this.life=a,this.color=u,this.size=r}update(e){this.x+=this.vx*e,this.y+=this.vy*e,this.life-=e}draw(e){e.fillStyle=this.color,e.globalAlpha=Math.max(0,this.life/this.maxLife),e.beginPath(),e.arc(this.x,this.y,this.size,0,Math.PI*2),e.fill(),e.globalAlpha=1}}class It{constructor(e,n,o,i){this.x=e+(Math.random()*20-10),this.y=n-10,this.text=Math.floor(o).toString(),this.life=.8,this.maxLife=.8,this.vy=-40,this.isCritical=i}update(e){this.y+=this.vy*e,this.life-=e}draw(e){e.save(),e.globalAlpha=Math.max(0,this.life/this.maxLife),e.font=this.isCritical?"900 24px sans-serif":"bold 16px sans-serif",e.fillStyle=this.isCritical?"#fbbf24":"#ffffff",e.textAlign="center",e.strokeStyle="#000000",e.lineWidth=this.isCritical?4:3,e.strokeText(this.text,this.x,this.y),e.fillText(this.text,this.x,this.y),e.restore()}}function B(s,e){s==="z"&&t.stats.zCount++,s==="x"&&t.stats.xCount++,e?de(v,s,!0):isWaveActive&&de(player,s,!1),xt()}window.tryMove=function(s){p.battle.classList.contains("active")&&isWaveActive?player.move(s):p.base.classList.contains("active")&&document.getElementById("tab-status").classList.contains("block")&&v.move(s)};window.tryTurn=function(s){p.battle.classList.contains("active")&&isWaveActive?player.turn(s):p.base.classList.contains("active")&&document.getElementById("tab-status").classList.contains("block")&&v.turn(s)};window.addEventListener("keydown",s=>{const e=s.key.toLowerCase();let n=null,o=p.base.classList.contains("active")&&document.getElementById("tab-status").classList.contains("block"),i=p.battle.classList.contains("active")&&isWaveActive;if(!(!o&&!i)&&((e==="w"||s.key==="ArrowUp")&&(window.tryMove(-1),n="vbtn-up"),(e==="s"||s.key==="ArrowDown")&&(window.tryMove(1),n="vbtn-down"),(e==="a"||s.key==="ArrowLeft")&&(window.tryTurn(-1),n="vbtn-left"),(e==="d"||s.key==="ArrowRight")&&(window.tryTurn(1),n="vbtn-right"),(e==="z"||e==="j")&&(B("z",o),n="vbtn-z"),(e==="x"||e==="k")&&(B("x",o),n="vbtn-x"),n&&i)){const a=document.getElementById(n);a&&a.classList.add("key-active")}});window.addEventListener("keyup",s=>{const e=s.key.toLowerCase();let n=null;if((e==="w"||s.key==="ArrowUp")&&(n="vbtn-up"),(e==="s"||s.key==="ArrowDown")&&(n="vbtn-down"),(e==="a"||s.key==="ArrowLeft")&&(n="vbtn-left"),(e==="d"||s.key==="ArrowRight")&&(n="vbtn-right"),(e==="z"||e==="j")&&(n="vbtn-z"),(e==="x"||e==="k")&&(n="vbtn-x"),n&&p.battle.classList.contains("active")){const o=document.getElementById(n);o&&o.classList.remove("key-active")}});c.addEventListener("mousemove",s=>{if(!isWaveActive||!player||player.isAttacking)return;const e=c.getBoundingClientRect(),n=s.clientX-e.left,o=s.clientY-e.top,i=c.width/2;player.turn(n<i?-1:1),player.row=pe(o,c.height,f)});c.addEventListener("mousedown",s=>{if(isWaveActive){if(s.preventDefault(),player&&!player.isAttacking){const e=c.getBoundingClientRect();player.turn(s.clientX-e.left<c.width/2?-1:1)}s.button===0?B("z",!1):s.button===2&&B("x",!1)}});c.addEventListener("contextmenu",s=>s.preventDefault());d.addEventListener("mousemove",s=>{if(!p.base.classList.contains("active")||!document.getElementById("tab-status").classList.contains("block")||!v||v.isAttacking)return;const e=d.getBoundingClientRect(),n=s.clientX-e.left,o=s.clientY-e.top,i=d.width/2;v.turn(n<i?-1:1),v.row=pe(o,d.height,f)});d.addEventListener("mousedown",s=>{if(!(!p.base.classList.contains("active")||!document.getElementById("tab-status").classList.contains("block"))){if(s.preventDefault(),v&&!v.isAttacking){const e=d.getBoundingClientRect();v.turn(s.clientX-e.left<d.width/2?-1:1)}s.button===0?B("z",!0):s.button===2&&B("x",!0)}});d.addEventListener("contextmenu",s=>s.preventDefault());function de(s,e,n){if(s.attackCooldown>0)return;if(!n&&t.unlocks.autoAim){let a=c.width/2,u=enemies.find(r=>r.row===s.row&&Math.abs(r.x-a)<=50);u&&s.turn(u.x<a?-1:1)}s.comboHistory.push(e),s.comboTimer=1;const o=s.comboHistory.join(""),i=Lt(o,e);i.resetCombo===!0?s.comboHistory=[]:i.resetCombo==="z"&&(s.comboHistory=["z"]),i.ad&&(s.attackCooldown=i.cd,s.lastMaxCooldown=i.cd),$(s.comboHistory,n),i.skillName&&ve(i.skillName,i.skillColor,n),i.ad&&Tt(s,i.ad,i.dmgMult,n)}function $(s,e){const n=e?"prac-guide-container":"battle-guide-container",o=document.getElementById(n);if(!o)return;const i=s.join("");let a="",u="bg-blue-600",r=!1,m="",g="bg-red-600",h=!1;if(i==="")a="Âº±ÊîªÊíÉ (1ÊÆµÁõÆ)",t.unlocks.strong?m="„ÉØ„Ç§„Éâ„Éª„Çπ„Ç¶„Ç£„Éº„Éó":(m="Êú™Ëß£Êîæ",h=!0);else if(i==="z")t.unlocks.weak2?a="Âº±ÊîªÊíÉ (2ÊÆµÁõÆ)":(a="Êú™Ëß£Êîæ",r=!0),t.unlocks.combo1?m="„Éî„Ç¢„Ç∑„É≥„Ç∞„Éª„É¨„Ç§":(m="Êú™Ëß£Êîæ",h=!0);else if(i==="zz")t.unlocks.weak3?a="Âº±ÊîªÊíÉ (3ÊÆµÁõÆ)":(a="Êú™Ëß£Êîæ",r=!0),t.unlocks.combo2?m="„Ç∞„É©„É≥„Éâ„Éª„ÇØ„É≠„Çπ":(m="Êú™Ëß£Êîæ",h=!0);else{o.innerHTML='<div class="text-gray-400 text-sm font-bold py-2 px-4 text-center">--- Á°¨Áõ¥‰∏≠ ---</div>';return}o.innerHTML=`
        <div class="flex flex-col md:flex-row gap-2 md:gap-4 w-full justify-center">
            <div class="flex items-center gap-2 text-white text-xs md:text-sm font-bold bg-gray-800 p-2 rounded border border-gray-600 ${r?"opacity-40":""}">
                <span class="${u} text-[10px] md:text-xs px-2 py-1 rounded w-10 text-center border border-blue-400">Âº±</span>
                <span>${a}</span>
            </div>
            <div class="flex items-center gap-2 text-white text-xs md:text-sm font-bold bg-gray-800 p-2 rounded border border-gray-600 ${h?"opacity-40":""}">
                <span class="${g} text-[10px] md:text-xs px-2 py-1 rounded w-10 text-center border border-red-400">Âº∑</span>
                <span>${m}</span>
            </div>
        </div>
    `}function ve(s,e,n){const o=n?vt:mt;o&&(o.innerText=s,o.className=`text-3xl md:text-5xl font-black text-transparent bg-clip-text bg-gradient-to-r ${e} drop-shadow-[0_4px_4px_rgba(0,0,0,1)] tracking-widest transition-all duration-300 opacity-100 transform scale-100 mt-1 md:mt-4 italic absolute top-10 whitespace-nowrap`,setTimeout(()=>{o.style.opacity="0",o.style.transform="scale(1.5)"},800))}function Tt(s,e,n,o){s.isAttacking=!0,e.duration=e.maxDuration,s.attackData=e;let i=t.playerStats.atk*n;const a=Math.random()<.0025,u=o?d.width:c.width,r=o?d.height:c.height,m=u/2;let g=o?G:particles,h=o?J:damageTexts,Q=o?H:enemies;if(a){t.stats.critCount++,i*=10,e.range=u,e.color="rgba(255, 0, 0, 0.8)",e.type==="normal"&&(e.type="wide"),ve("CRITICAL!","from-red-500 to-yellow-500",o);for(let l=0;l<30;l++)g.push(new _(m,w(s.row,r,f),(Math.random()-.5)*1e3,(Math.random()-.5)*1e3,.5,"#fbbf24",Math.random()*10+5))}const C=[];Q.forEach(l=>{let E=!1,L,M;if(s.facing===1?(L=m,M=m+e.range):(M=m,L=m-e.range),e.type==="wide"){let I,Z;s.facing===1?(Z=m,I=m-25):(I=m,Z=m+25),Math.abs(l.row-s.row)<=1&&(l.x+l.size>=L&&l.x-l.size<=M||l.x+l.size>=I&&l.x-l.size<=Z)&&(E=!0)}else e.type==="front-wide"?Math.abs(l.row-s.row)<=1&&l.x+l.size>=L&&l.x-l.size<=M&&(E=!0):l.row===s.row&&l.x+l.size>=L&&l.x-l.size<=M&&(E=!0);if(E){C.push(l),l.hp-=i,l.knockback=e.knockback,h.push(new It(l.x,l.y-l.size,i,a));for(let I=0;I<3;I++)g.push(new _(l.x,l.y,(Math.random()-.5)*300,(Math.random()-.5)*300,.2,"#fff",3))}}),o?C.forEach(l=>{l.hp=l.maxHp}):(C.forEach(l=>{if(l.hp<=0){t.sessionMoney+=l.value,t.stats.kills++;for(let E=0;E<8;E++)g.push(new _(l.x,l.y,(Math.random()-.5)*400,(Math.random()-.5)*400,.4,l.color,Math.random()*4+2));enemies.splice(enemies.indexOf(l),1)}}),K(),Ct())}let v,H=[],G=[],J=[];function oe(){d.width=d.parentElement.clientWidth,d.height=d.parentElement.clientHeight,f=Math.min(5,t.selectedWave),v=new be,H=[];for(let s=0;s<f;s++){let e=new ee(s,-1,1,s===Math.floor(f/2));e.speed=0,e.hp=9999,e.maxHp=9999,e.x=d.width/2+120,e.y=w(s,d.height,f)+(Math.random()*10-5),H.push(e);let n=new ee(s,1,1,!1);n.speed=0,n.hp=9999,n.maxHp=9999,n.x=d.width/2-120,n.y=w(s,d.height,f)+(Math.random()*10-5),H.push(n)}$([],!0)}function ke(){t.money+=t.sessionMoney;let s=0;if(t.sessionDrops.forEach(e=>{e.storyTitle&&!t.inventory.some(o=>o.id===e.id)&&s++;let n=null;for(let o=0;o<40;o++)if(!t.inventory.some(i=>i.cellId===`cell_${o}`)){n=`cell_${o}`;break}n&&(e.cellId=n,t.inventory.push(e))}),s>0){const e=s*2,n=s*20;t.playerStats.atk+=e,t.playerStats.maxHp+=n,setTimeout(()=>kt("ÊñáÊòé„ÅÆÂæ©ÂÖÉ„Éú„Éº„Éä„Çπ",`Âü∫Á§éÊîªÊíÉÂäõ+${e} / ÊúÄÂ§ßHP+${n}`,"bg-yellow-700"),500)}t.sessionMoney=0,t.sessionDrops=[]}function Bt(){t.sessionMoney=0,t.sessionDrops=[],t.playerStats.hp=t.playerStats.maxHp,f=Math.min(5,t.currentWave),player=new be,xe(t.currentWave),$([],!1)}function xe(s){te.classList.add("hidden"),enemies=[],particles=[],damageTexts=[],isWaveActive=!0,it.innerText=s,enemiesToSpawn=15+s*10,spawnTimer=0,currentWaveMult=1+(s-1)*.2,K()}function K(){at.innerText=t.money,lt.innerText=t.sessionMoney,rt.innerText=Math.max(0,Math.floor(t.playerStats.hp)),dt.innerText=t.playerStats.maxHp,ct.innerText=enemies.length+enemiesToSpawn;const s=Math.max(0,t.playerStats.hp/t.playerStats.maxHp)*100;le.style.width=s+"%",le.className=`h-full w-full transition-all duration-200 ${s<30?"bg-red-500":"bg-green-500"}`}function Ct(){enemiesToSpawn<=0&&enemies.length===0&&isWaveActive&&(isWaveActive=!1,t.currentWave>=t.maxWave&&(t.maxWave=t.currentWave+1),St())}function Mt(s){const e=c.width/2;enemies.forEach(n=>{Math.abs(n.x-e)<=40&&(t.playerStats.hp-=n.damage*s,x.fillStyle="rgba(255,0,0,0.1)",x.fillRect(0,0,c.width,c.height),t.playerStats.hp<=0&&(isWaveActive=!1,t.sessionMoney=Math.floor(t.sessionMoney/2),t.sessionDrops=[],t.money+=t.sessionMoney,t.sessionMoney=0,fe.classList.remove("hidden")))}),K()}function ce(s,e,n,o){s.strokeStyle="#334155",s.lineWidth=2;for(let u=0;u<o;u++){const r=w(u,n,o);s.beginPath(),s.moveTo(0,r),s.lineTo(e,r),s.stroke(),s.strokeStyle="#1e293b",s.beginPath(),s.moveTo(0,r-b/2),s.lineTo(e,r-b/2),s.stroke(),s.strokeStyle="#334155"}const i=w(o-1,n,o)+b/2;s.strokeStyle="#1e293b",s.beginPath(),s.moveTo(0,i),s.lineTo(e,i),s.stroke();const a=e/2;s.fillStyle="rgba(59, 130, 246, 0.1)",s.fillRect(a-40,0,80,n),s.strokeStyle="#3b82f6",s.beginPath(),s.moveTo(a-40,0),s.lineTo(a-40,n),s.stroke(),s.beginPath(),s.moveTo(a+40,0),s.lineTo(a+40,n),s.stroke()}function we(s){const e=Math.min((s-lastTime)/1e3,.1);if(lastTime=s,p.battle.classList.contains("active")){if(x.clearRect(0,0,c.width,c.height),ce(x,c.width,c.height,f),isWaveActive){if(enemiesToSpawn>0&&(spawnTimer-=e,spawnTimer<=0)){let n=t.currentWave===1?1:t.currentWave===2?2:3,o=Math.floor(Math.random()*n)+1;for(let i=0;i<o&&enemiesToSpawn>0;i++){const a=Math.floor(Math.random()*f),u=Math.random()>.5?1:-1,r=Math.random()<Math.min(.4,t.currentWave*.08);let m=new ee(a,u,currentWaveMult,r);m.x=u===1?-50:c.width+50,m.y=w(a,c.height,f)+(Math.random()*20-10),enemies.push(m),enemiesToSpawn--}spawnTimer=.4+Math.random()*.6,K()}player.update(e,()=>$([],!1)),enemies.forEach(n=>n.update(e,c.width)),Mt(e),enemies.forEach(n=>n.draw(x)),player.draw(x,c.width,c.height)}else player&&t.playerStats.hp>0&&player.draw(x,c.width,c.height);for(let n=particles.length-1;n>=0;n--){const o=particles[n];o.update(e),o.draw(x),o.life<=0&&particles.splice(n,1)}for(let n=damageTexts.length-1;n>=0;n--){const o=damageTexts[n];o.update(e),o.draw(x),o.life<=0&&damageTexts.splice(n,1)}}else if(p.base.classList.contains("active")&&document.getElementById("tab-status").classList.contains("block")){T.clearRect(0,0,d.width,d.height),ce(T,d.width,d.height,f),v&&(v.update(e,()=>$([],!0)),H.forEach(n=>{if(n.knockback>0)n.x-=n.side*n.knockback*e*10,n.knockback-=e*20;else{let o=d.width/2+n.side*-120;n.x+=(o-n.x)*e*5}n.draw(T)}),v.draw(T,d.width,d.height));for(let n=G.length-1;n>=0;n--){const o=G[n];o.update(e),o.draw(T),o.life<=0&&G.splice(n,1)}for(let n=J.length-1;n>=0;n--){const o=J[n];o.update(e),o.draw(T),o.life<=0&&J.splice(n,1)}}requestAnimationFrame(we)}function St(){ut.innerText=t.sessionMoney;let s=null;const e=Ee.find(n=>n.targetWave===t.currentWave&&!t.inventory.some(o=>o.id===n.id));if(e)s=Object.assign({},e);else{const n=Math.min(.8,.2+t.currentWave*.1);Math.random()<n&&(s=Object.assign({id:"junk_"+Date.now()},t.itemDB[Math.floor(Math.random()*t.itemDB.length)]))}s?(t.sessionDrops.push(s),gt.innerText=s.icon,ht.innerText=s.name,ft.innerText=s.storyTitle?"‚òÖ ÈÅ∫Áâ©„ÇíÂõûÂèé":"„Ç∏„É£„É≥„ÇØÂìÅ„ÇíÂõûÂèé",re.classList.remove("hidden")):re.classList.add("hidden"),te.classList.remove("hidden")}pt.addEventListener("click",()=>{ke(),t.currentWave++,t.selectedWave=t.currentWave,xe(t.currentWave)});yt.addEventListener("click",()=>{ke(),te.classList.add("hidden"),isWaveActive=!1,t.selectedWave=Math.max(1,t.maxWave-1),V("base")});bt.addEventListener("click",()=>{fe.classList.add("hidden"),isWaveActive=!1,t.selectedWave=Math.max(1,t.maxWave-1),V("base")});window.onload=()=>{U(),V("base"),lastTime=performance.now(),requestAnimationFrame(we)};window.addEventListener("resize",U);
