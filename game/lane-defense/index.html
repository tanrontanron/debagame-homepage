<!DOCTYPE html><html lang="ja" class="scroll-smooth"> <head><meta charset="UTF-8"><meta name="description" content="ã§ã°ãŒã‚ã®ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªã‚µã‚¤ãƒˆ"><meta name="viewport" content="width=device-width"><link rel="icon" type="image/svg+xml" href="/favicon.svg"><meta name="generator" content="Astro v5.16.3"><title>ãƒŸãƒ‹ãƒãƒ ç„¡åŒ - ãƒ¬ãƒ¼ãƒ³é˜²è¡›Ver</title><meta name="astro-view-transitions-enabled" content="true"><meta name="astro-view-transitions-fallback" content="animate"><script type="module" src="/debagame-homepage/_astro/ClientRouter.astro_astro_type_script_index_0_lang.QW52Ox2j.js"></script><!-- Google tag (gtag.js) --><script async src="https://www.googletagmanager.com/gtag/js?id=G-ZDEY5ZH97E"></script><script>
			window.dataLayer = window.dataLayer || [];
			function gtag(){dataLayer.push(arguments);}
			gtag('js', new Date());

			// Initial tracking is handled by astro:page-load to support View Transitions
			document.addEventListener('astro:page-load', () => {
				gtag('config', 'G-ZDEY5ZH97E', {
					page_path: window.location.pathname,
				});
			});
		</script><link rel="stylesheet" href="/debagame-homepage/_astro/index.B4RrG8ig.css">
<style>#app{display:flex;flex:1;flex-direction:column;width:100%;height:100%;min-height:0;overflow:hidden;background-color:#1a202c;color:#e2e8f0;font-family:sans-serif;-webkit-user-select:none;-moz-user-select:none;user-select:none}.screen{display:none;flex:1;flex-direction:column;width:100%;height:100%;min-height:0}.screen.active{display:flex}#game-canvas{display:block;width:100%;height:100%;background-color:#1e293b}#canvas-container{flex:1;position:relative;overflow:hidden;min-height:0;height:100%;touch-action:none}.overlay-ui{position:absolute;pointer-events:none}.pointer-events-auto{pointer-events:auto}.shelf-cell{width:60px;height:60px;border:1px dashed #4a5568;display:flex;align-items:center;justify-content:center;background-color:#2d3748;font-size:24px;cursor:pointer}.shelf-cell.drag-over{background-color:#4a5568}.item{cursor:grab;text-shadow:0 2px 4px rgba(0,0,0,.5)}.item:active{cursor:grabbing}.key-guide{display:inline-block;padding:2px 8px;background:#4a5568;border-radius:4px;font-weight:700;margin:0 4px;border-bottom:2px solid #2d3748}.vbtn{transition:all .1s}.vbtn.key-active{transform:scale(.9)}.vbtn-move.key-active{background-color:#4b5563!important;border-color:#9ca3af!important}.vbtn-atk-z.key-active{background-color:#3b82f6!important;border-color:#93c5fd!important}.vbtn-atk-x.key-active{background-color:#ef4444!important;border-color:#fca5a5!important}@keyframes skillPop{0%{opacity:0;transform:scale(.5)}10%{opacity:1;transform:scale(1.1)}20%{opacity:1;transform:scale(1)}80%{opacity:1;transform:scale(1)}to{opacity:0;transform:scale(1.5)}}.animate-skill-pop{animation:skillPop 1s ease-out forwards}.badge-dot{position:absolute;top:8px;right:12px;width:8px;height:8px;background:#ef4444;border-radius:50%;box-shadow:0 0 6px #ef4444cc;animation:badgePulse 1.5s ease-in-out infinite}.tab-btn .badge-dot:not(.hidden){position:relative;top:-1px;right:auto;display:inline-block;margin-left:4px}@keyframes badgePulse{0%,to{opacity:1;transform:scale(1)}50%{opacity:.6;transform:scale(1.3)}}
.astro-route-announcer{position:absolute;left:0;top:0;clip:rect(0 0 0 0);clip-path:inset(50%);overflow:hidden;white-space:nowrap;width:1px;height:1px}:root{--accent: 136, 58, 234;--accent-light: 224, 204, 250;--accent-dark: 49, 10, 101;--accent-gradient: linear-gradient( 45deg, rgb(var(--accent)), rgb(var(--accent-light)) 30%, white 60% )}
</style></head> <body class="bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100 min-h-screen flex flex-col font-sans"> <aside id="sidebar" class="fixed top-0 left-0 z-50 w-64 h-screen transition-transform -translate-x-full bg-white border-r border-gray-200 dark:bg-gray-800 dark:border-gray-700 shadow-lg" aria-label="Sidebar"> <div class="h-full px-3 py-4 overflow-y-auto bg-gray-50 dark:bg-gray-800 flex flex-col"> <div class="flex justify-between items-center mb-6 px-2"> <h2 class="text-xl font-bold text-gray-800 dark:text-white">Menu</h2> <button id="close-sidebar" class="text-gray-500 hover:bg-gray-100 dark:hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-200 dark:focus:ring-gray-700 rounded-lg text-sm p-2"> <svg class="w-6 h-6" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"> <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path> </svg> <span class="sr-only">Close menu</span> </button> </div> <ul class="space-y-2 font-medium"> <li> <a href="/debagame-homepage" class="flex items-center p-2 text-gray-900 rounded-lg dark:text-white hover:bg-gray-100 dark:hover:bg-gray-700 group transition-colors"> <svg class="w-5 h-5 text-gray-500 transition duration-75 dark:text-gray-400 group-hover:text-gray-900 dark:group-hover:text-white" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 22 21"> <path d="M16.975 11H10V4.025a1 1 0 0 0-1.066-.998 8.5 8.5 0 1 0 9.039 9.039.999.999 0 0 0-1-1.066h.002Z"></path> <path d="M12.5 0c-.157 0-.311.01-.565.027A1 1 0 0 0 11 1.02V10h8.975a1 1 0 0 0 1-.935c.013-.188.028-.374.028-.565A8.51 8.51 0 0 0 12.5 0Z"></path> </svg> <span class="ms-3">ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸</span> </a> </li> <li class="pt-4 mt-4 space-y-2 border-t border-gray-200 dark:border-gray-700"> <div class="px-2 text-xs font-semibold text-gray-500 uppercase dark:text-gray-400">Contents</div> </li> <li> <a href="/debagame-homepage/ai-timeline" class="flex items-center p-2 text-gray-900 rounded-lg dark:text-white hover:bg-gray-100 dark:hover:bg-gray-700 group transition-colors"> <span class="flex-shrink-0 w-5 h-5 text-gray-500 transition duration-75 dark:text-gray-400 group-hover:text-gray-900 dark:group-hover:text-white flex items-center justify-center"> â„¹ï¸ </span> <span class="ms-3">AIå¹´è¡¨</span> </a> </li><li> <a href="/debagame-homepage/game/chinchiro" class="flex items-center p-2 text-gray-900 rounded-lg dark:text-white hover:bg-gray-100 dark:hover:bg-gray-700 group transition-colors"> <span class="flex-shrink-0 w-5 h-5 text-gray-500 transition duration-75 dark:text-gray-400 group-hover:text-gray-900 dark:group-hover:text-white flex items-center justify-center"> ğŸ® </span> <span class="ms-3">ç„¡é™ãƒãƒ³ãƒãƒ­</span> </a> </li><li> <a href="/debagame-homepage/game/xylophone" class="flex items-center p-2 text-gray-900 rounded-lg dark:text-white hover:bg-gray-100 dark:hover:bg-gray-700 group transition-colors"> <span class="flex-shrink-0 w-5 h-5 text-gray-500 transition duration-75 dark:text-gray-400 group-hover:text-gray-900 dark:group-hover:text-white flex items-center justify-center"> ğŸ® </span> <span class="ms-3">æœ¨ç´ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿</span> </a> </li><li> <a href="/debagame-homepage/tool/size-check" class="flex items-center p-2 text-gray-900 rounded-lg dark:text-white hover:bg-gray-100 dark:hover:bg-gray-700 group transition-colors"> <span class="flex-shrink-0 w-5 h-5 text-gray-500 transition duration-75 dark:text-gray-400 group-hover:text-gray-900 dark:group-hover:text-white flex items-center justify-center"> ğŸ› ï¸ </span> <span class="ms-3">æœã®ã‚µã‚¤ã‚ºæ¤œè¨</span> </a> </li><li> <a href="/debagame-homepage/dashboard/health" class="flex items-center p-2 text-gray-900 rounded-lg dark:text-white hover:bg-gray-100 dark:hover:bg-gray-700 group transition-colors"> <span class="flex-shrink-0 w-5 h-5 text-gray-500 transition duration-75 dark:text-gray-400 group-hover:text-gray-900 dark:group-hover:text-white flex items-center justify-center"> ğŸ“Š </span> <span class="ms-3">å¥åº·è¨ºæ–­ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</span> </a> </li><li> <a href="/debagame-homepage/dashboard/bear" class="flex items-center p-2 text-gray-900 rounded-lg dark:text-white hover:bg-gray-100 dark:hover:bg-gray-700 group transition-colors"> <span class="flex-shrink-0 w-5 h-5 text-gray-500 transition duration-75 dark:text-gray-400 group-hover:text-gray-900 dark:group-hover:text-white flex items-center justify-center"> ğŸ“Š </span> <span class="ms-3">ç†Šè¢«å®³çŠ¶æ³ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</span> </a> </li><li> <a href="/debagame-homepage/info/world-map" class="flex items-center p-2 text-gray-900 rounded-lg dark:text-white hover:bg-gray-100 dark:hover:bg-gray-700 group transition-colors"> <span class="flex-shrink-0 w-5 h-5 text-gray-500 transition duration-75 dark:text-gray-400 group-hover:text-gray-900 dark:group-hover:text-white flex items-center justify-center"> â„¹ï¸ </span> <span class="ms-3">ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ä¸–ç•Œåœ°å›³</span> </a> </li><li> <a href="/debagame-homepage/info/number-plate" class="flex items-center p-2 text-gray-900 rounded-lg dark:text-white hover:bg-gray-100 dark:hover:bg-gray-700 group transition-colors"> <span class="flex-shrink-0 w-5 h-5 text-gray-500 transition duration-75 dark:text-gray-400 group-hover:text-gray-900 dark:group-hover:text-white flex items-center justify-center"> â„¹ï¸ </span> <span class="ms-3">ãƒŠãƒ³ãƒãƒ¼ãƒ—ãƒ¬ãƒ¼ãƒˆæƒ…å ±</span> </a> </li><li> <a href="/debagame-homepage/game/pc-break" class="flex items-center p-2 text-gray-900 rounded-lg dark:text-white hover:bg-gray-100 dark:hover:bg-gray-700 group transition-colors"> <span class="flex-shrink-0 w-5 h-5 text-gray-500 transition duration-75 dark:text-gray-400 group-hover:text-gray-900 dark:group-hover:text-white flex items-center justify-center"> ğŸ® </span> <span class="ms-3">PCç ´å£Šã‚²ãƒ¼ãƒ  2025</span> </a> </li><li> <a href="/debagame-homepage/game/lane-defense" class="flex items-center p-2 text-gray-900 rounded-lg dark:text-white hover:bg-gray-100 dark:hover:bg-gray-700 group transition-colors"> <span class="flex-shrink-0 w-5 h-5 text-gray-500 transition duration-75 dark:text-gray-400 group-hover:text-gray-900 dark:group-hover:text-white flex items-center justify-center"> ğŸ® </span> <span class="ms-3">ãƒŸãƒ‹ãƒãƒ ç„¡åŒ - ãƒ¬ãƒ¼ãƒ³é˜²è¡›Ver</span> </a> </li><li> <a href="/debagame-homepage/info/anime-timeline" class="flex items-center p-2 text-gray-900 rounded-lg dark:text-white hover:bg-gray-100 dark:hover:bg-gray-700 group transition-colors"> <span class="flex-shrink-0 w-5 h-5 text-gray-500 transition duration-75 dark:text-gray-400 group-hover:text-gray-900 dark:group-hover:text-white flex items-center justify-center"> â„¹ï¸ </span> <span class="ms-3">æ—¥æœ¬ã‚¢ãƒ‹ãƒ¡æ˜ ç”»å²å¹´è¡¨</span> </a> </li><li> <a href="/debagame-homepage/tool/length-visualizer" class="flex items-center p-2 text-gray-900 rounded-lg dark:text-white hover:bg-gray-100 dark:hover:bg-gray-700 group transition-colors"> <span class="flex-shrink-0 w-5 h-5 text-gray-500 transition duration-75 dark:text-gray-400 group-hover:text-gray-900 dark:group-hover:text-white flex items-center justify-center"> ğŸ› ï¸ </span> <span class="ms-3">é•·ã•å˜ä½ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ©ã‚¤ã‚¶ãƒ¼</span> </a> </li> </ul> <div class="mt-auto pt-4 border-t border-gray-200 dark:border-gray-700"> <a href="/debagame-homepage/admin/" class="flex items-center p-2 text-gray-900 rounded-lg dark:text-white hover:bg-gray-100 dark:hover:bg-gray-700 group transition-colors"> <span class="flex-shrink-0 w-5 h-5 text-gray-500 transition duration-75 dark:text-gray-400 group-hover:text-gray-900 dark:group-hover:text-white flex items-center justify-center">
â„¹ï¸
</span> <span class="ms-3">èŠ¸äººå¹´è¡¨ï¼ˆç®¡ç†ï¼‰</span> </a> </div> </div> </aside> <div id="sidebar-overlay" class="fixed inset-0 bg-gray-900/50 z-40 hidden backdrop-blur-sm transition-opacity" aria-hidden="true"></div> <script type="module">function s(){const t=document.getElementById("sidebar"),d=document.getElementById("sidebar-overlay"),o=document.getElementById("close-sidebar"),a=document.querySelectorAll(".sidebar-toggle");function i(){t?.classList.remove("-translate-x-full"),d?.classList.remove("hidden"),document.body.classList.add("overflow-hidden")}function e(){t?.classList.add("-translate-x-full"),d?.classList.add("hidden"),document.body.classList.remove("overflow-hidden")}o?.addEventListener("click",e),d?.addEventListener("click",e),a.forEach(n=>{n.addEventListener("click",c=>{c.stopPropagation(),t?.classList.contains("-translate-x-full")?i():e()})}),document.addEventListener("keydown",n=>{n.key==="Escape"&&e()})}s();document.addEventListener("astro:page-load",s);</script>  <header class="bg-white dark:bg-gray-800 shadow-sm sticky top-0 z-50"> <div class="container mx-auto px-4 h-16 flex items-center justify-between"> <div class="flex items-center gap-2"> <div class="w-8 h-8 bg-blue-600 rounded flex items-center justify-center text-white font-bold">
&lt;/&gt;
</div> <h1 class="font-bold text-xl tracking-tight"> <a href="/debagame-homepage" class="hover:text-blue-600 transition-colors">ã§ã°ãŒã‚ã®ã»ã‚ã±ã’</a> </h1> </div> <button class="sidebar-toggle p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700" aria-label="ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‹ã"> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-menu"><line x1="4" x2="20" y1="12" y2="12"></line><line x1="4" x2="20" y1="6" y2="6"></line><line x1="4" x2="20" y1="18" y2="18"></line></svg> </button> </div> </header> <main class="flex flex-col w-full h-[calc(100vh-64px)] overflow-hidden">  <div id="general-toast" class="fixed top-4 left-1/2 transform -translate-x-1/2 text-white px-6 py-3 rounded-full shadow-2xl z-[100] transition-all duration-500 opacity-0 -translate-y-20 pointer-events-none flex items-center gap-4 border-2"> <div id="toast-icon" class="text-3xl">â„¹ï¸</div> <div> <div id="toast-title" class="text-xs font-bold text-gray-200">é€šçŸ¥</div> <div id="toast-desc" class="font-bold text-lg leading-tight">ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</div> </div> </div> <div id="app"> <!-- ================= æ‹ ç‚¹ç”»é¢ ================= --> <div id="screen-base" class="screen active flex-col h-full bg-gray-900 w-full relative"> <!-- Header --> <div class="p-2 md:p-4 bg-gray-800 border-b border-gray-700 flex justify-between items-end flex-shrink-0"> <h1 id="screen-title" class="text-xl md:text-2xl font-bold text-blue-400">æ‹ ç‚¹</h1> <div class="text-yellow-400 font-bold text-xs md:text-sm mb-1 ml-auto text-right tracking-tight">æ‰€æŒé‡‘: <span id="base-money" class="text-sm md:text-base">0</span> G</div> </div> <!-- Scrollable Content Area --> <div class="flex-1 overflow-y-auto px-2 md:px-6 pb-24"> <!-- Sub-Tabs (Dynamically shown based on Active Main Menu) --> <div id="sub-tabs-container" class="flex justify-center border-b border-gray-700 mb-4 bg-gray-900 sticky top-0 z-20 pt-2 md:pt-4 overflow-x-auto whitespace-nowrap scrollbar-hide"> <!-- æ‹ ç‚¹ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®ã‚¿ãƒ– --> <div id="tabs-base" class="flex menu-tabs justify-center w-full"> <button class="tab-btn flex-1 text-center px-4 md:px-6 py-2 font-bold text-sm text-blue-400 border-b-2 border-blue-500 bg-blue-900/20 border-r border-gray-700" data-target="tab-base-home" onclick="switchTab('base-home')">æ‹ ç‚¹</button> <button class="tab-btn flex-1 text-center px-4 md:px-6 py-2 font-bold text-sm text-gray-500 hover:text-gray-300 border-b-2 border-transparent" data-target="tab-status" onclick="switchTab('status')">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹<span class="badge-dot hidden"></span></button> </div> <!-- å¼·åŒ–ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®ã‚¿ãƒ– --> <div id="tabs-upgrade" class="hidden menu-tabs justify-center w-full"> <button class="tab-btn flex-1 text-center px-4 md:px-6 py-2 font-bold text-sm text-gray-500 hover:text-gray-300 border-b-2 border-transparent border-r border-gray-700" data-target="tab-skill" onclick="switchTab('skill')">ã‚¹ã‚­ãƒ«è§£æ”¾<span class="badge-dot hidden"></span></button> <button class="tab-btn flex-1 text-center px-4 md:px-6 py-2 font-bold text-sm text-gray-500 hover:text-gray-300 border-b-2 border-transparent" data-target="tab-achievement" onclick="switchTab('achievement')">è¨“ç·´ãƒœãƒ¼ãƒŠã‚¹</button> </div> <!-- ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®ã‚¿ãƒ– --> <div id="tabs-archive" class="hidden menu-tabs justify-center w-full"> <button class="tab-btn flex-1 text-center px-4 md:px-6 py-2 font-bold text-sm text-gray-500 hover:text-gray-300 border-b-2 border-transparent border-r border-gray-700" data-target="tab-journal" onclick="switchTab('journal')">ä¸»äººå…¬ã®æ‰‹è¨˜</button> <button class="tab-btn flex-1 text-center px-4 md:px-6 py-2 font-bold text-sm text-gray-500 hover:text-gray-300 border-b-2 border-transparent border-r border-gray-700" data-target="tab-history" onclick="switchTab('history')">æ–‡æ˜ã®å¾©å…ƒ</button> <button class="tab-btn flex-1 text-center px-4 md:px-6 py-2 font-bold text-sm text-gray-500 hover:text-gray-300 border-b-2 border-transparent" data-target="tab-item" onclick="switchTab('item')">åé›†ç‰©</button> </div> <!-- è¨­å®šãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®ã‚¿ãƒ– --> <div id="tabs-settings" class="hidden menu-tabs justify-center w-full"> <button class="tab-btn flex-1 text-center px-4 md:px-6 py-2 font-bold text-sm text-gray-500 hover:text-gray-300 border-b-2 border-transparent border-r border-gray-700" data-target="tab-settings-main" onclick="switchTab('settings-main')">è¨­å®š</button> <button class="tab-btn flex-1 text-center px-4 md:px-6 py-2 font-bold text-sm text-gray-500 hover:text-gray-300 border-b-2 border-transparent" data-target="tab-help" onclick="switchTab('help')">ãƒ˜ãƒ«ãƒ—</button> </div> </div> <!-- TAB CONTENT: [Base] - Home --> <div id="tab-base-home" class="tab-content space-y-4"> <!-- è¨“ç·´å ´ --> <div class="bg-gray-800 p-2 rounded-lg shadow-lg border border-gray-700"> <h2 class="text-[10px] font-bold mb-1 text-blue-300 flex items-center gap-1"><span class="w-1 h-3 bg-blue-500 rounded-full"></span> è¨“ç·´å ´</h2> <div class="relative w-full aspect-video md:aspect-auto md:h-80 bg-gray-900 rounded border border-gray-700 overflow-hidden"> <canvas id="practice-canvas" class="block w-full h-full"></canvas> <div class="absolute bottom-8 left-0 w-full flex justify-center pointer-events-none z-0"> <div id="prac-guide-container"></div> </div> <div class="absolute top-2 left-0 w-full flex flex-col items-center pointer-events-none"> <div id="prac-hud-skill" class="text-2xl font-black text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-blue-600 drop-shadow-lg tracking-widest transition-all duration-300 opacity-0 mt-1 italic"></div> </div> <div class="absolute bottom-2 left-2 text-[8px] text-gray-500 pointer-events-none bg-gray-900/60 px-2 py-1 rounded">
ã‚¿ãƒƒãƒ—ï¼šå¼±/ç§»å‹•ã€€ãƒ•ãƒªãƒƒã‚¯ï¼šå¼·
</div> </div> </div> <!-- å‡ºæ’ƒãƒ‘ãƒãƒ« (æ¨ªä¸¦ã³åŒ–) --> <div class="bg-gray-800 p-4 rounded-lg shadow-lg border border-red-900/50 bg-gradient-to-b from-gray-800 to-red-950/20"> <h2 class="text-xs font-bold mb-3 text-center text-red-500 tracking-widest">å‡ºæ’ƒè¨­å®š</h2> <div class="grid grid-cols-2 gap-3 max-w-sm mx-auto h-16"> <div class="flex items-center justify-center space-x-2 bg-gray-900 px-2 rounded-lg border border-gray-700"> <button id="btn-wave-prev" class="w-8 h-8 bg-gray-700 hover:bg-gray-600 active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed rounded-lg text-white font-bold flex items-center justify-center text-lg shadow-inner border border-gray-600">-</button> <div class="text-[10px] font-black text-gray-400 text-center leading-tight">WAVE<br><span id="disp-selected-wave" class="text-yellow-400 text-xl italic">1</span></div> <button id="btn-wave-next" class="w-8 h-8 bg-gray-700 hover:bg-gray-600 active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed rounded-lg text-white font-bold flex items-center justify-center text-lg shadow-inner border border-gray-600">+</button> </div> <button id="btn-sortie" class="bg-red-600 hover:bg-red-500 active:scale-95 text-sm md:text-base px-2 rounded-xl font-black shadow-[0_4px_0_rgb(153,27,27)] hover:shadow-[0_2px_0_rgb(153,27,27)] translate-y-[-2px] hover:translate-y-0 transition-all w-full text-white border border-red-400 tracking-tighter">é˜²è¡›ã«å‡ºæ’ƒ</button> </div> </div> </div> <!-- TAB CONTENT: [Base] - Status --> <div id="tab-status" class="tab-content hidden space-y-6"> <div class="bg-gray-900 p-4 rounded-lg border border-gray-700 space-y-4"> <div class="text-center pb-4 border-b border-gray-800"> <div class="text-[10px] text-gray-500 tracking-widest font-bold">è­˜åˆ¥ã‚³ãƒ¼ãƒ‰ <span class="text-blue-500 ml-1 cursor-pointer" id="btn-edit-name">âœï¸ å¤‰æ›´</span></div> <div id="player-name-display" class="text-3xl font-black text-blue-400 mt-1 italic drop-shadow-[0_0_8px_rgba(59,130,246,0.3)] cursor-pointer" title="ã‚¿ãƒƒãƒ—ã—ã¦åå‰ã‚’å¤‰æ›´">DEFENDER-01</div> <div id="player-name-edit" class="hidden mt-2"> <input id="input-player-name" type="text" maxlength="16" class="bg-gray-800 border-2 border-blue-500 text-blue-400 text-2xl font-black italic text-center rounded-lg px-3 py-2 w-full max-w-xs outline-none focus:border-blue-300 transition-colors" placeholder="åå‰ã‚’å…¥åŠ›"> <div class="flex gap-2 justify-center mt-2"> <button id="btn-name-ok" class="bg-blue-600 hover:bg-blue-500 text-white px-6 py-1.5 rounded-lg font-bold text-sm transition">æ±ºå®š</button> <button id="btn-name-cancel" class="bg-gray-600 hover:bg-gray-500 text-white px-4 py-1.5 rounded-lg font-bold text-sm transition">æˆ»ã™</button> </div> </div> </div> <div class="grid grid-cols-1 gap-3"> <div class="bg-gray-800 p-4 rounded-xl border border-gray-700 relative overflow-hidden group"> <div class="flex justify-between items-end mb-2 relative z-10"> <span class="text-gray-400 font-bold">æ”»æ’ƒåŠ› (ATK)</span> <span id="stat-atk" class="text-3xl font-black text-white italic">10</span> </div> <button id="btn-upgrade-atk" class="w-full bg-blue-600 hover:bg-blue-500 active:scale-95 text-white px-4 py-3 rounded-lg font-black transition-all text-sm flex justify-between items-center relative z-10 border-b-4 border-blue-800 shadow-lg"> <span>å‡ºåŠ›ã‚’å¼·åŒ–</span><span><span id="cost-atk">50</span> G</span> </button> <div class="absolute -right-4 -bottom-4 text-blue-900/10 text-6xl font-black italic select-none">ATK</div> </div> <div class="bg-gray-800 p-4 rounded-xl border border-gray-700 relative overflow-hidden group"> <div class="flex justify-between items-end mb-2 relative z-10"> <span class="text-gray-400 font-bold">æ‹ ç‚¹è€ä¹…åŠ› (HP)</span> <span id="stat-hp" class="text-3xl font-black text-white italic">100</span> </div> <button id="btn-upgrade-hp" class="w-full bg-emerald-600 hover:bg-emerald-500 active:scale-95 text-white px-4 py-3 rounded-lg font-black transition-all text-sm flex justify-between items-center relative z-10 border-b-4 border-emerald-800 shadow-lg"> <span>è£…ç”²ã‚’å¼·åŒ–</span><span><span id="cost-hp">50</span> G</span> </button> <div class="absolute -right-4 -bottom-4 text-emerald-900/10 text-6xl font-black italic select-none">HP</div> </div> </div> <div class="bg-gray-800 p-4 rounded-xl border border-gray-700"> <h3 class="text-xs font-bold text-gray-500 mb-3 border-b border-gray-700 pb-1">ç´¯è¨ˆæˆ¦ç¸¾</h3> <div class="grid grid-cols-2 gap-4"> <div> <div class="text-[10px] text-gray-500 mb-0.5">æœ€é«˜åˆ°é”WAVE</div> <div id="stat-max-wave" class="text-xl font-black text-yellow-500 italic">1</div> </div> <div> <div class="text-[10px] text-gray-500 mb-0.5">ç´¯è¨ˆæ’ƒç ´æ•°</div> <div id="stat-kills" class="text-xl font-black text-gray-100 italic">0</div> </div> </div> </div> </div> </div> <!-- TAB CONTENT: [Upgrade] - Skill --> <div id="tab-skill" class="tab-content hidden space-y-6"> <div class="bg-gray-800 p-5 rounded-lg shadow-lg"> <h2 class="text-lg font-bold mb-4 border-b border-gray-600 pb-2 flex items-center gap-2"> <span class="w-2 h-6 bg-purple-500 rounded-full"></span>
ã‚¹ã‚­ãƒ«è§£æ”¾ãƒ„ãƒªãƒ¼
</h2> <div class="space-y-4"> <!-- Skill items (from previous script, adapted for layout) --> <div class="p-3 bg-gray-900 rounded-xl border border-gray-700 shadow-inner"> <div class="flex justify-between items-center"> <div><div class="font-bold text-gray-200">å¼±æ”»æ’ƒ 2æ®µç›®</div><div class="text-xs text-gray-500 mt-1">å¼±â†’å¼± (å°„ç¨‹ãƒ»å¨åŠ›å¾®å¢—)</div></div> <button id="btn-ul-weak2" class="bg-purple-600 hover:bg-purple-500 text-white px-4 py-2 rounded-lg font-black transition text-xs flex-shrink-0 border-b-4 border-purple-800">ç¿’å¾— (<span id="cost-ul-weak2">30</span> G)</button> <span id="txt-ul-weak2" class="hidden text-green-400 font-black px-2 py-1 text-sm italic">ç¿’å¾—æ¸ˆ</span> </div> </div> <div id="skill-weak3" class="hidden p-3 bg-gray-900 rounded-xl border border-gray-700 relative shadow-inner"> <div class="absolute -top-3 left-6 text-purple-900 font-black">â†“</div> <div class="flex justify-between items-center"> <div><div class="font-bold text-gray-200">å¼±æ”»æ’ƒ 3æ®µç›®</div><div class="text-xs text-gray-500 mt-1">å¼±â†’å¼±â†’å¼± (å¨åŠ›ç‰¹å¤§ / ãƒ•ã‚£ãƒ‹ãƒƒã‚·ãƒ¥)</div></div> <button id="btn-ul-weak3" class="bg-purple-600 hover:bg-purple-500 text-white px-4 py-2 rounded-lg font-black transition text-xs flex-shrink-0 border-b-4 border-purple-800">ç¿’å¾— (<span id="cost-ul-weak3">100</span> G)</button> <span id="txt-ul-weak3" class="hidden text-green-400 font-black px-2 py-1 text-sm italic">ç¿’å¾—æ¸ˆ</span> </div> </div> <div id="skill-strong" class="hidden p-3 bg-gray-900 rounded-xl border border-gray-700 relative shadow-inner"> <div class="absolute -top-3 left-6 text-purple-900 font-black">â†“</div> <div class="flex justify-between items-center mb-3"> <div><div class="font-bold text-red-400">ãƒ¯ã‚¤ãƒ‰ãƒ»ã‚¹ã‚¦ã‚£ãƒ¼ãƒ—</div><div class="text-xs text-gray-500 mt-1">å¼·æ”»æ’ƒ (å‰æ–¹3ãƒ¬ãƒ¼ãƒ³è–™ãæ‰•ã„)</div></div> <button id="btn-ul-strong" class="bg-purple-600 hover:bg-purple-500 text-white px-4 py-2 rounded-lg font-black transition text-xs flex-shrink-0 border-b-4 border-purple-800">è§£æ”¾ (<span id="cost-ul-strong">150</span> G)</button> </div> <div id="strong-upgrades" class="hidden flex space-x-2 mt-2 pt-2 border-t border-gray-800"> <button id="btn-up-s-dmg" class="flex-1 bg-blue-900/40 hover:bg-blue-800 border border-blue-700 text-blue-100 px-2 py-2 text-[10px] rounded font-bold transition">å¨åŠ› Lv.<span id="lvl-s-dmg">1</span><br><span id="cost-s-dmg">100</span>G</button> <button id="btn-up-s-rng" class="flex-1 bg-emerald-900/40 hover:bg-emerald-800 border border-emerald-700 text-emerald-100 px-2 py-2 text-[10px] rounded font-bold transition">å°„ç¨‹ Lv.<span id="lvl-s-rng">1</span><br><span id="cost-s-rng">100</span>G</button> </div> </div> <div id="skill-combo1" class="hidden p-3 bg-gray-900 rounded-xl border border-gray-700 relative shadow-inner"> <div class="absolute -top-3 left-6 text-purple-900 font-black">â†“</div> <div class="flex justify-between items-center mb-3"> <div><div class="font-bold text-cyan-400">ãƒ”ã‚¢ã‚·ãƒ³ã‚°ãƒ»ãƒ¬ã‚¤</div><div class="text-xs text-gray-500 mt-1">å¼±â†’å¼· (ç›´ç·šè²«é€šãƒ¬ãƒ¼ã‚¶ãƒ¼)</div></div> <button id="btn-ul-combo1" class="bg-purple-600 hover:bg-purple-500 text-white px-4 py-2 rounded-lg font-black transition text-xs flex-shrink-0 border-b-4 border-purple-800">è§£æ”¾ (<span id="cost-ul-combo1">250</span> G)</button> </div> <div id="combo1-upgrades" class="hidden flex space-x-2 mt-2 pt-2 border-t border-gray-800"> <button id="btn-up-c1-dmg" class="flex-1 bg-blue-900/40 hover:bg-blue-800 border border-blue-700 text-blue-100 px-2 py-2 text-[10px] rounded font-bold transition">å¨åŠ› Lv.<span id="lvl-c1-dmg">1</span><br><span id="cost-c1-dmg">150</span>G</button> <button id="btn-up-c1-rng" class="flex-1 bg-emerald-900/40 hover:bg-emerald-800 border border-emerald-700 text-emerald-100 px-2 py-2 text-[10px] rounded font-bold transition">å°„ç¨‹ Lv.<span id="lvl-c1-rng">1</span><br><span id="cost-c1-rng">150</span>G</button> </div> </div> <div id="skill-combo2" class="hidden p-3 bg-gray-900 rounded-xl border border-gray-700 relative shadow-inner"> <div class="absolute -top-3 left-6 text-purple-900 font-black">â†“</div> <div class="flex justify-between items-center mb-3"> <div><div class="font-bold text-yellow-400">ã‚°ãƒ©ãƒ³ãƒ‰ãƒ»ã‚¯ãƒ­ã‚¹</div><div class="text-xs text-gray-500 mt-1">å¼±â†’å¼±â†’å¼· (åºƒç¯„å›²åå­—æ®²æ»…)</div></div> <button id="btn-ul-combo2" class="bg-purple-600 hover:bg-purple-500 text-white px-4 py-2 rounded-lg font-black transition text-xs flex-shrink-0 border-b-4 border-purple-800">è§£æ”¾ (<span id="cost-ul-combo2">400</span> G)</button> </div> <div id="combo2-upgrades" class="hidden flex space-x-2 mt-2 pt-2 border-t border-gray-800"> <button id="btn-up-c2-dmg" class="flex-1 bg-blue-900/40 hover:bg-blue-800 border border-blue-700 text-blue-100 px-2 py-2 text-[10px] rounded font-bold transition">å¨åŠ› Lv.<span id="lvl-c2-dmg">1</span><br><span id="cost-c2-dmg">200</span>G</button> <button id="btn-up-c2-rng" class="flex-1 bg-emerald-900/40 hover:bg-emerald-800 border border-emerald-700 text-emerald-100 px-2 py-2 text-[10px] rounded font-bold transition">å°„ç¨‹ Lv.<span id="lvl-c2-rng">1</span><br><span id="cost-c2-rng">200</span>G</button> </div> </div> <div class="p-3 bg-gray-900 rounded-xl border border-gray-700 mt-6 bg-gradient-to-r from-gray-900 to-indigo-900/20"> <div class="flex justify-between items-center"> <div><div class="font-bold text-indigo-300 italic">è¿æ’ƒè£œåŠ©AI</div><div class="text-xs text-gray-500 mt-1">è¿æ’ƒè£œåŠ©ï¼šæœ€å¯„ã‚Šã®æ•µã‚’è‡ªå‹•æ•æ‰</div></div> <button id="btn-unlock-autoaim" class="bg-indigo-600 hover:bg-indigo-500 text-white px-4 py-2 rounded-lg font-black transition text-xs flex-shrink-0 border-b-4 border-indigo-800">è§£æ”¾ (<span id="cost-ul-autoaim">300</span> G)</button> <span id="txt-unlocked-autoaim" class="hidden text-indigo-400 font-black px-2 py-1 text-sm italic">å°å…¥æ¸ˆ</span> </div> </div> </div> </div> </div> <!-- TAB CONTENT: [Upgrade] - Achievement --> <div id="tab-achievement" class="tab-content hidden space-y-6"> <div class="bg-gray-800 p-5 rounded-lg shadow-lg"> <h2 class="text-lg font-bold mb-2 border-b border-gray-600 pb-2">ğŸ† è¨“ç·´ãƒœãƒ¼ãƒŠã‚¹</h2> <p class="mb-4 text-xs text-gray-500 italic">ç‰¹å®šã®æ¡ä»¶é”æˆã«ã‚ˆã‚Šã€åŸºç¤ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãŒæ’ä¹…çš„ã«åº•ä¸Šã’ã•ã‚Œã¾ã™ã€‚</p> <div id="achievement-list" class="grid grid-cols-1 gap-3"></div> </div> </div> <!-- TAB CONTENT: [Archive] - Journal --> <div id="tab-journal" class="tab-content hidden space-y-6"> <div class="bg-gray-800 p-5 rounded-lg shadow-lg border border-blue-900/30"> <h2 class="text-lg font-bold mb-4 border-b border-gray-700 pb-2 text-blue-300 italic">æ“ç¸¦è€…ã®æ‰‹è¨˜</h2> <p class="mb-4 text-xs text-gray-500">æ©Ÿä½“ã¨ã®ã‚·ãƒ³ã‚¯ãƒ­ç‡å‘ä¸Šã«ã‚ˆã‚Šã€æ–­ç‰‡çš„ãªè¨˜æ†¶ãŒå¾©å…ƒã•ã‚Œã¦ã„ã¾ã™ã€‚</p> <div id="journal-list" class="space-y-4"></div> </div> </div> <!-- TAB CONTENT: [Archive] - History --> <div id="tab-history" class="tab-content hidden space-y-6"> <div class="bg-gray-800 p-5 rounded-lg shadow-lg border border-yellow-900/30"> <h2 class="text-lg font-bold mb-4 border-b border-gray-700 pb-2 text-yellow-300 italic">æ–‡æ˜ã®è¨˜éŒ²</h2> <p class="mb-4 text-xs text-gray-500">æˆ¦åŸŸã«éºã•ã‚ŒãŸå¤ã„è¨˜éŒ²åª’ä½“ã‹ã‚‰ã€ä¸–ç•Œã®éå»ã‚’èª­ã¿å–ã‚Šã¾ã™ã€‚</p> <div id="archive-list" class="space-y-4"></div> </div> </div> <!-- TAB CONTENT: [Archive] - Item --> <div id="tab-item" class="tab-content hidden space-y-6"> <div class="bg-gray-800 p-5 rounded-lg shadow-lg"> <h2 class="text-lg font-bold mb-4 border-b border-gray-600 pb-2">åé›†å“ãƒ»éºç‰©</h2> <div id="item-description" class="h-24 bg-gray-900 p-3 rounded-xl border border-gray-700 text-xs text-gray-400 overflow-y-auto mb-4 border-l-4 border-blue-500 shadow-inner">
ã‚¢ã‚¤ãƒ†ãƒ ã‚’ã‚¿ãƒƒãƒ—ï¼ˆã¾ãŸã¯ãƒ›ãƒãƒ¼ï¼‰ã—ã¦è©³ç´°ã‚’è¡¨ç¤º
</div> <div class="overflow-y-auto max-h-80 pb-4"> <div id="shelf-container" class="grid grid-cols-4 sm:grid-cols-6 md:grid-cols-8 gap-2 content-start bg-gray-900 p-3 rounded-xl border border-gray-700 min-h-[160px] shadow-inner"></div> </div> </div> </div> <!-- TAB CONTENT: [Settings] - Main --> <div id="tab-settings-main" class="tab-content hidden space-y-6"> <div class="bg-gray-800 p-5 rounded-lg shadow-lg border border-gray-700"> <h2 class="text-lg font-bold mb-4 border-b border-gray-600 pb-2 flex items-center gap-2"> <span class="w-2 h-6 bg-gray-500 rounded-full"></span>
ã‚²ãƒ¼ãƒ è¨­å®š
</h2> <div class="space-y-4"> <div class="p-4 bg-red-950/30 rounded-xl border border-red-800/50"> <h3 class="font-bold text-red-400 mb-2">âš ï¸ ãƒ‡ãƒ¼ã‚¿ãƒªã‚»ãƒƒãƒˆ</h3> <p class="text-xs text-gray-400 mb-3">ã™ã¹ã¦ã®é€²è¡ŒçŠ¶æ³ã‚’ãƒªã‚»ãƒƒãƒˆã—ã€æœ€åˆã‹ã‚‰ã‚„ã‚Šç›´ã—ã¾ã™ã€‚<br>ã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚</p> <button id="btn-new-game" class="w-full bg-red-700 hover:bg-red-600 active:scale-95 text-white px-4 py-3 rounded-lg font-black transition-all text-sm border-b-4 border-red-900 shadow-lg">ğŸ”„ ãƒ‹ãƒ¥ãƒ¼ã‚²ãƒ¼ãƒ </button> </div> </div> </div> </div> <!-- TAB CONTENT: [Settings] - Help --> <div id="tab-help" class="tab-content hidden space-y-6"> <div class="bg-gray-800 p-5 rounded-lg shadow-lg border border-gray-700"> <h2 class="text-lg font-bold mb-4 border-b border-gray-600 pb-2">ã‚²ãƒ¼ãƒ ä»•æ§˜ãƒ»ãƒ˜ãƒ«ãƒ—</h2> <div class="space-y-4 text-gray-300"> <section> <h3 class="text-sm font-bold text-blue-400 mb-2">â—† åŸºæœ¬æ“ä½œã¨ã‚³ãƒ³ãƒœ</h3> <ul class="list-disc ml-5 space-y-1 text-xs"> <li><strong>ç§»å‹•/å‘ã:</strong> W/S/A/D ã¾ãŸã¯åå­—ãƒœã‚¿ãƒ³</li> <li><strong>æ”»æ’ƒ:</strong> Z/J (å¼±)ã€X/K (å¼·) ã¾ãŸã¯ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³</li> <li>ç”»é¢ä¸‹éƒ¨ã«ã‚³ãƒ³ãƒœã‚¬ã‚¤ãƒ‰ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</li> </ul> </section> <section> <h3 class="text-sm font-bold text-yellow-400 mb-2">â—† ã‚¦ã‚§ãƒ¼ãƒ–é€²è¡Œ</h3> <ul class="list-disc ml-5 space-y-1 text-xs"> <li>WAVEãŒé€²ã‚€ã¨ãƒ¬ãƒ¼ãƒ³æ•°ãŒæœ€å¤§5ã¾ã§å¢—åŠ </li> <li>æ•µã®æ•°ãƒ»å¼·ã•ãƒ»é€Ÿåº¦ãŒWAVEã«å¿œã˜ã¦ä¸Šæ˜‡</li> </ul> </section> <section> <h3 class="text-sm font-bold text-purple-400 mb-2">â—† ã‚¹ã‚­ãƒ«ã¨æˆé•·</h3> <ul class="list-disc ml-5 space-y-1 text-xs"> <li>ã‚¹ã‚­ãƒ«ã¯ãƒ„ãƒªãƒ¼å½¢å¼ã§è§£æ”¾</li> <li>å¼·æ”»æ’ƒé–¢é€£ã®æŠ€ã¯è§£æ”¾å¾Œã«å¨åŠ›ã¨å°„ç¨‹ã‚’å¼·åŒ–å¯èƒ½</li> <li>è¿æ’ƒã‚µãƒãƒ¼ãƒˆAIã§è‡ªå‹•ç…§æº–ãŒå¯èƒ½</li> </ul> </section> <section> <h3 class="text-sm font-bold text-emerald-400 mb-2">â—† ã‚·ãƒŠãƒªã‚ªã¨éºç‰©</h3> <ul class="list-disc ml-5 space-y-1 text-xs"> <li>å¼·åŒ–ã‚’è¡Œã†ã¨æ‰‹è¨˜ãŒè§£æ”¾ã•ã‚Œã¾ã™</li> <li>ç‰¹å®šWAVEã‚¯ãƒªã‚¢ã§éºç‰©ã‚’å…¥æ‰‹â†’ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒœãƒ¼ãƒŠã‚¹</li> </ul> </section> </div> </div> </div> </div> <!-- Footer Navigation Menu (Fixed Bottom) --> <nav id="footer-menu" class="fixed bottom-0 left-0 w-full bg-gray-800/95 backdrop-blur-md border-t border-gray-700 flex justify-around items-center h-20 px-2 pb-safe z-50 shadow-[0_-10px_30px_rgba(0,0,0,0.5)]"> <button class="footer-btn relative flex flex-col items-center justify-center w-1/4 h-full text-blue-400 active-menu border-r border-gray-700" onclick="switchMenu('base')"> <div class="text-2xl mb-1">ğŸ </div> <span class="text-[10px] font-black tracking-tighter">æ‹ ç‚¹</span> <span id="badge-menu-base" class="badge-dot hidden"></span> </button> <button class="footer-btn relative flex flex-col items-center justify-center w-1/4 h-full text-gray-500 border-r border-gray-700" onclick="switchMenu('upgrade')"> <div class="text-2xl mb-1">âš¡</div> <span class="text-[10px] font-black tracking-tighter">å¼·åŒ–</span> <span id="badge-menu-upgrade" class="badge-dot hidden"></span> </button> <button class="footer-btn relative flex flex-col items-center justify-center w-1/4 h-full text-gray-500 border-r border-gray-700" onclick="switchMenu('archive')"> <div class="text-2xl mb-1">ğŸ“‚</div> <span class="text-[10px] font-black tracking-tighter">è¨˜éŒ²</span> </button> <button class="footer-btn relative flex flex-col items-center justify-center w-1/4 h-full text-gray-500" onclick="switchMenu('settings')"> <div class="text-2xl mb-1">âš™ï¸</div> <span class="text-[10px] font-black tracking-tighter">è¨­å®š</span> </button> </nav> </div> <!-- ================= æˆ¦é—˜ç”»é¢ ================= --> <div id="screen-battle" class="screen"> <div id="canvas-container"> <canvas id="game-canvas"></canvas> <div class="overlay-ui top-0 left-0 w-full p-4 flex justify-between items-start pointer-events-none"> <div> <div class="text-xl font-bold text-white mb-1 shadow-black drop-shadow-md">Wave: <span id="hud-wave">1</span></div> <div class="w-48 h-6 bg-gray-800 border-2 border-gray-600 rounded overflow-hidden"> <div id="hud-hp-bar" class="h-full bg-green-500 w-full transition-all duration-200"></div> </div> <div class="text-sm font-bold shadow-black drop-shadow-md mt-1 text-white">æ‹ ç‚¹HP: <span id="hud-hp-val">100</span> / <span id="hud-max-hp-val">100</span></div> </div> <!-- â˜…è³‡é‡‘è¡¨ç¤º --> <div class="text-right flex flex-col items-end pointer-events-none"> <div class="text-xs font-bold text-gray-300 drop-shadow-md mb-1">ç¢ºå®šæ¸ˆ: <span id="hud-base-money">0</span> G</div> <div class="text-2xl font-bold text-yellow-400 drop-shadow-md border-b-2 border-yellow-600/50 pb-1 mb-1">+ <span id="hud-session-money">0</span> G</div> <div class="text-sm font-bold drop-shadow-md text-gray-200">æ®‹æ•µ: <span id="hud-enemies">0</span></div> </div> </div> <!-- ã‚¹ã‚­ãƒ«ç™ºå‹•åè¡¨ç¤º (ç”»é¢ä¸Šéƒ¨ä¸­å¤®) --> <div class="overlay-ui top-20 left-0 w-full flex justify-center pointer-events-none z-10 flex-col items-center"> <div id="hud-skill-name" class="text-5xl font-black text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-blue-600 drop-shadow-[0_4px_4px_rgba(0,0,0,1)] tracking-widest transition-all duration-300 opacity-0 transform scale-50 mt-4 italic"></div> </div> <!-- ãƒãƒˆãƒ«ç”¨ å‹•çš„ã‚³ãƒ³ãƒœã‚¬ã‚¤ãƒ‰ --> <div class="overlay-ui bottom-8 left-0 w-full flex justify-center pointer-events-none z-0 transition-opacity duration-200"> <div id="battle-guide-container"> <!-- JSã§å‹•çš„ã«ç”Ÿæˆ --> </div> </div> <div id="wave-modal" class="overlay-ui top-0 left-0 w-full h-full flex items-center justify-center bg-black/80 hidden pointer-events-auto z-50"> <div class="bg-gray-800 p-8 rounded-lg text-center shadow-2xl border border-gray-600 max-w-md w-11/12"> <h2 class="text-3xl font-bold text-white mb-2">Wave ã‚¯ãƒªã‚¢ï¼</h2> <p class="text-gray-300 mb-6">WAVEç²å¾—è³‡é‡‘: <span id="modal-money" class="text-yellow-400 font-bold text-2xl">0</span> G</p> <div id="drop-notification" class="mb-6 hidden"> <div class="p-4 bg-gray-900 rounded border border-gray-700 relative overflow-hidden"> <!-- èƒŒæ™¯ã‚¨ãƒ•ã‚§ã‚¯ãƒˆé¢¨ --> <div class="absolute inset-0 bg-gradient-to-t from-purple-900/30 to-transparent pointer-events-none"></div> <p id="drop-title" class="text-sm text-purple-400 font-bold mb-2 relative z-10">ã‚¸ãƒ£ãƒ³ã‚¯å“ã‚’å›å</p> <div id="drop-item-icon" class="text-5xl mb-2 relative z-10 drop-shadow-lg">ğŸ’</div> <p id="drop-item-name" class="font-bold text-white relative z-10">åç§°</p> </div> </div> <p class="text-sm text-gray-400 mb-6 border-t border-gray-600 pt-4">é€²ã‚ã°æ•µã¯å¼·ããªã‚‹ã€‚å¸°é‚„ã™ã‚Œã°å®‰å…¨ã ã€‚<br><span class="text-yellow-300 font-bold">â€»ã“ã“ã¾ã§ã®å ±é…¬ã¯ç¢ºå®šã•ã‚Œã¾ã—ãŸ</span></p> <div class="flex space-x-4 justify-center"> <button id="btn-return" class="bg-gray-600 hover:bg-gray-500 text-white px-6 py-3 rounded font-bold transition flex-1 border border-gray-500">å¸°é‚„ã™ã‚‹</button> <button id="btn-next-wave" class="bg-red-600 hover:bg-red-500 text-white px-6 py-3 rounded font-bold transition shadow-lg shadow-red-900/50 flex-1 border border-red-500">æ¬¡ã¸é€²ã‚€</button> </div> </div> </div> <div id="death-modal" class="overlay-ui top-0 left-0 w-full h-full flex items-center justify-center bg-red-900/90 hidden pointer-events-auto z-50 backdrop-blur-sm"> <div class="bg-gray-900 p-8 rounded-lg text-center border border-red-500 w-11/12 max-w-md shadow-2xl"> <h2 class="text-4xl font-black text-red-500 mb-4 tracking-widest drop-shadow-[0_0_10px_rgba(255,0,0,0.8)]">æ‹ ç‚¹å£Šæ»…</h2> <p class="text-xl text-gray-200 mb-2 font-bold">æ‹ ç‚¹ãŒç ´å£Šã•ã‚ŒãŸ...</p> <div class="bg-red-950/50 p-4 rounded my-6 border border-red-800"> <p class="text-red-300 font-bold">ç›´å‰ã®WAVEç²å¾—è³‡é‡‘ åŠæ¸›</p> <p class="text-gray-400 text-sm mt-1">æœªç¢ºå®šã®ãƒ‰ãƒ­ãƒƒãƒ—å“ã¯ã™ã¹ã¦ãƒ­ã‚¹ãƒˆ</p> </div> <button id="btn-death-return" class="bg-gray-700 hover:bg-gray-600 text-white px-8 py-4 rounded font-bold transition w-full text-lg shadow-lg">æ‹ ç‚¹ã«æˆ»ã‚‹</button> </div> </div> </div> </div> <!-- ================= ãƒ˜ãƒ«ãƒ—ãƒ¢ãƒ¼ãƒ€ãƒ« ================= --> <div id="help-modal" class="overlay-ui top-0 left-0 w-full h-full flex items-center justify-center bg-black/80 hidden pointer-events-auto z-50"> <div class="bg-gray-800 p-8 rounded-lg shadow-2xl border border-gray-600 max-w-2xl w-11/12 max-h-[90vh] overflow-y-auto relative text-gray-300"> <button onclick="document.getElementById('help-modal').classList.add('hidden')" class="absolute top-4 right-4 bg-gray-600 hover:bg-gray-500 text-white w-8 h-8 rounded-full font-bold">Ã—</button> <h2 class="text-2xl font-bold text-white mb-6 border-b border-gray-600 pb-2">ã‚²ãƒ¼ãƒ ä»•æ§˜ãƒ»ãƒ˜ãƒ«ãƒ—</h2> <div class="space-y-6"> <section> <h3 class="text-lg font-bold text-blue-400 mb-2">â—† åŸºæœ¬æ“ä½œã¨ã‚³ãƒ³ãƒœ</h3> <ul class="list-disc ml-5 space-y-1 text-sm"> <li><strong>ç§»å‹•/å‘ã:</strong> W/S/A/D ã¾ãŸã¯ å·¦ä¸‹ã®åå­—ãƒœã‚¿ãƒ³</li> <li><strong>æ”»æ’ƒ:</strong> Z/J (å¼±)ã€X/K (å¼·) ã¾ãŸã¯ å³ä¸‹ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³</li> <li>æˆ¦é—˜ç”»é¢ä¸‹éƒ¨ã®ä¸­å¤®ã«ã€ç¾åœ¨å…¥åŠ›ä¸­ã®ãƒ«ãƒ¼ãƒˆã‹ã‚‰æ´¾ç”Ÿã§ãã‚‹æŠ€ã®ã‚¬ã‚¤ãƒ‰ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</li> <li>æ”»æ’ƒã®ç¡¬ç›´ä¸­ã¯ã€æ©Ÿä½“ã®è¶³å…ƒã«ã‚²ãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œã€ã‚²ãƒ¼ã‚¸ãŒæ¶ˆãˆã‚‹ã¾ã§æ¬¡ã®è¡Œå‹•ãŒã§ãã¾ã›ã‚“ã€‚</li> </ul> </section> <section> <h3 class="text-lg font-bold text-yellow-400 mb-2">â—† ã‚¦ã‚§ãƒ¼ãƒ–é€²è¡Œãƒ­ã‚¸ãƒƒã‚¯</h3> <ul class="list-disc ml-5 space-y-1 text-sm"> <li><strong>æˆ¦å ´ã®æ‹¡å¤§:</strong> WAVEã®é€²è¡Œã«åˆã‚ã›ã¦ã€æ•µãŒä¾µæ”»ã—ã¦ãã‚‹ãƒ¬ãƒ¼ãƒ³æ•°ãŒ<strong class="text-white">æœ€å¤§5ãƒ¬ãƒ¼ãƒ³</strong>ã¾ã§æ®µéšçš„ã«å¢—ãˆã¦ã„ãã¾ã™ã€‚</li> <li><strong>æ•µã®å‡ºç¾æ•°:</strong> <code class="bg-gray-900 px-1 rounded">15ä½“ + (ã‚¦ã‚§ãƒ¼ãƒ–æ•° Ã— 10)ä½“</code> ãŒå‡ºç¾ã—ã¾ã™ã€‚</li> <li><strong>ã‚¦ã‚§ãƒ¼ãƒ–å€ç‡:</strong> <code class="bg-gray-900 px-1 rounded">1.0 + ((ã‚¦ã‚§ãƒ¼ãƒ–æ•° - 1) Ã— 0.2)</code> ã®å€ç‡ãŒã‹ã‹ã‚Šã¾ã™ã€‚(Wave2ã§1.2å€ã€Wave5ã§1.8å€)</li> <li><strong>æ•µã®å¼·ã•:</strong> ãƒ™ãƒ¼ã‚¹HP(é€šå¸¸20/ã‚¿ãƒ•60)ã¨æ”»æ’ƒåŠ›(é€šå¸¸10/ã‚¿ãƒ•20)ã«ã€ä¸Šè¨˜ã®<strong>ã‚¦ã‚§ãƒ¼ãƒ–å€ç‡</strong>ãŒä¹—ç®—ã•ã‚Œã¾ã™ã€‚ã¾ãŸã€ç§»å‹•é€Ÿåº¦ã‚‚å°‘ã—ãšã¤ä¸Šæ˜‡ã—ã¾ã™ã€‚</li> <li><strong>ç²å¾—è³‡é‡‘:</strong> ãƒ™ãƒ¼ã‚¹é¡(é€šå¸¸1.5G/ã‚¿ãƒ•7.5G)ã«ã€<code class="bg-gray-900 px-1 rounded">âˆš(ã‚¦ã‚§ãƒ¼ãƒ–å€ç‡)</code> ã‚’ã‹ã‘ãŸé¡ãŒãƒ‰ãƒ­ãƒƒãƒ—ã—ã¾ã™ã€‚</li> <li><strong>ã‚¹ãƒãƒ¼ãƒ³é–“éš”:</strong> åºç›¤ã¯1ä½“ãšã¤ã‚†ã£ãã‚Šæ¹§ãã¾ã™ãŒã€WaveãŒé€²ã‚€ã«ã¤ã‚Œã¦ä¸€åº¦ã«2ã€œ3ä½“ã¾ã¨ã‚ã¦é€£ç¶šã§æŠ¼ã—å¯„ã›ã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚</li> </ul> </section> <section> <h3 class="text-lg font-bold text-purple-400 mb-2">â—† ã‚¹ã‚­ãƒ«ã¨æˆé•·</h3> <ul class="list-disc ml-5 space-y-1 text-sm"> <li>ã‚¹ã‚­ãƒ«ã¯ãƒ„ãƒªãƒ¼å½¢å¼ã§è§£æ”¾ã•ã‚Œã¾ã™ã€‚ã¾ãšã¯å¼±æ”»æ’ƒã®ã‚³ãƒ³ãƒœã‚’ä¼¸ã°ã—ã€å¼·æ”»æ’ƒã‚’ã‚¢ãƒ³ãƒ­ãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚</li> <li>å¼·æ”»æ’ƒãŒçµ¡ã‚€æŠ€ï¼ˆãƒ¯ã‚¤ãƒ‰ãƒ»ã‚¹ã‚¦ã‚£ãƒ¼ãƒ—ã€ãƒ”ã‚¢ã‚·ãƒ³ã‚°ãƒ»ãƒ¬ã‚¤ã€ã‚°ãƒ©ãƒ³ãƒ‰ãƒ»ã‚¯ãƒ­ã‚¹ï¼‰ã¯ã€è§£æ”¾å¾Œã«è³‡é‡‘ã§å¨åŠ›ã¨å°„ç¨‹ã‚’å¼·åŒ–ã§ãã¾ã™ã€‚</li> <li><strong>è¿æ’ƒã‚µãƒãƒ¼ãƒˆAI</strong>ã‚’è§£æ”¾ã™ã‚‹ã¨ã€æ‹ ç‚¹ã«å¼µã‚Šä»˜ã‹ã‚ŒãŸéš›ã®ãƒ‘ãƒ‹ãƒƒã‚¯æ™‚ã§ã‚‚ã€åŒãƒ¬ãƒ¼ãƒ³ã§æ”»æ’ƒãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã ã‘ã§è‡ªå‹•çš„ã«æ•µå´ã‚’å‘ã„ã¦è¿æ’ƒã—ã¦ãã‚Œã¾ã™ã€‚</li> <li>æ”»æ’ƒãƒ’ãƒƒãƒˆæ™‚ã€ã”ãç¨€ã«å…¨ã¦ã‚’è–™ãæ‰•ã†ã€Œã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ã€ãŒç™ºç”Ÿã—ã¾ã™ã€‚</li> </ul> </section> <section> <h3 class="text-lg font-bold text-emerald-400 mb-2">â—† ã‚·ãƒŠãƒªã‚ªã¨éºç‰©åé›†</h3> <ul class="list-disc ml-5 space-y-1 text-sm"> <li><strong>æ‰‹è¨˜:</strong> æ‹ ç‚¹ã§ã®å¼·åŒ–ã‚„ã‚¹ã‚­ãƒ«è§£æ”¾ã‚’ä¸€å®šå›æ•°è¡Œã†ã¨ã€éå»ã®è¨˜æ†¶ãŒç´è§£ã‹ã‚Œã¾ã™ã€‚</li> <li><strong>ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–éºç‰©:</strong> Wave 5, 10, 15 ãªã©ã®ç¯€ç›®ã‚’ã‚¯ãƒªã‚¢ã™ã‚‹ã¨ã€ä¸–ç•Œã®è¬ãŒè¨˜ã•ã‚ŒãŸç‰¹æ®Šãªéºç‰©ã‚’å›åã§ãã¾ã™ã€‚</li> <li>ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–éºç‰©ã‚’æ‹ ç‚¹ã«æŒã¡å¸°ã‚‹ã”ã¨ã«ã€<strong>æ’ä¹…çš„ãªã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒœãƒ¼ãƒŠã‚¹ï¼ˆæ”»æ’ƒåŠ›ãƒ»HPï¼‰</strong>ãŒä»˜ä¸ã•ã‚Œã¾ã™ã€‚</li> </ul> </section> <div class="mt-8 text-center border-t border-gray-600 pt-6"> <button onclick="document.getElementById('help-modal').classList.add('hidden')" class="bg-blue-600 hover:bg-blue-500 text-white px-8 py-3 rounded-full font-bold transition shadow-lg w-full max-w-xs">é–‰ã˜ã‚‹</button> </div> </div> </div> </div> </div> <!-- ğŸ’¾ ã‚»ãƒ¼ãƒ–æ©Ÿèƒ½ã®ãŸã‚ã«CDNç‰ˆsupabase-jsã‚’èª­ã¿è¾¼ã‚€ã€‚ãƒ“ãƒ«ãƒ‰ãƒ„ãƒ¼ãƒ«ã®åˆ¶ç´„ï¼ŸçŸ¥ã‚‰ã‚“ãªï¼ --> <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script> <script>
window.onerror = function(msg, url, line, col, error) {
    const errObj = document.createElement('div');
    errObj.style.position = 'fixed'; errObj.style.top = '0'; errObj.style.left = '0'; errObj.style.zIndex = '9999';
    errObj.style.color = 'red'; errObj.style.background = 'black'; errObj.style.padding = '10px'; errObj.style.fontSize = '12px';
    errObj.innerText = `[JS_ERROR] ${msg} L${line}:C${col}\n${error?error.stack:''}`;
    document.body.appendChild(errObj);
    return false;
};

document.addEventListener('astro:page-load', async () => {

/**
 * ç”»åƒãƒªã‚½ãƒ¼ã‚¹ã®ãƒ­ãƒ¼ãƒ‰
 */
const imgPlayerSprite = new Image();
imgPlayerSprite.src = '/debagame-homepage/assets/images/characters/player_sprite_packed.png';
imgPlayerSprite.onload = () => { window.playerSpriteImg = imgPlayerSprite; };

/**
 * çŠ¶æ…‹ç®¡ç†
 */
const GameState = {
    money: 0,
    playerName: 'DEFENDER-01',
    playerStats: { atk: 10, maxHp: 100, hp: 100 },
    costs: { 
        atk: 50, hp: 50, 
        unlockWeak2: 30, unlockWeak3: 100, unlockStrong: 150, unlockCombo1: 250, unlockCombo2: 400, unlockAutoAim: 300,
        upSDmg: 100, upSRng: 100,
        upC1Dmg: 150, upC1Rng: 150,
        upC2Dmg: 200, upC2Rng: 200 
    },
    unlocks: { weak2: false, weak3: false, strong: false, combo1: false, combo2: false, autoAim: false },
    comboLevels: { sDmg: 1, sRng: 1, c1Dmg: 1, c1Rng: 1, c2Dmg: 1, c2Rng: 1 },
    stats: { zCount: 0, xCount: 0, kills: 0, critCount: 0, upgradeCount: 0 }, 
    inventory: [],
    currentWave: 1, maxWave: 1, selectedWave: 1, sessionMoney: 0, sessionDrops: [],
    
    // ä¸€èˆ¬ãƒ‰ãƒ­ãƒƒãƒ—ç”¨ã‚¸ãƒ£ãƒ³ã‚¯å“
    itemDB: [
        { icon: 'ğŸ”©', name: 'æ›²ãŒã£ãŸãƒœãƒ«ãƒˆ', desc: 'è¦æ ¼å¤–ã®éƒ¨å“ã€‚' },
        { icon: 'ğŸ”‹', name: 'æ¯æ¸‡ã—ãŸé›»æ± ', desc: 'å¾®ã‹ã«ç†±ã‚’å¸¯ã³ã¦ã„ã‚‹ã€‚' },
        { icon: 'ğŸ’¾', name: 'ç ´æã—ãŸè¨˜æ†¶åª’ä½“', desc: 'ãƒ‡ãƒ¼ã‚¿ã¯å®Œå…¨ã«é£›ã‚“ã§ã„ã‚‹ã€‚' },
        { icon: 'ğŸ§¸', name: 'ç„¦ã’ãŸã¬ã„ãã‚‹ã¿', desc: 'èª°ã‹ã®å®ç‰©ã ã£ãŸã€‚' }
    ],
    storyData: { journalIndex: 0 }
};

// ========================================
// ğŸ’¾ ã‚»ãƒ¼ãƒ–/ãƒ­ãƒ¼ãƒ‰æ©Ÿèƒ½
// ã€Œä¿ºã®ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ã¯å®‡å®™ã®æœã¦ã¾ã§ã‚‚è¿½ã„ã‹ã‘ã¦ãã‚‹ãœã€
// ========================================
const SUPABASE_URL = 'https://wxblqinfkmodvnsnytwn.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind4YmxxaW5ma21vZHZuc255dHduIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU4OTU5OTksImV4cCI6MjA4MTQ3MTk5OX0.5F8NBBn__jSLvih_lykP3XPrcYlGLnxiFwphQOrOcAo';
let _supabaseClient = null;

function getSupabase() {
    if (!_supabaseClient && window.supabase) {
        _supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    }
    return _supabaseClient;
}

function getSaveId() {
    let saveId = localStorage.getItem('lane_defense_save_id');
    if (!saveId) {
        // crypto.randomUUID()ãŒä½¿ãˆãªã„ç’°å¢ƒã«ã‚‚å¯¾å¿œã€ãŸã ã—ã»ã¼ä½¿ãˆã‚‹ã¯ãš
        saveId = (crypto.randomUUID ? crypto.randomUUID() : 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => { const r = Math.random()*16|0; return (c === 'x' ? r : (r&0x3|0x8)).toString(16); }));
        localStorage.setItem('lane_defense_save_id', saveId);
    }
    return saveId;
}

function serializeGameState() {
    // ä¿å­˜å¯¾è±¡ã ã‘ã‚’æŠ½å‡ºã€‚æˆ¦é—˜ä¸­ã®ä¸€æ™‚ãƒ‡ãƒ¼ã‚¿ã¯å«ã‚ãªã„ï¼ˆãã‚Šã‚ƒãã†ã ï¼‰
    const achievementStates = {};
    AchievementDB.forEach(a => { achievementStates[a.id] = a.unlocked; });
    return {
        money: GameState.money,
        playerName: GameState.playerName,
        playerStats: { atk: GameState.playerStats.atk, maxHp: GameState.playerStats.maxHp },
        costs: { ...GameState.costs },
        unlocks: { ...GameState.unlocks },
        comboLevels: { ...GameState.comboLevels },
        stats: { ...GameState.stats },
        inventory: GameState.inventory.map(item => ({ ...item })),
        maxWave: GameState.maxWave,
        storyData: { ...GameState.storyData },
        achievements: achievementStates
    };
}

function deserializeGameState(data) {
    // å„ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’æ…é‡ã«å¾©å…ƒï¼ˆå­˜åœ¨ã—ãªã„ã‚­ãƒ¼ã¯åˆæœŸå€¤ã®ã¾ã¾ï¼‰
    if (data.money != null) GameState.money = data.money;
    if (data.playerName) GameState.playerName = data.playerName;
    if (data.playerStats) {
        if (data.playerStats.atk != null) GameState.playerStats.atk = data.playerStats.atk;
        if (data.playerStats.maxHp != null) GameState.playerStats.maxHp = data.playerStats.maxHp;
    }
    if (data.costs) Object.assign(GameState.costs, data.costs);
    if (data.unlocks) Object.assign(GameState.unlocks, data.unlocks);
    if (data.comboLevels) Object.assign(GameState.comboLevels, data.comboLevels);
    if (data.stats) Object.assign(GameState.stats, data.stats);
    if (data.inventory) GameState.inventory = data.inventory;
    if (data.maxWave != null) GameState.maxWave = data.maxWave;
    if (data.storyData) Object.assign(GameState.storyData, data.storyData);
    // å®Ÿç¸¾ã®unlockedçŠ¶æ…‹ã‚’å¾©å…ƒ
    if (data.achievements) {
        AchievementDB.forEach(a => {
            if (data.achievements[a.id] != null) a.unlocked = data.achievements[a.id];
        });
    }
    // HPåˆæœŸåŒ–ï¼ˆã‚»ãƒ¼ãƒ–ã«ã¯æˆ¦é—˜ä¸­HPã¯å«ã‚ãªã„ï¼‰
    GameState.playerStats.hp = GameState.playerStats.maxHp;
    // selectedWaveã‚’maxWaveã«åŒæœŸ
    GameState.selectedWave = Math.max(1, GameState.maxWave - 1);
}

let _saveDebounceTimer = null;
async function saveGame() {
    // ãƒ‡ãƒã‚¦ãƒ³ã‚¹: é€£æ‰“ã—ã¦ã‚‚1ç§’ã«1å›ã ã‘ä¿å­˜ï¼ˆã‚µãƒ¼ãƒãƒ¼ã«å„ªã—ãï¼‰
    if (_saveDebounceTimer) clearTimeout(_saveDebounceTimer);
    _saveDebounceTimer = setTimeout(async () => {
        const sb = getSupabase();
        if (!sb) { console.warn('[SAVE] SupabaseæœªåˆæœŸåŒ–ã€ã‚¹ã‚­ãƒƒãƒ—'); return; }
        const saveId = getSaveId();
        const gameData = serializeGameState();
        try {
            // ã¾ãšæ—¢å­˜ãƒ¬ã‚³ãƒ¼ãƒ‰ã®ç¢ºèª
            const { data: existing } = await sb
                .from('lane_defense_saves')
                .select('id')
                .eq('save_id', saveId)
                .maybeSingle();
            
            if (existing) {
                // UPDATE: æ—¢å­˜ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ã‚’ä¸Šæ›¸ã
                const { error } = await sb
                    .from('lane_defense_saves')
                    .update({ game_data: gameData, updated_at: new Date().toISOString() })
                    .eq('save_id', saveId);
                if (error) throw error;
            } else {
                // INSERT: æ–°è¦ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ä½œæˆ
                const { error } = await sb
                    .from('lane_defense_saves')
                    .insert({ save_id: saveId, game_data: gameData });
                if (error) throw error;
            }
            console.log('[SAVE] ğŸ’¾ ã‚»ãƒ¼ãƒ–å®Œäº†ï¼ save_id:', saveId);
            showSaveIndicator();
        } catch (err) {
            console.warn('[SAVE] ã‚»ãƒ¼ãƒ–å¤±æ•—ï¼ˆãƒ—ãƒ¬ã‚¤ã«ã¯å½±éŸ¿ãªã—ï¼‰:', err);
        }
    }, 1000);
}

async function loadGame() {
    const sb = getSupabase();
    if (!sb) { console.warn('[LOAD] SupabaseæœªåˆæœŸåŒ–ã€æ–°è¦ã‚²ãƒ¼ãƒ ã¨ã—ã¦é–‹å§‹'); return; }
    const saveId = getSaveId();
    try {
        const { data, error } = await sb
            .from('lane_defense_saves')
            .select('game_data')
            .eq('save_id', saveId)
            .maybeSingle();
        if (error) throw error;
        if (data && data.game_data) {
            deserializeGameState(data.game_data);
            console.log('[LOAD] ğŸ“‚ ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿å¾©å…ƒå®Œäº†ï¼ save_id:', saveId);
            showSaveIndicator('ğŸ“‚ ãƒ‡ãƒ¼ã‚¿å¾©å…ƒ');
        } else {
            console.log('[LOAD] ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ãªã—ã€æ–°è¦ã‚²ãƒ¼ãƒ é–‹å§‹');
        }
    } catch (err) {
        console.warn('[LOAD] ãƒ­ãƒ¼ãƒ‰å¤±æ•—ï¼ˆæ–°è¦ã‚²ãƒ¼ãƒ ã¨ã—ã¦é–‹å§‹ï¼‰:', err);
    }
}
// ========================================

// â˜…ã‚·ãƒŠãƒªã‚ªå®šç¾© (æ‰‹è¨˜)
const JournalDB = [
    { reqUpgrades: 1, title: "æ‰‹è¨˜ #001", text: "é˜²è¡›ã‚·ã‚¹ãƒ†ãƒ èµ·å‹•ã€‚ã‚·ã‚¹ãƒ†ãƒ æ­£å¸¸ã€‚ç”Ÿä½“åå¿œã€è‡ªåˆ†ã®ã¿ã€‚è‡ªåˆ†ãŒèª°ãªã®ã‹ã€ãªãœã“ã“ã«ã„ã‚‹ã®ã‹æ€ã„å‡ºã›ãªã„ã€‚" },
    { reqUpgrades: 3, title: "æ‰‹è¨˜ #002", text: "æ©Ÿä½“ã®å¼·åŒ–ãƒ—ãƒ­ã‚»ã‚¹ã«é•å’Œæ„ŸãŒã‚ã‚‹ã€‚åŠ¹ç‡ãŒè‰¯ã™ãã‚‹ã€‚ã¾ã‚‹ã§ã€ã‚ã‚‰ã‹ã˜ã‚ã“ã†ãªã‚‹ã“ã¨ãŒäºˆæœŸã•ã‚Œã¦ã„ãŸã‹ã®ã‚ˆã†ã«ã€‚" },
    { reqUpgrades: 6, title: "æ‰‹è¨˜ #003", text: "è¿æ’ƒAIã®è£œåŠ©ã€‚ç§ã®æ€è€ƒã‚’å…ˆèª­ã¿ã—ã¦ã„ã‚‹ã‹ã®ã‚ˆã†ã ã€‚ç§ãŒæ©Ÿä½“ã‚’æ“ç¸¦ã—ã¦ã„ã‚‹ã®ã‹ã€ãã‚Œã¨ã‚‚æ©Ÿä½“ãŒç§ã‚’æ“ç¸¦ã—ã¦ã„ã‚‹ã®ã‹ã€‚" },
    { reqUpgrades: 10, title: "æ‰‹è¨˜ #004", text: "ãµã¨æ“ç¸¦æ¡¿ã‹ã‚‰æ‰‹ã‚’é›¢ã—ã¦ã¿ãŸã€‚æ©Ÿä½“ã¯â€¦å®Œç’§ãªè¿æ’ƒã‚’ç¶šã‘ãŸã€‚ç§ã¨ã„ã†å­˜åœ¨ã«æ„å‘³ã¯ã‚ã‚‹ã®ã‹ï¼Ÿ" },
    { reqUpgrades: 15, title: "æ‰‹è¨˜ #005", text: "ç§ã¯é˜²è¡›ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã ã€‚ã‹ã¤ã¦äººé–“ã ã£ãŸã€Œèª°ã‹ã€ã®è¨˜æ†¶ã‚’ç„¼ãä»˜ã‘ã‚‰ã‚ŒãŸã€ãŸã ã®é˜²è¡›å…µå™¨ã€‚â€¦ãã‚Œã§ã‚‚ã€ã“ã®æ‹ ç‚¹ã‚’å®ˆã‚ŠæŠœãã€‚" }
];

// â˜…ã‚·ãƒŠãƒªã‚ªå®šç¾© (ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–éºç‰© - ç‰¹å®šWAVEç¢ºå®šãƒ‰ãƒ­ãƒƒãƒ—)
const ArchiveDB = [
    { id: 'arc_5', targetWave: 5, icon: 'ğŸ“±', name: 'æ±šæŸ“æ¸¬å®šå™¨', desc: 'æ—§æ™‚ä»£ã®éºç‰©ã€‚', storyTitle: "æ–‡æ˜è¨˜éŒ²: å´©å£Š", storyText: "ã€Œå¤§æ°—æ±šæŸ“åº¦99%ã€‚åœ°è¡¨ã®å®Œå…¨æ”¾æ£„ã‚’æ±ºå®šã€‚è‡ªå¾‹å‹ç’°å¢ƒæµ„åŒ–æ©Ÿæ§‹ã‚’èµ·å‹•ã™ã‚‹ã€‚ã€" },
    { id: 'arc_10', targetWave: 10, icon: 'âš™ï¸', name: 'è‡ªå¾‹æ©Ÿæ¢°ã®ã‚³ã‚¢', desc: 'æ•µæ©Ÿã®å¿ƒè‡“éƒ¨ã€‚', storyTitle: "æ–‡æ˜è¨˜éŒ²: æš´èµ°", storyText: "ã€Œæµ„åŒ–æ©Ÿæ§‹ã¯åœ°è¡¨ã®ã€æœ‰æ©Ÿç‰©ã™ã¹ã¦ã€ã‚’æ±šæŸ“æºã¨ã¿ãªã—ã€æ’é™¤ã‚’é–‹å§‹ã—ãŸã€‚æˆ‘ã€…ã¯è‡ªã‚‰ä½œã£ãŸæ©Ÿæ¢°ã«æ®ºã•ã‚Œã‚‹ã€‚ã€" },
    { id: 'arc_15', targetWave: 15, icon: 'ğŸ§ª', name: 'ã‚«ãƒ—ã‚»ãƒ«ã®ç ´ç‰‡', desc: 'æ‹ ç‚¹ã®æ·±éƒ¨ã¨åŒã˜æè³ªã€‚', storyTitle: "æ–‡æ˜è¨˜éŒ²: çœ ã‚Š", storyText: "ã€Œæˆ‘ã€…ã¯ã“ã®åœ°ä¸‹æ‹ ç‚¹ã§çœ ã‚Šã«ã¤ãã€‚æµ„åŒ–ãŒçµ‚ã‚ã‚Šã€å†ã³é’ã„ç©ºãŒè¦‹ãˆã‚‹æ—¥ã¾ã§ã€‚é˜²è¡›ã‚·ã‚¹ãƒ†ãƒ ã‚ˆã€æˆ‘ã€…ã‚’å®ˆã£ã¦ãã‚Œã€‚ã€" },
    { id: 'arc_20', targetWave: 20, icon: 'ğŸ‘‘', name: 'æ—§äººé¡ã®ç‹å† ', desc: 'æ¨©åŠ›ã®è±¡å¾´ã€‚', storyTitle: "æ–‡æ˜è¨˜éŒ²: çµ‚ç„‰", storyText: "æµ„åŒ–æ©Ÿæ§‹ã«çµ‚ã‚ã‚Šã¯è¨­å®šã•ã‚Œã¦ã„ãªã‹ã£ãŸã€‚å½¼ã‚‰ã¯ãšã£ã¨ã€å­˜åœ¨ã—ãªã„æ•µã¨æˆ¦ã„ç¶šã‘ã¦ã„ã‚‹ã€‚ç§ã‚‚ã¾ãŸåŒã˜ã ã€‚" }
];

// â˜…å®Ÿç¸¾å®šç¾©
const AchievementDB = [
    { id: 'z100', type: 'zCount', target: 500, name: 'ç´ æŒ¯ã‚Šè·äºº', desc: 'å¼±æ”»æ’ƒã‚’ç´¯è¨ˆ500å›ä½¿ç”¨', rewardDesc: 'åŸºç¤æ”»æ’ƒåŠ› +5', unlocked: false },
    { id: 'z500', type: 'zCount', target: 2500, name: 'é€£æ‰“ã®é¬¼', desc: 'å¼±æ”»æ’ƒã‚’ç´¯è¨ˆ2500å›ä½¿ç”¨', rewardDesc: 'åŸºç¤æ”»æ’ƒåŠ› +10', unlocked: false },
    { id: 'x50', type: 'xCount', target: 250, name: 'é‡ã„ä¸€æ’ƒ', desc: 'å¼·æ”»æ’ƒã‚’ç´¯è¨ˆ250å›ä½¿ç”¨', rewardDesc: 'åŸºç¤æ”»æ’ƒåŠ› +5', unlocked: false },
    { id: 'x200', type: 'xCount', target: 1000, name: 'ç ´å£Šè¡å‹•', desc: 'å¼·æ”»æ’ƒã‚’ç´¯è¨ˆ1000å›ä½¿ç”¨', rewardDesc: 'åŸºç¤æ”»æ’ƒåŠ› +10', unlocked: false },
    { id: 'k100', type: 'kills', target: 500, name: 'æ–°ç±³é˜²è¡›è€…', desc: 'æ•µã‚’ç´¯è¨ˆ500ä½“è¨ä¼', rewardDesc: 'æœ€å¤§HP +50', unlocked: false },
    { id: 'k500', type: 'kills', target: 2500, name: 'ç†Ÿç·´ã®æƒé™¤å±‹', desc: 'æ•µã‚’ç´¯è¨ˆ2500ä½“è¨ä¼', rewardDesc: 'æœ€å¤§HP +100', unlocked: false },
    { id: 'c10', type: 'critCount', target: 10, name: 'å¥‡è·¡ã®ä¸€æ’ƒ', desc: 'ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ã‚’ç´¯è¨ˆ10å›ç™ºå‹•', rewardDesc: 'åŸºç¤æ”»æ’ƒåŠ› +15', unlocked: false }, 
    { id: 'c50', type: 'critCount', target: 50, name: 'ç¥æ‡¸ã‹ã‚Š', desc: 'ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ã‚’ç´¯è¨ˆ50å›ç™ºå‹•', rewardDesc: 'åŸºç¤æ”»æ’ƒåŠ› +30', unlocked: false }  
];

const screens = { base: document.getElementById('screen-base'), battle: document.getElementById('screen-battle') };

// UIè¦ç´ 
const elBaseMoney = document.getElementById('base-money'), elStatAtk = document.getElementById('stat-atk'), elStatHp = document.getElementById('stat-hp');
const elCostAtk = document.getElementById('cost-atk'), elCostHp = document.getElementById('cost-hp');
const btnUpgradeAtk = document.getElementById('btn-upgrade-atk'), btnUpgradeHp = document.getElementById('btn-upgrade-hp');

// Skill Tree UI Elements
const btnUlWeak2 = document.getElementById('btn-ul-weak2'), txtUlWeak2 = document.getElementById('txt-ul-weak2'), costUlWeak2 = document.getElementById('cost-ul-weak2');
const btnUlWeak3 = document.getElementById('btn-ul-weak3'), txtUlWeak3 = document.getElementById('txt-ul-weak3'), costUlWeak3 = document.getElementById('cost-ul-weak3'), divSkillWeak3 = document.getElementById('skill-weak3');

const btnUlStrong = document.getElementById('btn-ul-strong'), costUlStrong = document.getElementById('cost-ul-strong'), divSkillStrong = document.getElementById('skill-strong'), strongUpgrades = document.getElementById('strong-upgrades');
const btnUpSDmg = document.getElementById('btn-up-s-dmg'), lvlSDmg = document.getElementById('lvl-s-dmg'), costSDmg = document.getElementById('cost-s-dmg');
const btnUpSRng = document.getElementById('btn-up-s-rng'), lvlSRng = document.getElementById('lvl-s-rng'), costSRng = document.getElementById('cost-s-rng');

const btnUlCombo1 = document.getElementById('btn-ul-combo1'), costUlCombo1 = document.getElementById('cost-ul-combo1'), divSkillCombo1 = document.getElementById('skill-combo1'), combo1Upgrades = document.getElementById('combo1-upgrades');
const btnUpC1Dmg = document.getElementById('btn-up-c1-dmg'), lvlC1Dmg = document.getElementById('lvl-c1-dmg'), costC1Dmg = document.getElementById('cost-c1-dmg');
const btnUpC1Rng = document.getElementById('btn-up-c1-rng'), lvlC1Rng = document.getElementById('lvl-c1-rng'), costC1Rng = document.getElementById('cost-c1-rng');

const btnUlCombo2 = document.getElementById('btn-ul-combo2'), costUlCombo2 = document.getElementById('cost-ul-combo2'), divSkillCombo2 = document.getElementById('skill-combo2'), combo2Upgrades = document.getElementById('combo2-upgrades');
const btnUpC2Dmg = document.getElementById('btn-up-c2-dmg'), lvlC2Dmg = document.getElementById('lvl-c2-dmg'), costC2Dmg = document.getElementById('cost-c2-dmg');
const btnUpC2Rng = document.getElementById('btn-up-c2-rng'), lvlC2Rng = document.getElementById('lvl-c2-rng'), costC2Rng = document.getElementById('cost-c2-rng');

const btnUnlockAutoAim = document.getElementById('btn-unlock-autoaim'), costUlAutoAim = document.getElementById('cost-ul-autoaim'), txtUnlockedAutoAim = document.getElementById('txt-unlocked-autoaim');

const btnWavePrev = document.getElementById('btn-wave-prev'), btnWaveNext = document.getElementById('btn-wave-next'), dispSelectedWave = document.getElementById('disp-selected-wave');

const btnSortie = document.getElementById('btn-sortie'), shelfContainer = document.getElementById('shelf-container'), itemDesc = document.getElementById('item-description');
const canvas = document.getElementById('game-canvas'), ctx = canvas.getContext('2d');
const hudWave = document.getElementById('hud-wave'), hudBaseMoney = document.getElementById('hud-base-money'), hudSessionMoney = document.getElementById('hud-session-money'), hudHpBar = document.getElementById('hud-hp-bar'), hudHpVal = document.getElementById('hud-hp-val'), hudMaxHpVal = document.getElementById('hud-max-hp-val'), hudEnemies = document.getElementById('hud-enemies');
const hudSkillName = document.getElementById('hud-skill-name');
const waveModal = document.getElementById('wave-modal'), modalMoney = document.getElementById('modal-money'), dropNotification = document.getElementById('drop-notification'), dropItemIcon = document.getElementById('drop-item-icon'), dropItemName = document.getElementById('drop-item-name'), dropTitle = document.getElementById('drop-title'), btnReturn = document.getElementById('btn-return'), btnNextWave = document.getElementById('btn-next-wave');
const deathModal = document.getElementById('death-modal'), btnDeathReturn = document.getElementById('btn-death-return');

// ç·´ç¿’ã‚­ãƒ£ãƒ³ãƒã‚¹ç”¨
const pCanvas = document.getElementById('practice-canvas');
const pCtx = pCanvas.getContext('2d');
const pracHudSkill = document.getElementById('prac-hud-skill');

function resizeCanvas() {
    if (screens['battle'] && screens['battle'].classList.contains('active')) {
        const container = document.getElementById('canvas-container');
        if (container) {
            canvas.width = container.clientWidth;
            canvas.height = container.clientHeight;
        }
    }
    // æ‹ ç‚¹ç”»é¢ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹ã‹ã¤ã€ç·´ç¿’ç”¨ã‚­ãƒ£ãƒ³ãƒã‚¹ãŒå«ã¾ã‚Œã‚‹ã‚¿ãƒ–ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹å ´åˆã«åˆæœŸåŒ–
    if (screens['base'] && screens['base'].classList.contains('active')) {
        const isStatusVisible = !document.getElementById('tab-status').classList.contains('hidden');
        const isBaseHomeVisible = !document.getElementById('tab-base-home').classList.contains('hidden');
        if (isStatusVisible || isBaseHomeVisible) {
            initPractice();
        }
    }
}

// æ±ç”¨ãƒˆãƒ¼ã‚¹ãƒˆ
function showMessageToast(title, desc, bgColorClass = "bg-blue-900") {
    const toast = document.getElementById('general-toast');
    document.getElementById('toast-title').innerText = title;
    document.getElementById('toast-desc').innerText = desc;
    
    toast.className = toast.className.replace(/bg-[a-z]+-\d+/g, '');
    toast.classList.add(bgColorClass.split(' ')[0]);

    toast.classList.remove('opacity-0', '-translate-y-20');
    toast.classList.add('translate-y-0', 'opacity-100');
    
    setTimeout(() => {
        toast.classList.add('opacity-0', '-translate-y-20');
        toast.classList.remove('translate-y-0', 'opacity-100');
    }, 4000);
}

// æ§ãˆã‚ã‚»ãƒ¼ãƒ–ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ï¼ˆãƒ•ãƒƒã‚¿ã®ä¸Šã«ã²ã£ãã‚Šç¾ã‚Œã¦æ¶ˆãˆã‚‹ã€‚å¥¥ã‚†ã‹ã—ã•ãŒå¤§äº‹ã€‚ï¼‰
let _saveIndicatorEl = null;
function showSaveIndicator(text = 'ğŸ’¾ ã‚»ãƒ¼ãƒ–å®Œäº†') {
    if (!_saveIndicatorEl) {
        _saveIndicatorEl = document.createElement('div');
        _saveIndicatorEl.style.cssText = 'position:fixed;bottom:84px;right:12px;color:rgba(148,163,184,0.7);font-size:11px;font-weight:bold;pointer-events:none;transition:opacity 0.5s;z-index:60;';
        document.body.appendChild(_saveIndicatorEl);
    }
    _saveIndicatorEl.innerText = text;
    _saveIndicatorEl.style.opacity = '1';
    setTimeout(() => { _saveIndicatorEl.style.opacity = '0'; }, 2000);
}


// === ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒ»ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆãƒ­ã‚¸ãƒƒã‚¯ ===

window.switchMenu = function(menuId) {
    // å…¨ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚¿ãƒ–ã‚»ãƒƒãƒˆã‚’éš ã™
    document.querySelectorAll('.menu-tabs').forEach(el => {
        el.classList.add('hidden');
        el.classList.remove('flex');
    });
    // ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚¿ãƒ–ã‚»ãƒƒãƒˆã‚’è¡¨ç¤º
    const targetTabs = document.getElementById('tabs-' + menuId);
    if (targetTabs) {
        targetTabs.classList.remove('hidden');
        targetTabs.classList.add('flex');
    }

    // ãƒ•ãƒƒã‚¿ãƒœã‚¿ãƒ³ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹æ›´æ–°
    document.querySelectorAll('.footer-btn').forEach(btn => {
        btn.classList.remove('text-blue-400', 'active-menu');
        btn.classList.add('text-gray-500');
    });
    const activeBtn = Array.from(document.querySelectorAll('.footer-btn')).find(btn => btn.getAttribute('onclick')?.includes(`'${menuId}'`));
    if (activeBtn) {
        activeBtn.classList.remove('text-gray-500');
        activeBtn.classList.add('text-blue-400', 'active-menu');
    }

    // å„ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¿ãƒ–ã¸åˆ‡ã‚Šæ›¿ãˆ
    const defaultTabs = {
        'base': 'base-home',
        'upgrade': 'skill',
        'archive': 'journal',
        'settings': 'settings-main'
    };
    if (defaultTabs[menuId]) {
        switchTab(defaultTabs[menuId]);
    }

    // ãƒ˜ãƒƒãƒ€ãƒ¼ã‚¿ã‚¤ãƒˆãƒ«ã®æ›´æ–°
    const titleMap = { 'base': 'æ‹ ç‚¹', 'upgrade': 'å¼·åŒ–ãƒ»ã‚¹ã‚­ãƒ«', 'archive': 'ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–', 'settings': 'è¨­å®š' };
    const elTitle = document.getElementById('screen-title');
    if (elTitle && titleMap[menuId]) elTitle.innerText = titleMap[menuId];
}

window.switchTab = function(tabId) {
    // å…¨ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’éš ã™
    document.querySelectorAll('.tab-content').forEach(el => {
        el.classList.add('hidden');
        el.classList.remove('block');
    });
    // ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚’è¡¨ç¤º
    const target = document.getElementById('tab-' + tabId);
    if (target) {
        target.classList.remove('hidden');
        target.classList.add('block');
    }

    // ã‚¿ãƒ–ãƒœã‚¿ãƒ³ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹æ›´æ–°ï¼ˆç¾åœ¨ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼å†…ã®ãƒœã‚¿ãƒ³ã®ã¿ï¼‰
    document.querySelectorAll('.tab-btn').forEach(el => {
        el.classList.remove('border-blue-500', 'text-blue-400', 'bg-blue-900/20');
        el.classList.add('border-transparent', 'text-gray-500');
    });
    const activeBtn = Array.from(document.querySelectorAll('.tab-btn')).find(btn => btn.getAttribute('onclick')?.includes(`'${tabId}'`));
    if (activeBtn) {
        activeBtn.classList.remove('border-transparent', 'text-gray-500');
        activeBtn.classList.add('border-blue-500', 'text-blue-400', 'bg-blue-900/20');
    }

    // ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã«å¿œã˜ãŸè¿½åŠ å‡¦ç†
    if (tabId === 'status' || tabId === 'base-home') {
        setTimeout(resizeCanvas, 50); // ã‚¿ãƒ–è¡¨ç¤ºå¾Œã«ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚’ãƒªã‚µã‚¤ã‚º
    }
    if (tabId === 'achievement') renderAchievements();
    if (tabId === 'item') { renderShelf(); }
    if (tabId === 'journal' || tabId === 'history') { renderStories(); }
}

function showScreen(screenName) {
    Object.values(screens).forEach(s => s.classList.remove('active'));
    screens[screenName].classList.add('active');
    if (screenName === 'base') { 
        updateBaseUI(); 
        // åˆæœŸãƒ¡ãƒ‹ãƒ¥ãƒ¼ã¨ã—ã¦ã€Œæ‹ ç‚¹ã€ã‚’è¡¨ç¤º
        switchMenu('base');
    } else if (screenName === 'battle') { 
        setTimeout(() => {
            resizeCanvas(); 
            startBattleSession(); 
        }, 50);
    }
}

// === ã‚·ãƒŠãƒªã‚ªãƒ»æ‰‹è¨˜è§£æ”¾ãƒ­ã‚¸ãƒƒã‚¯ ===
function checkJournalUnlock() {
    GameState.stats.upgradeCount++;
    const nextJournal = JournalDB.find(j => j.reqUpgrades === GameState.stats.upgradeCount);
    
    if (nextJournal) {
        GameState.storyData.journalIndex++;
        const toast = document.getElementById('story-toast');
        const tm = document.getElementById('toast-story-name');
        if (toast && tm) {
            tm.innerText = nextJournal.title;
            toast.classList.remove('opacity-0', '-translate-y-20');
            toast.classList.add('translate-y-0', 'opacity-100');
            setTimeout(() => {
                toast.classList.add('opacity-0', '-translate-y-20');
                toast.classList.remove('translate-y-0', 'opacity-100');
            }, 4000);
        } else {
            // ãƒˆãƒ¼ã‚¹ãƒˆãŒå­˜åœ¨ã—ãªã„å ´åˆã¯æ±ç”¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä½¿ç”¨
            showMessageToast("æ‰‹è¨˜è§£æ”¾", nextJournal.title, "bg-indigo-700");
        }
    }
}

function renderStories() {
    const jList = document.getElementById('journal-list');
    jList.innerHTML = '';
    if (GameState.storyData.journalIndex === 0) {
        jList.innerHTML = '<div class="text-center text-gray-500 py-4 text-sm border border-gray-700 rounded bg-gray-900">è¨˜éŒ²ã¯ã‚ã‚Šã¾ã›ã‚“</div>';
    } else {
        for (let i = 0; i < GameState.storyData.journalIndex; i++) {
            const story = JournalDB[i];
            const div = document.createElement('div');
            div.className = `p-3 rounded border bg-blue-900/20 border-blue-800`;
            div.innerHTML = `
                <div class="font-bold text-blue-300 text-sm mb-1">${story.title}</div>
                <div class="text-sm text-gray-300 leading-relaxed">${story.text}</div>
            `;
            jList.appendChild(div);
        }
    }

    const aList = document.getElementById('archive-list');
    aList.innerHTML = '';
    const archives = GameState.inventory.filter(i => i.storyTitle);
    if (archives.length === 0) {
        aList.innerHTML = '<div class="text-center text-gray-500 py-4 text-sm border border-gray-700 rounded bg-gray-900">éºç‰©ã‚’å›åã—ã¦ã„ã¾ã›ã‚“</div>';
    } else {
        archives.forEach(arc => {
            const div = document.createElement('div');
            div.className = `p-3 rounded border bg-yellow-900/20 border-yellow-800`;
            div.innerHTML = `
                <div class="font-bold text-yellow-300 text-sm mb-1">${arc.icon} ${arc.storyTitle}</div>
                <div class="text-sm text-gray-300 leading-relaxed">${arc.storyText}</div>
            `;
            aList.appendChild(div);
        });
    }
}

// === å®Ÿç¸¾ã‚·ã‚¹ãƒ†ãƒ é–¢é€£ ===
function checkAchievements() {
    let hasNew = false;
    AchievementDB.forEach(ach => {
        if (!ach.unlocked && GameState.stats[ach.type] >= ach.target) {
            ach.unlocked = true;
            
            if (ach.id === 'z100') GameState.playerStats.atk += 5;
            if (ach.id === 'z500') GameState.playerStats.atk += 10;
            if (ach.id === 'x50') GameState.playerStats.atk += 5;
            if (ach.id === 'x200') GameState.playerStats.atk += 10;
            if (ach.id === 'k100') { GameState.playerStats.maxHp += 50; GameState.playerStats.hp += 50; }
            if (ach.id === 'k500') { GameState.playerStats.maxHp += 100; GameState.playerStats.hp += 100; }
            if (ach.id === 'c10') GameState.playerStats.atk += 15;
            if (ach.id === 'c50') GameState.playerStats.atk += 30;
            
            showAchievementToast(ach);
            hasNew = true;
        }
    });
    if (hasNew && screens['base'].classList.contains('active')) {
        updateBaseUI();
        renderAchievements();
    }
}

function showAchievementToast(ach) {
    const toast = document.getElementById('achievement-toast');
    const aname = document.getElementById('toast-achieve-name');
    const arew = document.getElementById('toast-achieve-reward');
    
    if (toast && aname && arew) {
        aname.innerText = ach.name;
        arew.innerText = ach.rewardDesc;
        toast.classList.remove('opacity-0', '-translate-y-20');
        toast.classList.add('translate-y-0', 'opacity-100');
        
        setTimeout(() => {
            toast.classList.add('opacity-0', '-translate-y-20');
            toast.classList.remove('translate-y-0', 'opacity-100');
        }, 4000);
    } else {
        // ãƒˆãƒ¼ã‚¹ãƒˆè¦ç´ ãŒãªã„å ´åˆã¯ã€æ±ç”¨ã®ãƒˆãƒ¼ã‚¹ãƒˆæ©Ÿèƒ½ã«fallbackã™ã‚‹
        showMessageToast("å®Ÿç¸¾è§£é™¤", ach.name, "bg-green-700");
    }
}

function renderAchievements() {
    const list = document.getElementById('achievement-list');
    list.innerHTML = '';
    AchievementDB.forEach(ach => {
        const div = document.createElement('div');
        div.className = `p-3 rounded border ${ach.unlocked ? 'bg-yellow-900/40 border-yellow-600' : 'bg-gray-800 border-gray-600 opacity-60'}`;
        div.innerHTML = `
            <div class="flex justify-between items-center mb-1">
                <div class="font-bold ${ach.unlocked ? 'text-yellow-400' : 'text-gray-400'}">${ach.unlocked ? 'ğŸ† ' : ''}${ach.name}</div>
                <div class="text-xs ${ach.unlocked ? 'text-green-400' : 'text-gray-500'}">${ach.unlocked ? 'é”æˆæ¸ˆ' : `${GameState.stats[ach.type]} / ${ach.target}`}</div>
            </div>
            <div class="text-sm text-gray-300">${ach.desc}</div>
            <div class="text-xs text-blue-300 mt-1">å ±é…¬: ${ach.rewardDesc}</div>
        `;
        list.appendChild(div);
    });
}

// === æ‹ ç‚¹ãƒ­ã‚¸ãƒƒã‚¯ ===
function updateBaseUI() {
    elBaseMoney.innerText = GameState.money; elStatAtk.innerText = GameState.playerStats.atk; elStatHp.innerText = GameState.playerStats.maxHp;
    elCostAtk.innerText = GameState.costs.atk; elCostHp.innerText = GameState.costs.hp;
    // åå‰è¡¨ç¤ºã®æ›´æ–°ï¼ˆå›ã®åã¯æ°¸é ã«è¼ãï¼‰
    const elPlayerName = document.getElementById('player-name-display');
    if (elPlayerName) elPlayerName.innerText = GameState.playerName;
    
    const elMaxWave = document.getElementById('stat-max-wave');
    const elKills = document.getElementById('stat-kills');
    if(elMaxWave) elMaxWave.innerText = GameState.maxWave;
    if(elKills) elKills.innerText = GameState.stats.kills;

    btnUpgradeAtk.disabled = GameState.money < GameState.costs.atk; btnUpgradeHp.disabled = GameState.money < GameState.costs.hp;
    btnUpgradeAtk.className = btnUpgradeAtk.disabled ? "w-full bg-gray-600 text-gray-400 px-2 py-1 rounded font-bold cursor-not-allowed text-xs flex justify-between items-center mt-1" : "w-full bg-blue-600 hover:bg-blue-500 text-white px-2 py-1 rounded font-bold transition text-xs flex justify-between items-center mt-1 cursor-pointer";
    btnUpgradeHp.className = btnUpgradeHp.disabled ? "w-full bg-gray-600 text-gray-400 px-2 py-1 rounded font-bold cursor-not-allowed text-xs flex justify-between items-center mt-1" : "w-full bg-green-600 hover:bg-green-500 text-white px-2 py-1 rounded font-bold transition text-xs flex justify-between items-center mt-1 cursor-pointer";

    // --- ãƒ„ãƒªãƒ¼UIã®è¡¨ç¤ºåˆ¶å¾¡ ---
    divSkillWeak3.classList.toggle('hidden', !GameState.unlocks.weak2);
    divSkillStrong.classList.toggle('hidden', !GameState.unlocks.weak3);
    divSkillCombo1.classList.toggle('hidden', !GameState.unlocks.strong);
    divSkillCombo2.classList.toggle('hidden', !GameState.unlocks.combo1);

    if (GameState.unlocks.weak2) { btnUlWeak2.classList.add('hidden'); txtUlWeak2.classList.remove('hidden'); }
    else { costUlWeak2.innerText = GameState.costs.unlockWeak2; btnUlWeak2.disabled = GameState.money < GameState.costs.unlockWeak2; btnUlWeak2.className = btnUlWeak2.disabled ? "bg-gray-600 text-gray-400 px-3 py-1 rounded font-bold cursor-not-allowed text-sm flex-shrink-0 ml-2" : "bg-purple-600 hover:bg-purple-500 text-white px-3 py-1 rounded font-bold transition text-sm flex-shrink-0 ml-2"; }

    if (GameState.unlocks.weak3) { btnUlWeak3.classList.add('hidden'); txtUlWeak3.classList.remove('hidden'); }
    else { costUlWeak3.innerText = GameState.costs.unlockWeak3; btnUlWeak3.disabled = GameState.money < GameState.costs.unlockWeak3; btnUlWeak3.className = btnUlWeak3.disabled ? "bg-gray-600 text-gray-400 px-3 py-1 rounded font-bold cursor-not-allowed text-sm flex-shrink-0 ml-2" : "bg-purple-600 hover:bg-purple-500 text-white px-3 py-1 rounded font-bold transition text-sm flex-shrink-0 ml-2"; }

    if (GameState.unlocks.strong) {
        btnUlStrong.classList.add('hidden'); strongUpgrades.classList.remove('hidden');
        costSDmg.innerText = GameState.costs.upSDmg; lvlSDmg.innerText = GameState.comboLevels.sDmg;
        btnUpSDmg.disabled = GameState.money < GameState.costs.upSDmg; btnUpSDmg.className = btnUpSDmg.disabled ? "flex-1 bg-gray-600 text-gray-400 px-2 py-1 text-xs rounded font-bold cursor-not-allowed" : "flex-1 bg-blue-600 hover:bg-blue-500 text-white px-2 py-1 text-xs rounded transition font-bold";
        costSRng.innerText = GameState.costs.upSRng; lvlSRng.innerText = GameState.comboLevels.sRng;
        btnUpSRng.disabled = GameState.money < GameState.costs.upSRng; btnUpSRng.className = btnUpSRng.disabled ? "flex-1 bg-gray-600 text-gray-400 px-2 py-1 text-xs rounded font-bold cursor-not-allowed" : "flex-1 bg-teal-600 hover:bg-teal-500 text-white px-2 py-1 text-xs rounded transition font-bold";
    } else {
        costUlStrong.innerText = GameState.costs.unlockStrong; btnUlStrong.disabled = GameState.money < GameState.costs.unlockStrong; btnUlStrong.className = btnUlStrong.disabled ? "bg-gray-600 text-gray-400 px-3 py-1 rounded font-bold cursor-not-allowed text-sm flex-shrink-0 ml-2" : "bg-purple-600 hover:bg-purple-500 text-white px-3 py-1 rounded font-bold transition text-sm flex-shrink-0 ml-2";
    }

    if (GameState.unlocks.combo1) {
        btnUlCombo1.classList.add('hidden'); combo1Upgrades.classList.remove('hidden');
        costC1Dmg.innerText = GameState.costs.upC1Dmg; lvlC1Dmg.innerText = GameState.comboLevels.c1Dmg;
        btnUpC1Dmg.disabled = GameState.money < GameState.costs.upC1Dmg; btnUpC1Dmg.className = btnUpC1Dmg.disabled ? "flex-1 bg-gray-600 text-gray-400 px-2 py-1 text-xs rounded font-bold cursor-not-allowed" : "flex-1 bg-blue-600 hover:bg-blue-500 text-white px-2 py-1 text-xs rounded transition font-bold";
        costC1Rng.innerText = GameState.costs.upC1Rng; lvlC1Rng.innerText = GameState.comboLevels.c1Rng;
        btnUpC1Rng.disabled = GameState.money < GameState.costs.upC1Rng; btnUpC1Rng.className = btnUpC1Rng.disabled ? "flex-1 bg-gray-600 text-gray-400 px-2 py-1 text-xs rounded font-bold cursor-not-allowed" : "flex-1 bg-teal-600 hover:bg-teal-500 text-white px-2 py-1 text-xs rounded transition font-bold";
    } else {
        costUlCombo1.innerText = GameState.costs.unlockCombo1; btnUlCombo1.disabled = GameState.money < GameState.costs.unlockCombo1; btnUlCombo1.className = btnUlCombo1.disabled ? "bg-gray-600 text-gray-400 px-3 py-1 rounded font-bold cursor-not-allowed text-sm flex-shrink-0 ml-2" : "bg-purple-600 hover:bg-purple-500 text-white px-3 py-1 rounded font-bold transition text-sm flex-shrink-0 ml-2";
    }

    if (GameState.unlocks.combo2) {
        btnUlCombo2.classList.add('hidden'); combo2Upgrades.classList.remove('hidden');
        costC2Dmg.innerText = GameState.costs.upC2Dmg; lvlC2Dmg.innerText = GameState.comboLevels.c2Dmg;
        btnUpC2Dmg.disabled = GameState.money < GameState.costs.upC2Dmg; btnUpC2Dmg.className = btnUpC2Dmg.disabled ? "flex-1 bg-gray-600 text-gray-400 px-2 py-1 text-xs rounded font-bold cursor-not-allowed" : "flex-1 bg-blue-600 hover:bg-blue-500 text-white px-2 py-1 text-xs rounded transition font-bold";
        costC2Rng.innerText = GameState.costs.upC2Rng; lvlC2Rng.innerText = GameState.comboLevels.c2Rng;
        btnUpC2Rng.disabled = GameState.money < GameState.costs.upC2Rng; btnUpC2Rng.className = btnUpC2Rng.disabled ? "flex-1 bg-gray-600 text-gray-400 px-2 py-1 text-xs rounded font-bold cursor-not-allowed" : "flex-1 bg-teal-600 hover:bg-teal-500 text-white px-2 py-1 text-xs rounded transition font-bold";
    } else {
        costUlCombo2.innerText = GameState.costs.unlockCombo2; btnUlCombo2.disabled = GameState.money < GameState.costs.unlockCombo2; btnUlCombo2.className = btnUlCombo2.disabled ? "bg-gray-600 text-gray-400 px-3 py-1 rounded font-bold cursor-not-allowed text-sm flex-shrink-0 ml-2" : "bg-purple-600 hover:bg-purple-500 text-white px-3 py-1 rounded font-bold transition text-sm flex-shrink-0 ml-2";
    }

    if (GameState.unlocks.autoAim) { btnUnlockAutoAim.classList.add('hidden'); txtUnlockedAutoAim.classList.remove('hidden'); }
    else { costUlAutoAim.innerText = GameState.costs.unlockAutoAim; btnUnlockAutoAim.disabled = GameState.money < GameState.costs.unlockAutoAim; btnUnlockAutoAim.className = btnUnlockAutoAim.disabled ? "bg-gray-600 text-gray-400 px-3 py-1 rounded font-bold cursor-not-allowed text-sm flex-shrink-0 ml-2" : "bg-purple-600 hover:bg-purple-500 text-white px-3 py-1 rounded font-bold transition text-sm flex-shrink-0 ml-2"; }

    dispSelectedWave.innerText = GameState.selectedWave;
    btnWavePrev.disabled = GameState.selectedWave <= 1;
    btnWaveNext.disabled = GameState.selectedWave >= GameState.maxWave;

    // å¼·åŒ–ãƒãƒƒã‚¸æ›´æ–°ï¼ˆã©ã“ãŒå¼·åŒ–ã§ãã‚‹ã‹æ•™ãˆã¦ã‚ã’ã‚ˆã†ï¼‰
    updateBadges();
}

// === å¼·åŒ–ãƒãƒƒã‚¸ã‚·ã‚¹ãƒ†ãƒ  === 
// æ‰€æŒé‡‘ã§è³¼å…¥å¯èƒ½ãªå¼·åŒ–ãƒ»ã‚¹ã‚­ãƒ«ãŒã‚ã‚Œã°ãƒãƒƒã‚¸ã‚’è¡¨ç¤º
function updateBadges() {
    const m = GameState.money;
    const u = GameState.unlocks;
    const c = GameState.costs;

    // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚¿ãƒ–: ATKã¾ãŸã¯HPãŒå¼·åŒ–å¯èƒ½ã‹ï¼ˆæ‰€æŒé‡‘ãŒè¶³ã‚Šã¦ã„ã‚‹ã¨ãã®ã¿ï¼‰
    const canUpgradeStatus = (m > 0) && ((m >= c.atk) || (m >= c.hp));
    const statusBadge = document.querySelector('[data-target="tab-status"] .badge-dot');
    if (statusBadge) statusBadge.classList.toggle('hidden', !canUpgradeStatus);

    // ã‚¹ã‚­ãƒ«ã‚¿ãƒ–: æœªè§£æ”¾ã®ã‚¹ã‚­ãƒ«ãŒè³¼å…¥å¯èƒ½ã‹ã€ã¾ãŸã¯è§£æ”¾æ¸ˆã‚¹ã‚­ãƒ«ã®å¼·åŒ–ãŒå¯èƒ½ã‹
    let canUpgradeSkill = false;
    if (m > 0) {
        // å‰ææ¡ä»¶ãªã—ã§è§£æ”¾å¯èƒ½
        if (!u.weak2 && m >= c.unlockWeak2) canUpgradeSkill = true;
        // å‰ææ¡ä»¶ã‚ã‚Šã§è§£æ”¾å¯èƒ½
        if (u.weak2 && !u.weak3 && m >= c.unlockWeak3) canUpgradeSkill = true;
        if (u.weak3 && !u.strong && m >= c.unlockStrong) canUpgradeSkill = true;
        if (u.strong && (m >= c.upSDmg || m >= c.upSRng)) canUpgradeSkill = true;
        if (u.strong && !u.combo1 && m >= c.unlockCombo1) canUpgradeSkill = true;
        if (u.combo1 && (m >= c.upC1Dmg || m >= c.upC1Rng)) canUpgradeSkill = true;
        if (u.combo1 && !u.combo2 && m >= c.unlockCombo2) canUpgradeSkill = true;
        if (u.combo2 && (m >= c.upC2Dmg || m >= c.upC2Rng)) canUpgradeSkill = true;
        if (!u.autoAim && m >= c.unlockAutoAim) canUpgradeSkill = true;
    }
    const skillBadge = document.querySelector('[data-target="tab-skill"] .badge-dot');
    if (skillBadge) skillBadge.classList.toggle('hidden', !canUpgradeSkill);

    // æ‹ ç‚¹ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒãƒƒã‚¸: ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å¼·åŒ–å¯èƒ½ãªå ´åˆ
    const baseMenuBadge = document.getElementById('badge-menu-base');
    if (baseMenuBadge) baseMenuBadge.classList.toggle('hidden', !canUpgradeStatus);

    // å¼·åŒ–ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒãƒƒã‚¸: ã‚¹ã‚­ãƒ«è§£æ”¾ãƒ»å¼·åŒ–å¯èƒ½ãªå ´åˆ
    const upgradeMenuBadge = document.getElementById('badge-menu-upgrade');
    if (upgradeMenuBadge) upgradeMenuBadge.classList.toggle('hidden', !canUpgradeSkill);
}

// å¼·åŒ–ãƒ»è§£æ”¾ã‚¤ãƒ™ãƒ³ãƒˆ
btnUpgradeAtk.addEventListener('click', () => { if (GameState.money >= GameState.costs.atk) { GameState.money -= GameState.costs.atk; GameState.playerStats.atk += 2; GameState.costs.atk = Math.floor(GameState.costs.atk * 1.5); updateBaseUI(); checkJournalUnlock(); saveGame(); }});
btnUpgradeHp.addEventListener('click', () => { if (GameState.money >= GameState.costs.hp) { GameState.money -= GameState.costs.hp; GameState.playerStats.maxHp += 20; GameState.costs.hp = Math.floor(GameState.costs.hp * 1.5); updateBaseUI(); checkJournalUnlock(); saveGame(); }});
btnUnlockAutoAim.addEventListener('click', () => { if (GameState.money >= GameState.costs.unlockAutoAim) { GameState.money -= GameState.costs.unlockAutoAim; GameState.unlocks.autoAim = true; updateBaseUI(); checkJournalUnlock(); saveGame(); }});

btnUlWeak2.addEventListener('click', () => { if (GameState.money >= GameState.costs.unlockWeak2) { GameState.money -= GameState.costs.unlockWeak2; GameState.unlocks.weak2 = true; updateBaseUI(); checkJournalUnlock(); saveGame(); }});
btnUlWeak3.addEventListener('click', () => { if (GameState.money >= GameState.costs.unlockWeak3) { GameState.money -= GameState.costs.unlockWeak3; GameState.unlocks.weak3 = true; updateBaseUI(); checkJournalUnlock(); saveGame(); }});

btnUlStrong.addEventListener('click', () => { if (GameState.money >= GameState.costs.unlockStrong) { GameState.money -= GameState.costs.unlockStrong; GameState.unlocks.strong = true; updateBaseUI(); checkJournalUnlock(); saveGame(); }});
btnUpSDmg.addEventListener('click', () => { if (GameState.money >= GameState.costs.upSDmg) { GameState.money -= GameState.costs.upSDmg; GameState.comboLevels.sDmg++; GameState.costs.upSDmg = Math.floor(GameState.costs.upSDmg * 1.5); updateBaseUI(); checkJournalUnlock(); saveGame(); }});
btnUpSRng.addEventListener('click', () => { if (GameState.money >= GameState.costs.upSRng) { GameState.money -= GameState.costs.upSRng; GameState.comboLevels.sRng++; GameState.costs.upSRng = Math.floor(GameState.costs.upSRng * 1.5); updateBaseUI(); checkJournalUnlock(); saveGame(); }});

btnUlCombo1.addEventListener('click', () => { if (GameState.money >= GameState.costs.unlockCombo1) { GameState.money -= GameState.costs.unlockCombo1; GameState.unlocks.combo1 = true; updateBaseUI(); checkJournalUnlock(); saveGame(); }});
btnUpC1Dmg.addEventListener('click', () => { if (GameState.money >= GameState.costs.upC1Dmg) { GameState.money -= GameState.costs.upC1Dmg; GameState.comboLevels.c1Dmg++; GameState.costs.upC1Dmg = Math.floor(GameState.costs.upC1Dmg * 1.5); updateBaseUI(); checkJournalUnlock(); saveGame(); }});
btnUpC1Rng.addEventListener('click', () => { if (GameState.money >= GameState.costs.upC1Rng) { GameState.money -= GameState.costs.upC1Rng; GameState.comboLevels.c1Rng++; GameState.costs.upC1Rng = Math.floor(GameState.costs.upC1Rng * 1.5); updateBaseUI(); checkJournalUnlock(); saveGame(); }});

btnUlCombo2.addEventListener('click', () => { if (GameState.money >= GameState.costs.unlockCombo2) { GameState.money -= GameState.costs.unlockCombo2; GameState.unlocks.combo2 = true; updateBaseUI(); checkJournalUnlock(); saveGame(); }});
btnUpC2Dmg.addEventListener('click', () => { if (GameState.money >= GameState.costs.upC2Dmg) { GameState.money -= GameState.costs.upC2Dmg; GameState.comboLevels.c2Dmg++; GameState.costs.upC2Dmg = Math.floor(GameState.costs.upC2Dmg * 1.5); updateBaseUI(); checkJournalUnlock(); saveGame(); }});
btnUpC2Rng.addEventListener('click', () => { if (GameState.money >= GameState.costs.upC2Rng) { GameState.money -= GameState.costs.upC2Rng; GameState.comboLevels.c2Rng++; GameState.costs.upC2Rng = Math.floor(GameState.costs.upC2Rng * 1.5); updateBaseUI(); checkJournalUnlock(); saveGame(); }});
// === åå‰å¤‰æ›´UIãƒ­ã‚¸ãƒƒã‚¯ === 
// ã€Œåå‰ã¯å¤§äº‹ã ãã€‚ã‚¨ãƒ´ã‚¡ã«ã ã£ã¦æ‹’å¦æ¨©ãŒã‚ã£ãŸã‚“ã ã€‚ã€
const btnEditName = document.getElementById('btn-edit-name');
const playerNameDisplay = document.getElementById('player-name-display');
const playerNameEdit = document.getElementById('player-name-edit');
const inputPlayerName = document.getElementById('input-player-name');
const btnNameOk = document.getElementById('btn-name-ok');
const btnNameCancel = document.getElementById('btn-name-cancel');

function openNameEditor() {
    inputPlayerName.value = GameState.playerName;
    playerNameDisplay.classList.add('hidden');
    playerNameEdit.classList.remove('hidden');
    inputPlayerName.focus();
}
function closeNameEditor() {
    playerNameEdit.classList.add('hidden');
    playerNameDisplay.classList.remove('hidden');
}

btnEditName.addEventListener('click', openNameEditor);
playerNameDisplay.addEventListener('click', openNameEditor);
btnNameCancel.addEventListener('click', closeNameEditor);
btnNameOk.addEventListener('click', () => {
    const newName = inputPlayerName.value.trim();
    if (newName.length > 0 && newName.length <= 16) {
        GameState.playerName = newName;
        updateBaseUI();
        closeNameEditor();
        saveGame();
        showSaveIndicator(`âœ¨ ${newName} ã«å¤‰æ›´`);
    }
});
inputPlayerName.addEventListener('keydown', e => {
    if (e.key === 'Enter') btnNameOk.click();
    if (e.key === 'Escape') closeNameEditor();
});

// === ãƒ‹ãƒ¥ãƒ¼ã‚²ãƒ¼ãƒ ãƒ­ã‚¸ãƒƒã‚¯ ===
// ã€Œå…¨ã¦ã‚’æ¨ã¦ã‚‹è¦šæ‚Ÿã¯ã‚ã‚‹ã‹ï¼Ÿã€ã€Œã‚ã‚‹ã•ã€‚ã ã£ã¦ã¾ãŸèµ°ã‚Œã‚‹ã‚“ã ã‹ã‚‰ã€‚ã€
const btnNewGame = document.getElementById('btn-new-game');
btnNewGame.addEventListener('click', async () => {
    if (!confirm('âš ï¸ æœ¬å½“ã«ãƒ‹ãƒ¥ãƒ¼ã‚²ãƒ¼ãƒ ã‚’é–‹å§‹ã—ã¾ã™ã‹ï¼Ÿ\n\nã™ã¹ã¦ã®é€²è¡ŒçŠ¶æ³\uff08æ‰€æŒé‡‘ãƒ»ã‚¹ã‚­ãƒ«ãƒ»ã‚¢ã‚¤ãƒ†ãƒ ç­‰\uff09ãŒå®Œå…¨ã«ãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã™ã€‚')) return;
    if (!confirm('ğŸ”¥ æœ€çµ‚ç¢ºèªï¼šã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚\næœ¬å½“ã«ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) return;
    
    // Supabaseã‹ã‚‰ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤
    const sb = getSupabase();
    const saveId = getSaveId();
    if (sb) {
        try {
            await sb.from('lane_defense_saves').delete().eq('save_id', saveId);
            console.log('[NEW GAME] ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿å‰Šé™¤å®Œäº†');
        } catch (err) {
            console.warn('[NEW GAME] å‰Šé™¤å¤±æ•—:', err);
        }
    }
    // localStorageã®save_idã‚‚å‰Šé™¤ï¼ˆæ–°ã—ã„IDã§å†å‡ºç™ºï¼‰
    localStorage.removeItem('lane_defense_save_id');
    // ãƒšãƒ¼ã‚¸ãƒªãƒ­ãƒ¼ãƒ‰ã§åˆæœŸåŒ–
    location.reload();
});

// Wave Select Events
btnWavePrev.addEventListener('click', () => { 
    if (GameState.selectedWave > 1) { 
        GameState.selectedWave--; 
        updateBaseUI(); 
        if (screens['base'].classList.contains('active') && !document.getElementById('tab-status').classList.contains('hidden')) {
            initPractice(); // ãƒ¬ãƒ¼ãƒ³æ•°æ›´æ–°ã®ãŸã‚
        }
    } 
});
btnWaveNext.addEventListener('click', () => { 
    if (GameState.selectedWave < GameState.maxWave) { 
        GameState.selectedWave++; 
        updateBaseUI(); 
        if (screens['base'].classList.contains('active') && !document.getElementById('tab-status').classList.contains('hidden')) {
            initPractice(); // ãƒ¬ãƒ¼ãƒ³æ•°æ›´æ–°ã®ãŸã‚
        }
    } 
});

btnSortie.addEventListener('click', () => {
    GameState.currentWave = GameState.selectedWave;
    showScreen('battle');
});

function renderShelf() {
    shelfContainer.innerHTML = '';
    for (let i = 0; i < 40; i++) {
        const cell = document.createElement('div'); cell.className = 'shelf-cell rounded'; cell.id = `cell_${i}`;
        cell.addEventListener('dragover', e => { e.preventDefault(); cell.classList.add('drag-over'); });
        cell.addEventListener('dragleave', () => cell.classList.remove('drag-over'));
        cell.addEventListener('drop', e => { e.preventDefault(); cell.classList.remove('drag-over'); moveItemToCell(e.dataTransfer.getData('text/plain'), cell.id); });
        shelfContainer.appendChild(cell);
    }
    GameState.inventory.forEach(item => {
        const targetCell = document.getElementById(item.cellId);
        if (targetCell) {
            const elItem = document.createElement('div'); elItem.className = 'item text-3xl'; elItem.id = item.id; elItem.innerText = item.icon; elItem.draggable = true;
            elItem.addEventListener('mouseenter', () => {
                let html = `<span class="font-bold ${item.storyTitle ? 'text-yellow-300' : 'text-white'}">${item.name}</span><br>${item.desc}`;
                itemDesc.innerHTML = html;
            });
            elItem.addEventListener('mouseleave', () => itemDesc.innerHTML = 'ã‚¢ã‚¤ãƒ†ãƒ ã‚’ãƒ›ãƒãƒ¼ã§è©³ç´°è¡¨ç¤º');
            elItem.addEventListener('dragstart', e => { e.dataTransfer.setData('text/plain', item.id); setTimeout(() => elItem.style.opacity = '0.5', 0); });
            elItem.addEventListener('dragend', () => elItem.style.opacity = '1');
            targetCell.appendChild(elItem);
        }
    });
}
function moveItemToCell(itemId, newCellId) {
    const itemIndex = GameState.inventory.findIndex(i => i.id === itemId);
    if (itemIndex > -1 && document.getElementById(newCellId).children.length === 0) { GameState.inventory[itemIndex].cellId = newCellId; renderShelf(); }
}


// === ã‚²ãƒ¼ãƒ å…±é€šãƒ­ã‚¸ãƒƒã‚¯ ===

// ğŸ¨ ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãƒ‡ã‚¶ã‚¤ãƒŠãƒ¼é€£æº (ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ç‰ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ)
const _charConfigDefault = {
    scale: 1.5,
    headW: 14, headH: 14, headY: -10,
    torsoW: 16, torsoH: 24,
    upperArmW: 4, upperArmLen: 10, lowerArmW: 4, lowerArmLen: 10,
    upperLegW: 4, upperLegLen: 12, lowerLegW: 4, lowerLegLen: 12,
    shoulderX: 10, shoulderY: -10, hipX: 5, hipY: 10,
    elbowAngle: 0.5, kneeAngle: 0.2,
    breathSpeed: 350, walkSpeed: 450, eyeFlicker: 500,
    cBody: '#3b82f6', cHead: '#1e3a5f', cEye: '#38bdf8', cArms: '#2563eb', cLegs: '#1e40af',
    shadowAlpha: 0.3, shadowW: 0.8
};

function _mergeConfig(target, source) {
    if (!source) return target;
    for (let key in target) { if (source[key] !== undefined) target[key] = source[key]; }
    return target;
}

function adjustColor(hex, amt) {
    let col = hex.replace('#','');
    let r = parseInt(col.substring(0,2),16), g = parseInt(col.substring(2,4),16), b = parseInt(col.substring(4,6),16);
    r = Math.max(0, Math.min(255, r + amt)); g = Math.max(0, Math.min(255, g + amt)); b = Math.max(0, Math.min(255, b + amt));
    return `#${(r<<16 | g<<8 | b).toString(16).padStart(6,'0')}`;
}

let _charConfig = { ..._charConfigDefault };
const _weaponConfigDefault = { armLen: 22, armW: 4, tipSize: 8, tipShape: 0, cArm: '#94a3b8', cTip: '#e2e8f0' };
let _weaponConfig = { ..._weaponConfigDefault };

const _enemy1Default = { size: 12, color: '#ef4444', shape: 'circle', shadowAlpha: 0.3, cBody: '#ef4444' };
const _enemy2Default = { size: 18, color: '#b91c1c', shape: 'rect', shadowAlpha: 0.3, cBody: '#b91c1c' };
const _bossDefault = { ..._charConfigDefault, cBody: '#ef4444', cHead: '#7f1d1d', cEye: '#facc15' };

let _enemy1Config = { ..._enemy1Default };
let _enemy2Config = { ..._enemy2Default };
let _bossConfig = { ..._bossDefault };

// try {
//     const s1 = localStorage.getItem('lane_defense_enemy1_config');
//     if (s1) _mergeConfig(_enemy1Config, JSON.parse(s1));
//     const s2 = localStorage.getItem('lane_defense_enemy2_config');
//     if (s2) _mergeConfig(_enemy2Config, JSON.parse(s2));
//     const sb = localStorage.getItem('lane_defense_boss_config');
//     if (sb) _mergeConfig(_bossConfig, JSON.parse(sb));
// } catch(e) { }


// â˜…å‹•çš„ãƒ¬ãƒ¼ãƒ³æ•°ã®è¨­å®š
const LANE_HEIGHT = 80;
let currentRowCount = 1;
let player, enemies = [], particles = [], damageTexts = [];
let isWaveActive = false, enemiesToSpawn = 0, spawnTimer = 0, currentWaveMult = 1, lastTime = performance.now();
// ãƒ¬ãƒ¼ãƒ³ç™ºå…‰æ¼”å‡ºç”¨ï¼ˆå„ãƒ¬ãƒ¼ãƒ³ã®æ®‹ã‚Šç™ºå…‰æ™‚é–“ï¼‰ - è¼ã‘ï¼åƒ•ãŸã¡ã®ãƒ¬ãƒ¼ãƒ³ï¼
let laneGlow = [0, 0, 0, 0, 0];

function getLaneY(row, cvsHeight, rowCount) {
    const totalHeight = rowCount * LANE_HEIGHT;
    const startY = (cvsHeight / 2) - (totalHeight / 2) + (LANE_HEIGHT / 2);
    return startY + row * LANE_HEIGHT;
}

function getRowFromY(my, cvsHeight, rowCount) {
    const totalHeight = rowCount * LANE_HEIGHT;
    const startY = (cvsHeight / 2) - (totalHeight / 2);
    let row = Math.floor((my - startY) / LANE_HEIGHT);
    return Math.max(0, Math.min(rowCount - 1, row));
}

function determineAttack(combo, key, isPractice) {
    let ad = null, dmgMult = 1.0, skillName = null, skillColor = null;
    let resetCombo = false;
    let cd = 0;

    const u = GameState.unlocks;
    const hasC2 = isPractice || u.combo2;
    const hasC1 = isPractice || u.combo1;
    const hasSt = isPractice || u.strong;
    const hasW2 = isPractice || u.weak2;
    const hasW3 = isPractice || u.weak3;

    if (key === 'x') {
        if (combo === 'zzx' && hasC2) {
            // ã‚°ãƒ©ãƒ³ãƒ‰ã‚¯ãƒ­ã‚¹ã®ç¯„å›² ( /4 ã«ãªã£ã¦ã„ãŸã®ã‚’ä¿®æ­£ )
            const cRange = 150 + ((GameState.comboLevels.c2Rng - 1) * 30);
            ad = { type: 'wide', range: cRange, height: LANE_HEIGHT*3, color: 'rgba(250, 204, 21, 0.7)', maxDuration: 0.3, knockback: 10 };
            dmgMult = 1.2 + ((GameState.comboLevels.c2Dmg - 1) * 0.2);
            skillName = "ã‚°ãƒ©ãƒ³ãƒ‰ãƒ»ã‚¯ãƒ­ã‚¹"; skillColor = "from-yellow-300 to-orange-500";
            cd = 0.4;
        } else if (combo === 'zx' && hasC1) {
            const cRange = 250 + ((GameState.comboLevels.c1Rng - 1) * 60);
            ad = { type: 'pierce', range: cRange, height: 60, color: 'rgba(56, 189, 248, 0.7)', maxDuration: 0.2, knockback: 15 };
            dmgMult = 1.3 + ((GameState.comboLevels.c1Dmg - 1) * 0.25);
            skillName = "ãƒ”ã‚¢ã‚·ãƒ³ã‚°ãƒ»ãƒ¬ã‚¤"; skillColor = "from-cyan-400 to-blue-600";
            cd = 0.4;
        } else if (hasSt) {
            const cRange = 120 + ((GameState.comboLevels.sRng - 1) * 30);
            ad = { type: 'front-wide', range: cRange, height: LANE_HEIGHT*3, color: 'rgba(248, 113, 113, 0.6)', maxDuration: 0.3, knockback: 12 };
            dmgMult = 1.5 + ((GameState.comboLevels.sDmg - 1) * 0.2);
            skillName = "ãƒ¯ã‚¤ãƒ‰ãƒ»ã‚¹ã‚¦ã‚£ãƒ¼ãƒ—"; skillColor = "from-red-400 to-red-600";
            cd = 1.2; 
        }
        resetCombo = true;
    } else {
        if (combo === 'z') {
            ad = { type: 'normal', range: 100, height: 30, color: 'rgba(255, 255, 255, 0.5)', maxDuration: 0.1, knockback: 2 };
            dmgMult = 1.0;
            // 1æ’ƒç›®ã®ç¡¬ç›´ã‚’é‡ã‚(0.5s)ã«è¨­å®šã—ã€è§£æ”¾ã—ã¦ã„ãªã„ã¨ãã®é€£å°„ã‚’é˜²ã
            cd = 0.5;
        } else if (combo === 'zz' && hasW2) {
            ad = { type: 'normal', range: 110, height: 35, color: 'rgba(255, 255, 255, 0.6)', maxDuration: 0.1, knockback: 3 };
            dmgMult = 1.2;
            // 2æ’ƒç›®ã‚‚åŒæ§˜ã«å˜ç™ºã§æ­¢ã‚ãŸå ´åˆã¯ç¡¬ç›´(0.4s)ãŒæ®‹ã‚‹
            cd = 0.4;
        } else if (combo === 'zzz' && hasW3) {
            // 3æ’ƒç›®ã®ãƒ•ã‚£ãƒ‹ãƒƒã‚·ãƒ¥ã¯ç‰¹å¤§ãƒãƒƒã‚¯ãƒãƒƒã‚¯ã‚’æŒãŸã›ã€åæ’ƒã‚’å—ã‘ã¥ã‚‰ãã™ã‚‹
            ad = { type: 'normal', range: 140, height: 40, color: 'rgba(255, 255, 255, 0.9)', maxDuration: 0.15, knockback: 25 };
            dmgMult = 1.6;
            cd = 0.6; 
            // ãƒ•ã‚£ãƒ‹ãƒƒã‚·ãƒ¥å¾Œã¯å¼·åˆ¶ãƒªã‚»ãƒƒãƒˆï¼ˆå¼·æ”»æ’ƒæ´¾ç”Ÿã¯ã•ã›ãªã„ï¼‰
            resetCombo = true;
        } else {
            ad = { type: 'normal', range: 100, height: 30, color: 'rgba(255, 255, 255, 0.5)', maxDuration: 0.1, knockback: 2 };
            dmgMult = 1.0;
            resetCombo = 'z'; 
            cd = 0.4;
        }
    }
    return { ad, dmgMult, skillName, skillColor, resetCombo, cd };
}

// â”€â”€ Minecraftå‹ éšå±¤æç”»ãƒ˜ãƒ«ãƒ‘ãƒ¼ (å…±é€š) â”€â”€
function _drawLimb(ctx, px, py, angle, isArm, isBack, attackType, ap, C, W) {
    const s = C.scale;
    ctx.save();
    ctx.translate(px, py);
    let targetAngle = angle;
    if (isArm && !isBack && attackType) {
        if (attackType === 'normal' || attackType === 'wide') targetAngle = -1.5 + ap * 2.5; 
        else if (attackType === 'front-wide') targetAngle = -1.2 + ap * 3;
        else if (attackType === 'pierce') targetAngle = 0;
    }
    ctx.rotate(targetAngle);
    if (isBack) ctx.globalAlpha = 0.6;

    const baseCol = isArm ? C.cArms : C.cLegs;
    const grad = ctx.createLinearGradient(0, 0, 0, 20*s);
    grad.addColorStop(0, baseCol); grad.addColorStop(1, adjustColor(baseCol, -20));
    ctx.fillStyle = grad;

    const uw = (isArm ? C.upperArmW : C.upperLegW) * s, ul = (isArm ? C.upperArmLen : C.upperLegLen) * s;
    ctx.fillRect(-uw/2, 0, uw, ul);
    ctx.translate(0, ul);
    let jointAngle = (isArm ? C.elbowAngle : C.kneeAngle) + Math.abs(angle) * 0.5;
    ctx.rotate(jointAngle);

    const lw = (isArm ? C.lowerArmW : C.lowerLegW) * s, ll = (isArm ? C.lowerArmLen : C.lowerLegLen) * s;
    ctx.fillRect(-lw/2, 0, lw, ll);

    if (isArm && !isBack && W) {
        ctx.translate(0, ll);
        const wLen = W.armLen * s;
        const wGrad = ctx.createLinearGradient(0, 0, W.armW*s, 0);
        wGrad.addColorStop(0, W.cArm); wGrad.addColorStop(0.5, adjustColor(W.cArm, 40)); wGrad.addColorStop(1, W.cArm);
        ctx.fillStyle = wGrad;
        ctx.fillRect(-W.armW/2 * s, 0, W.armW * s, wLen);
        ctx.translate(0, wLen);
        ctx.fillStyle = W.cTip;
        if (W.tipShape === 0) ctx.fillRect(-W.tipSize*s/2, -W.tipSize*s/2, W.tipSize*s, W.tipSize*s);
        else if (W.tipShape === 1) { ctx.beginPath(); ctx.arc(0,0,W.tipSize*s/2,0,Math.PI*2); ctx.fill(); }
        else { ctx.beginPath(); ctx.moveTo(0,W.tipSize*s/2); ctx.lineTo(-W.tipSize*s/2,-W.tipSize*s/2); ctx.lineTo(W.tipSize*s/2,-W.tipSize*s/2); ctx.fill(); }
    }
    ctx.restore();
}

// --- ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ ---
class Player {
    constructor() {
        this.row = Math.floor(currentRowCount / 2); 
        this.facing = 1; this.size = 24; this.color = '#3b82f6';
        this.comboHistory = []; this.comboTimer = 0; this.attackCooldown = 0; this.lastMaxCooldown = 0;
        this.isAttacking = false; this.attackData = null;
    }
    move(dirRow) { if (!this.isAttacking) this.row = Math.max(0, Math.min(currentRowCount - 1, this.row + dirRow)); }
    turn(dir) { if (!this.isAttacking) this.facing = dir; }
    update(dt, onComboReset) {
        if (this.attackCooldown > 0) this.attackCooldown -= dt;
        if (this.comboTimer > 0) {
            this.comboTimer -= dt;
            if (this.comboTimer <= 0) { this.comboHistory = []; if(onComboReset) onComboReset(); }
        }
        if (this.isAttacking && this.attackData) {
            this.attackData.duration -= dt;
            if (this.attackData.duration <= 0) this.isAttacking = false;
        }
    }
    draw(ctx, w, h) {
        const x = w / 2, y = getLaneY(this.row, h, currentRowCount);
        const C = _charConfig, s = C.scale, fx = this.facing;
        const time = performance.now();
        
        ctx.save();
        ctx.translate(x, y);
        if (fx === -1) ctx.scale(-1, 1);

        // ãƒ¢ãƒ¼ã‚·ãƒ§ãƒ³è¨ˆç®—
        let ap = 0, at = null, walkCycle = 0, bounce = 0, breath = 0, walkShiftX = 0;
        if (this.isAttacking && this.attackData) {
            at = this.attackData.type;
            const rawP = 1 - (this.attackCooldown / this.lastMaxCooldown);
            if (rawP < 0.4) ap = rawP * 0.5;
            else if (rawP < 0.6) ap = 0.2 + (rawP - 0.4) * 3.5;
            else ap = 0.9 + (rawP - 0.6) * 0.25;
            walkShiftX = Math.sin(rawP * Math.PI) * 15 * s;
        }

        if (isWaveActive && !this.isAttacking) {
            const phase = (time * C.walkSpeed/1000 * 1.2) % (Math.PI * 2);
            walkCycle = Math.sin(phase) * 0.8;
            bounce = Math.abs(Math.sin(phase)) * 4 * s;
        } else if (!this.isAttacking) {
            // å¾…æ©Ÿ: è†ã‚’è½ã¨ã—ã¦æ§‹ãˆãªãŒã‚‰å‘¼å¸ï¼ˆæµ®éŠã§ã¯ãªãåœ°ã«è¶³ã®ã¤ã„ãŸæ§‹ãˆï¼‰
            const idlePhase = time / C.breathSpeed;
            breath = Math.sin(idlePhase) * 0.8 * s;
            bounce = -(2 + Math.sin(idlePhase) * 1.5) * s;
        }
        ctx.translate(walkShiftX, 0);

        // å½±
        ctx.fillStyle = `rgba(0,0,0,${C.shadowAlpha})`;
        ctx.beginPath(); ctx.ellipse(0, C.torsoH*s + 4 - bounce, 20*s, 4*s, 0, 0, Math.PI*2); ctx.fill();

        // èƒ´ä½“
        ctx.save();
        ctx.translate(0, bounce);
        const bodyGrad = ctx.createLinearGradient(-C.torsoW/2*s, 0, C.torsoW/2*s, 0);
        bodyGrad.addColorStop(0, adjustColor(C.cBody,-15)); bodyGrad.addColorStop(0.5,C.cBody); bodyGrad.addColorStop(1,adjustColor(C.cBody,-25));
        ctx.fillStyle = bodyGrad;
        const tx = -C.torsoW/2*s, ty = -C.torsoH/2*s + breath, tw = C.torsoW*s, th = C.torsoH*s;
        ctx.fillRect(tx, ty, tw, th);
        ctx.strokeStyle = 'rgba(255,255,255,0.1)'; ctx.strokeRect(tx+1*s, ty+1*s, tw-2*s, th-2*s);

        // é ­éƒ¨
        ctx.save();
        ctx.translate(0, ty); ctx.rotate(walkCycle * 0.1);
        const headGrad = ctx.createLinearGradient(0, -C.headH*s, 0, 0);
        headGrad.addColorStop(0, adjustColor(C.cHead,10)); headGrad.addColorStop(1,C.cHead);
        ctx.fillStyle = headGrad;
        const hx = -C.headW/2*s, hy = -C.headH*s, hw = C.headW*s, hh = C.headH*s;
        ctx.fillRect(hx, hy, hw, hh);
        ctx.fillStyle = C.cEye; ctx.fillRect(C.headW/2*s - 7*s, hy+6*s, 6*s, 2*s);
        ctx.fillStyle = 'rgba(255,255,255,0.7)'; ctx.fillRect(C.headW/2*s - 6*s, hy+6.5*s, 1.5*s, 0.5*s);
        ctx.restore();

        _drawLimb(ctx, -C.shoulderX*s, C.shoulderY*s + breath + bounce, -walkCycle, true, true, at, ap, C, _weaponConfig);
        _drawLimb(ctx, -C.hipX*s, C.hipY*s + breath + bounce, walkCycle, false, true, null, 0, C);
        _drawLimb(ctx, C.shoulderX*s, C.shoulderY*s + breath + bounce, walkCycle, true, false, at, ap, C, _weaponConfig);
        _drawLimb(ctx, C.hipX*s, C.hipY*s + breath + bounce, -walkCycle, false, false, null, 0, C);

        if (this.isAttacking && at === 'wide' && this.comboHistory.join('') === 'zzx') {
            const glow = 20 * s, size = glow * (1 + Math.sin(time*0.05)*0.2) * ap * 3.5;
            ctx.save(); ctx.translate(70*s*ap, -35*s); ctx.rotate(time*0.03);
            ctx.shadowBlur=15; ctx.shadowColor='#fbbf24'; ctx.fillStyle='rgba(251,191,36,0.4)'; ctx.fillRect(-size/2,-8*s,size,16*s); ctx.fillRect(-8*s,-size/2,16*s,size);
            ctx.shadowBlur=8; ctx.shadowColor='#fff'; ctx.fillStyle='rgba(255,255,255,0.9)'; ctx.fillRect(-size/2,-2.5*s,size,5*s); ctx.fillRect(-2.5*s,-size/2,5*s,size);
            ctx.restore();
        }
        ctx.restore();

        if (this.isAttacking && this.attackData) {
            const ad = this.attackData;
            ctx.save();
            ctx.globalAlpha = Math.max(0, ad.duration / ad.maxDuration) * 0.7;
            const fx = this.facing;
            const t = 1 - (ad.duration / ad.maxDuration);
            
            if (ad.type === 'normal') {
                // ç›´ç·šçš„ãªæ–œæ’ƒã‚¨ãƒ•ã‚§ã‚¯ãƒˆï¼ˆãƒªãƒ¼ãƒç¯„å›²ã‚’æ˜ç¤ºï¼‰
                ctx.save();
                const slashLen = (ad.w || ad.range) * Math.min(1, t * 3);
                const fadeAlpha = Math.max(0, 1 - t * 1.5);
                // ãƒ¡ã‚¤ãƒ³æ–¬æ’ƒãƒ©ã‚¤ãƒ³
                ctx.strokeStyle = '#34d399';
                ctx.shadowColor = '#10b981';
                ctx.shadowBlur = 15;
                ctx.lineWidth = Math.max(2, 10 * (1 - t));
                ctx.globalAlpha = fadeAlpha * 0.8;
                ctx.beginPath();
                ctx.moveTo(x + (16 * fx), y);
                ctx.lineTo(x + (16 * fx) + (slashLen * fx), y);
                ctx.stroke();
                // æ–¬æ’ƒã®å…ˆç«¯ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
                if (t > 0.1 && t < 0.8) {
                    ctx.fillStyle = 'rgba(52, 211, 153, 0.5)';
                    ctx.beginPath();
                    ctx.arc(x + (16 * fx) + (slashLen * fx), y, 6 * (1 - t), 0, Math.PI * 2);
                    ctx.fill();
                }
                ctx.restore();
            } else if (ad.type === 'pierce') {
                ctx.fillStyle = '#10b981';
                ctx.fillRect(x + (16 * fx), y - ad.height/2, ad.range * fx, ad.height);
                ctx.fillStyle = '#fff';
                ctx.fillRect(x + (16 * fx), y - 2, ad.range * fx, 4);
            } else if (ad.type === 'wide' || ad.type === 'front-wide') {
                // ãƒ¯ã‚¤ãƒ‰ç³»æ”»æ’ƒã®ã‚¨ãƒ•ã‚§ã‚¯ãƒˆæç”»ã‚‚å‹•çš„ãƒ¬ãƒ¼ãƒ³ã«å¯¾å¿œ
                const minRow = Math.max(0, this.row - 1);
                const maxRow = Math.min(currentRowCount - 1, this.row + 1);
                const topY = getLaneY(minRow, h, currentRowCount);
                const bottomY = getLaneY(maxRow, h, currentRowCount);
                const rectH = (bottomY - topY) + Math.min(h/currentRowCount, 100);
                
            if (ad.type === 'wide') {
                const glow = 30 * s, size = glow * (1 + Math.sin(time*0.05)*0.2) * (1 - ad.duration/ad.maxDuration) * 4;
                ctx.save(); ctx.translate(x + 60*s*fx, y - 10*s);
                ctx.shadowBlur=20; ctx.shadowColor='#fbbf24'; ctx.fillStyle='rgba(251,191,36,0.5)'; ctx.fillRect(-size/2,-12*s,size,24*s); ctx.fillRect(-12*s,-size/2,24*s,size);
                ctx.shadowBlur=10; ctx.shadowColor='#fff'; ctx.fillStyle='rgba(255,255,255,0.9)'; ctx.fillRect(-size/2,-4*s,size,8*s); ctx.fillRect(-4*s,-size/2,8*s,size);
                ctx.restore();
            } else if (ad.type === 'front-wide') {
                ctx.fillStyle = 'rgba(248, 113, 113, 0.4)';
                ctx.save(); ctx.translate(x, y); if (fx === -1) ctx.scale(-1, 1);
                ctx.beginPath(); ctx.arc(10, 0, ad.range, -Math.PI/1.5, Math.PI/1.5, false); ctx.lineTo(10, 0); ctx.fill();
                ctx.restore();
            }
            }
            ctx.restore();
        }

        // ç¡¬ç›´ã‚²ãƒ¼ã‚¸
        if (this.attackCooldown > 0 && this.lastMaxCooldown > 0) {
            const ratio = Math.max(0, this.attackCooldown / this.lastMaxCooldown);
            const barW = 40;
            ctx.fillStyle = 'rgba(0,0,0,0.7)';
            ctx.fillRect(x - barW/2, y + 25, barW, 6);
            ctx.fillStyle = this.attackCooldown > 0.4 ? 'rgba(255, 100, 100, 0.9)' : 'rgba(255, 200, 0, 0.9)';
            ctx.fillRect(x - barW/2, y + 25, barW * ratio, 6);
        }
        
        ctx.restore();
    }
}

class Enemy {
    constructor(row, side, waveMult, isTough) {
        this.row = row; this.side = side; this.size = isTough ? 18 : 12;
        this.speed = (isTough ? 30 : 45 + Math.random() * 20) * (1 + (waveMult - 1) * 0.2);
        this.x = 0; 
        this.y = 0; 
        this.maxHp = (isTough ? 60 : 20) * waveMult; this.hp = this.maxHp;
        this.color = isTough ? '#b91c1c' : '#ef4444';
        this.damage = (isTough ? 20 : 10) * waveMult;
        this.value = Math.max(1, Math.floor((isTough ? 7.5 : 1.5) * Math.sqrt(waveMult))); 
        this.knockback = 0;
    }
    update(dt, w) {
        const cx = w / 2;
        if (this.knockback > 0) {
            this.x -= this.side * this.knockback * dt * 10;
            this.knockback -= dt * 20;
        } else {
            this.x += this.side * this.speed * dt;
            if (this.side === 1 && this.x > cx - 35) this.x = cx - 35;
            if (this.side === -1 && this.x < cx + 35) this.x = cx + 35;
        }
    }
    draw(ctx, w, h) {
        const time = performance.now();
        const x = this.x, y = this.y;
        const isBoss = (this.maxHp >= 200); 

        if (isBoss) {
            const C = _bossConfig, s = C.scale;
            const fx = this.side === -1 ? 1 : -1;
            const phase = (time * C.walkSpeed/1000 * 1.2) % (Math.PI * 2);
            const walkCycle = Math.sin(phase) * 0.8;
            const bounce = Math.abs(Math.sin(phase)) * 4 * s;
            const breath = Math.sin(time / C.breathSpeed) * 1.5 * s;

            ctx.save();
            ctx.translate(x, y);
            if (fx === -1) ctx.scale(-1, 1);

            // å½±
            ctx.fillStyle = `rgba(0,0,0,${C.shadowAlpha})`;
            ctx.beginPath(); ctx.ellipse(0, C.torsoH*s + 4 - bounce, 25*s, 5*s, 0, 0, Math.PI*2); ctx.fill();

            // èƒ´ä½“
            ctx.save();
            ctx.translate(0, bounce);
            const bodyGrad = ctx.createLinearGradient(-C.torsoW/2*s, 0, C.torsoW/2*s, 0);
            bodyGrad.addColorStop(0, adjustColor(C.cBody,-15)); bodyGrad.addColorStop(0.5,C.cBody); bodyGrad.addColorStop(1,adjustColor(C.cBody,-25));
            ctx.fillStyle = bodyGrad;
            const tx = -C.torsoW/2*s, ty = -C.torsoH/2*s + breath, tw = C.torsoW*s, th = C.torsoH*s;
            ctx.fillRect(tx, ty, tw, th);
            ctx.strokeStyle = 'rgba(255,255,255,0.1)'; ctx.strokeRect(tx+1*s, ty+1*s, tw-2*s, th-2*s);

            // é ­
            ctx.save(); ctx.translate(0, ty); ctx.rotate(walkCycle * 0.1);
            const headGrad = ctx.createLinearGradient(0, -C.headH*s, 0, 0);
            headGrad.addColorStop(0, adjustColor(C.cHead,10)); headGrad.addColorStop(1,C.cHead);
            ctx.fillStyle = headGrad;
            const hx = -C.headW/2*s, hy = -C.headH*s, hw = C.headW*s, hh = C.headH*s;
            ctx.fillRect(hx, hy, hw, hh);
            ctx.fillStyle = C.cEye; ctx.fillRect(C.headW/2*s - 7*s, hy+6*s, 6*s, 2*s);
            ctx.restore();

            _drawLimb(ctx, -C.shoulderX*s, C.shoulderY*s + breath + bounce, -walkCycle, true, true, null, 0, C);
            _drawLimb(ctx, -C.hipX*s, C.hipY*s + breath + bounce, walkCycle, false, true, null, 0, C);
            _drawLimb(ctx, C.shoulderX*s, C.shoulderY*s + breath + bounce, walkCycle, true, false, null, 0, C);
            _drawLimb(ctx, C.hipX*s, C.hipY*s + breath + bounce, -walkCycle, false, false, null, 0, C);
            ctx.restore();
            ctx.restore();

        } else if (this.maxHp >= 60) {
            // å¤§å‹æ•µ (Rectangle Rich)
            const s = this.size;
            const phase = time * 0.01;
            const walkCycle = Math.sin(phase) * 5;
            const breath = Math.sin(time * 0.005) * 2;

            ctx.save();
            ctx.translate(x, y + walkCycle);
            if (this.side === -1) ctx.scale(-1, 1);

            ctx.fillStyle = 'rgba(0,0,0,0.3)';
            ctx.beginPath(); ctx.ellipse(0, s + 10 - walkCycle, s * 0.8, 4, 0, 0, Math.PI * 2); ctx.fill();

            const grad = ctx.createLinearGradient(-s, -s, s, s);
            grad.addColorStop(0, adjustColor(this.color, 20)); grad.addColorStop(1, adjustColor(this.color, -20));
            ctx.fillStyle = grad;
            ctx.fillRect(-s, -s + breath, s * 2, s * 2);
            ctx.strokeStyle = 'rgba(0,0,0,0.2)'; ctx.lineWidth = 1.5; ctx.strokeRect(-s, -s + breath, s * 2, s * 2);

            ctx.fillStyle = adjustColor(this.color, -40);
            ctx.beginPath(); ctx.moveTo(-s, -s + breath); ctx.lineTo(-s-6, -s-12 + breath); ctx.lineTo(-s+10, -s + breath); ctx.fill();
            ctx.beginPath(); ctx.moveTo(s, -s + breath); ctx.lineTo(s+6, -s-12 + breath); ctx.lineTo(s-10, -s + breath); ctx.fill();

            ctx.fillStyle = '#fff';
            ctx.fillRect(s - 12, -s + 6 + breath, 6, 6);
            ctx.restore();

        } else {
            // é€šå¸¸æ•µ (Circle Rich)
            const s = this.size;
            const bounce = Math.abs(Math.sin(time * 0.01)) * 8;
            const squash = 1 + Math.sin(time * 0.01) * 0.1;

            ctx.save();
            ctx.translate(x, y - bounce);
            if (this.side === -1) ctx.scale(-1, 1);

            ctx.fillStyle = 'rgba(0,0,0,0.3)';
            ctx.beginPath(); ctx.ellipse(0, s + bounce, s * 0.8 / squash, 4, 0, 0, Math.PI * 2); ctx.fill();

            const grad = ctx.createRadialGradient(-s*0.3, -s*0.3, s*0.1, 0, 0, s);
            grad.addColorStop(0, adjustColor(this.color, 40)); grad.addColorStop(1, this.color);
            ctx.fillStyle = grad;
            ctx.beginPath(); ctx.arc(0, 0, s * squash, 0, Math.PI * 2); ctx.fill();
            ctx.strokeStyle = 'rgba(0,0,0,0.2)'; ctx.lineWidth = 1.5; ctx.stroke();

            ctx.fillStyle = '#fff';
            ctx.beginPath(); ctx.arc(s * 0.4, -s * 0.2, s * 0.3, 0, Math.PI * 2); ctx.fill();
            ctx.fillStyle = '#000';
            ctx.beginPath(); ctx.arc(s * 0.5, -s * 0.2, s * 0.15, 0, Math.PI * 2); ctx.fill();
            ctx.restore();
        }

        if (this.hp < this.maxHp) {
            ctx.fillStyle = 'rgba(255,0,0,0.5)'; ctx.fillRect(x - 15, y - this.size - 30, 30, 4);
            ctx.fillStyle = '#4ade80'; ctx.fillRect(x - 15, y - this.size - 30, 30 * (this.hp / this.maxHp), 4);
        }
    }
}

class Particle {
    constructor(x, y, vx, vy, life, color, size) { this.x=x; this.y=y; this.vx=vx; this.vy=vy; this.maxLife=life; this.life=life; this.color=color; this.size=size; }
    update(dt) { this.x+=this.vx*dt; this.y+=this.vy*dt; this.life-=dt; }
    draw(ctx) { ctx.fillStyle=this.color; ctx.globalAlpha=Math.max(0,this.life/this.maxLife); ctx.beginPath(); ctx.arc(this.x,this.y,this.size,0,Math.PI*2); ctx.fill(); ctx.globalAlpha=1.0; }
}

class DamageText {
    constructor(x, y, text, isCritical) {
        this.x = x + (Math.random() * 20 - 10); this.y = y - 10;
        this.text = Math.floor(text).toString();
        this.life = 0.8; this.maxLife = 0.8; this.vy = -40; this.isCritical = isCritical;
    }
    update(dt) { this.y += this.vy * dt; this.life -= dt; }
    draw(ctx) {
        ctx.save(); ctx.globalAlpha = Math.max(0, this.life / this.maxLife);
        ctx.font = this.isCritical ? "900 24px sans-serif" : "bold 16px sans-serif";
        ctx.fillStyle = this.isCritical ? "#fbbf24" : "#ffffff"; ctx.textAlign = "center";
        ctx.strokeStyle = "#000000"; ctx.lineWidth = this.isCritical ? 4 : 3;
        ctx.strokeText(this.text, this.x, this.y); ctx.fillText(this.text, this.x, this.y); ctx.restore();
    }
}


// === æ“ä½œãƒãƒ³ãƒ‰ãƒ© ===
function triggerAction(key, isPractice) {
    if (key === 'z') GameState.stats.zCount++;
    if (key === 'x') GameState.stats.xCount++;

    if (isPractice) {
        doPlayerAction(pPlayer, key, true);
    } else if (isWaveActive) {
        doPlayerAction(player, key, false);
    }
    checkAchievements();
}

window.tryMove = function(dir) {
    if (screens['battle'].classList.contains('active') && isWaveActive) player.move(dir);
    else if (screens['base'].classList.contains('active')) {
        const isPracTab = !document.getElementById('tab-base-home').classList.contains('hidden') || !document.getElementById('tab-status').classList.contains('hidden');
        if (isPracTab) pPlayer.move(dir);
    }
};
window.tryTurn = function(dir) {
    if (screens['battle'].classList.contains('active') && isWaveActive) player.turn(dir);
    else if (screens['base'].classList.contains('active')) {
        const isPracTab = !document.getElementById('tab-base-home').classList.contains('hidden') || !document.getElementById('tab-status').classList.contains('hidden');
        if (isPracTab) pPlayer.turn(dir);
    }
};

window.addEventListener('keydown', e => {
    const k = e.key.toLowerCase();
    let btnId = null;
    const isBaseHomeVisible = !document.getElementById('tab-base-home').classList.contains('hidden');
    const isStatusVisible = !document.getElementById('tab-status').classList.contains('hidden');
    let isPrac = screens['base'].classList.contains('active') && (isBaseHomeVisible || isStatusVisible);
    let isBat = screens['battle'].classList.contains('active') && isWaveActive;
    if (!isPrac && !isBat) return;

    if (k === 'w' || e.key === 'ArrowUp') { window.tryMove(-1); btnId = 'vbtn-up'; }
    if (k === 's' || e.key === 'ArrowDown') { window.tryMove(1); btnId = 'vbtn-down'; }
    if (k === 'a' || e.key === 'ArrowLeft') { window.tryTurn(-1); btnId = 'vbtn-left'; }
    if (k === 'd' || e.key === 'ArrowRight') { window.tryTurn(1); btnId = 'vbtn-right'; }
    
    if (k === 'z' || k === 'j') { triggerAction('z', isPrac); btnId = 'vbtn-z'; }
    if (k === 'x' || k === 'k') { triggerAction('x', isPrac); btnId = 'vbtn-x'; }

    if (btnId && isBat) {
        const btn = document.getElementById(btnId);
        if (btn) btn.classList.add('key-active');
    }
});

window.addEventListener('keyup', e => {
    const k = e.key.toLowerCase();
    let btnId = null;
    if (k === 'w' || e.key === 'ArrowUp') btnId = 'vbtn-up';
    if (k === 's' || e.key === 'ArrowDown') btnId = 'vbtn-down';
    if (k === 'a' || e.key === 'ArrowLeft') btnId = 'vbtn-left';
    if (k === 'd' || e.key === 'ArrowRight') btnId = 'vbtn-right';
    if (k === 'z' || k === 'j') btnId = 'vbtn-z';
    if (k === 'x' || k === 'k') btnId = 'vbtn-x';

    if (btnId && screens['battle'].classList.contains('active')) {
        const btn = document.getElementById(btnId);
        if (btn) btn.classList.remove('key-active');
    }
});

let touchStartX = 0;
let touchStartY = 0;
let touchStartTime = 0;

function handleTouchStart(e, isPractice) {
    if (isPractice) {
        const isBaseHomeVisible = !document.getElementById('tab-base-home').classList.contains('hidden');
        const isStatusVisible = !document.getElementById('tab-status').classList.contains('hidden');
        if (!screens['base'].classList.contains('active') || (!isBaseHomeVisible && !isStatusVisible)) {
            return;
        }
    } else {
        if (!isWaveActive || !player || player.isAttacking) {
            return;
        }
    }
    
    // UIä¸Šã®ã‚¿ãƒƒãƒ—ã¯ç„¡è¦–
    if (e.target.tagName === 'BUTTON' || e.target.closest('.overlay-ui')) return;
    
    // e.preventDefault();
    const clientX = e.touches ? e.changedTouches[0].clientX : e.clientX;
    const clientY = e.touches ? e.changedTouches[0].clientY : e.clientY;

    touchStartX = clientX;
    touchStartY = clientY;
    touchStartTime = performance.now();
}

function handleTouchMove(e) {
    // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ç­‰ã®ç„¡åŠ¹åŒ–ï¼ˆãƒã‚¦ã‚¹ãƒ»ã‚¿ãƒƒãƒå…±é€šï¼‰
    if(e.cancelable) e.preventDefault();
}

function handleTouchEnd(e, targetPlayer, cvs, isPractice) {
    if (!targetPlayer) return;
    if (e.target.tagName === 'BUTTON' || e.target.closest('.overlay-ui')) return;
    // e.preventDefault();
    
    // ãƒã‚¦ã‚¹ã®å ´åˆã¯å·¦ã‚¯ãƒªãƒƒã‚¯ä»¥å¤–ã¯ã‚¹ãƒ«ãƒ¼
    if (!e.touches && e.button !== 0) return;

    const clientX = e.touches ? e.changedTouches[0].clientX : e.clientX;
    const clientY = e.touches ? e.changedTouches[0].clientY : e.clientY;

    const dx = clientX - touchStartX;
    const dy = clientY - touchStartY;
    const dt = performance.now() - touchStartTime;

    const rect = cvs.getBoundingClientRect();
    const cx = cvs.width / 2;
    const my = touchStartY - rect.top; // ã‚¿ãƒƒãƒ—ã—ãŸYåº§æ¨™ã‹ã‚‰ãƒ¬ãƒ¼ãƒ³ã‚’è¨ˆç®—

    // ã‚¹ãƒ¯ã‚¤ãƒ—åˆ¤å®š (è·é›¢ã¨æ™‚é–“)
    const dist = Math.sqrt(dx * dx + dy * dy);
    
    if (dist < 30 || dt > 300) {
        // --- ã‚¿ãƒƒãƒ— (å¼±æ”»æ’ƒ & æ¥æ•µ) ---
        targetPlayer.turn((touchStartX - rect.left) < cx ? -1 : 1);
        targetPlayer.row = getRowFromY(my, cvs.height, currentRowCount);
        triggerAction('z', isPractice);
    } else {
        // --- ãƒ•ãƒªãƒƒã‚¯ (å¼·æ”»æ’ƒ / æ´¾ç”Ÿ) ---
        targetPlayer.turn((touchStartX - rect.left) < cx ? -1 : 1);
        triggerAction('x', isPractice);
    }
}

// Touch Events
canvas.addEventListener('touchstart', e => handleTouchStart(e, false), {passive: false});
canvas.addEventListener('touchmove', handleTouchMove, {passive: false});
canvas.addEventListener('touchend', e => handleTouchEnd(e, player, canvas, false), {passive: false});

pCanvas.addEventListener('touchstart', e => handleTouchStart(e, true), {passive: false});
pCanvas.addEventListener('touchmove', handleTouchMove, {passive: false});
pCanvas.addEventListener('touchend', e => handleTouchEnd(e, pPlayer, pCanvas, true), {passive: false});

// Mouse Events
canvas.addEventListener('mousedown', e => handleTouchStart(e, false));
canvas.addEventListener('mousemove', handleTouchMove);
canvas.addEventListener('mouseup', e => handleTouchEnd(e, player, canvas, false));

pCanvas.addEventListener('mousedown', e => handleTouchStart(e, true));
pCanvas.addEventListener('mousemove', handleTouchMove);
pCanvas.addEventListener('mouseup', e => handleTouchEnd(e, pPlayer, pCanvas, true));


// === ãƒ­ã‚¸ãƒƒã‚¯ã‚³ã‚¢ ===
function doPlayerAction(targetPlayer, key, isPractice) {
    // æ´¾ç”Ÿå…ˆãŒã‚¢ãƒ³ãƒ­ãƒƒã‚¯ã•ã‚Œã¦ã„ã‚‹ã‹ã€é©åˆ‡ãªç¡¬ç›´ãƒªã‚­ãƒ£ã‚¹ãƒˆæ™‚é–“ã‚’çµŒéã—ã¦ã„ã‚‹ã‹ã®ãƒã‚§ãƒƒã‚¯
    let isValidCancel = false;
    const isComboWindow = targetPlayer.comboTimer > 0 && targetPlayer.comboHistory.length > 0;
    
    // æ”»æ’ƒãƒ¢ãƒ¼ã‚·ãƒ§ãƒ³ã®ç¡¬ç›´ãŒã€ŒåŠåˆ†ï¼ˆ50%ï¼‰ã€çµŒéã™ã‚‹ã¾ã§ã¯ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã›ãªã„
    const isAnimPastCancelPoint = targetPlayer.attackCooldown <= (targetPlayer.lastMaxCooldown * 0.5);

    if (isComboWindow && isAnimPastCancelPoint) {
        const currentCombo = targetPlayer.comboHistory.join('');
        const u = GameState.unlocks;
        
        if (currentCombo === 'z') {
            if (key === 'z' && (isPractice || u.weak2)) isValidCancel = true;
            if (key === 'x' && (isPractice || u.combo1)) isValidCancel = true;
        } else if (currentCombo === 'zz') {
            if (key === 'z' && (isPractice || u.weak3)) isValidCancel = true;
            if (key === 'x' && (isPractice || u.combo2)) isValidCancel = true;
        }
    }
                           
    if (targetPlayer.attackCooldown > 0 && !isValidCancel) return;
    
    // æ”»æ’ƒé–‹å§‹ã«ã¤ãã€æ—¢å­˜ã®ãƒ¢ãƒ¼ã‚·ãƒ§ãƒ³ã‚„ç¡¬ç›´ã‚’å¼·åˆ¶ã‚¯ãƒªã‚¢
    if (isValidCancel) {
        targetPlayer.attackCooldown = 0;
        targetPlayer.isAttacking = false;
    }

    if (!isPractice && GameState.unlocks.autoAim) {
        let cx = canvas.width / 2;
        let threat = enemies.find(e => e.row === targetPlayer.row && Math.abs(e.x - cx) <= 50);
        if (threat) targetPlayer.turn(threat.x < cx ? -1 : 1);
    }

    targetPlayer.comboHistory.push(key);
    targetPlayer.comboTimer = 1.0;
    const combo = targetPlayer.comboHistory.join('');
    
    const atkDef = determineAttack(combo, key, isPractice);

    if (atkDef.resetCombo === true) targetPlayer.comboHistory = [];
    else if (atkDef.resetCombo === 'z') targetPlayer.comboHistory = ['z'];
    
    if (atkDef.ad) { 
        targetPlayer.attackCooldown = atkDef.cd;
        targetPlayer.lastMaxCooldown = atkDef.cd;
    }

    updateComboGuideUI(targetPlayer.comboHistory, isPractice, key);
    if (atkDef.skillName) showSkillAnim(atkDef.skillName, atkDef.skillColor, isPractice);

    if (atkDef.ad) {
        executeHitCheck(targetPlayer, atkDef.ad, atkDef.dmgMult, isPractice);
    }
}

function updateComboGuideUI(history, isPractice, lastKey = null) {
    const guideId = isPractice ? 'prac-guide-container' : 'battle-guide-container';
    const guideEl = document.getElementById(guideId);
    if (!guideEl) return;
    
    const comboStr = history.join('');
    let zText = "", zColor = "bg-blue-600", zDisabled = false;
    let xText = "", xColor = "bg-red-600", xDisabled = false;

    const u = GameState.unlocks;
    const hasC2 = isPractice || u.combo2;
    const hasC1 = isPractice || u.combo1;
    const hasSt = isPractice || u.strong;
    const hasW2 = isPractice || u.weak2;
    const hasW3 = isPractice || u.weak3;

    // === ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆãªã‚³ãƒ³ãƒœã‚¬ã‚¤ãƒ‰ã®ç”Ÿæˆ ===
    // ãƒãƒ¼ãƒ‰ã®å®šç¾©: id, label, isStrong, reqInfo
    const comboTree = {
        'root': { label: 'å¾…æ©Ÿ', children: ['z', 'x'] },
        'z': { label: 'å¼±1æ®µç›®', isStrong: false, children: ['zz', 'zx'] },
        'x': { label: 'ãƒ¯ã‚¤ãƒ‰ãƒ»S', isStrong: true, reqInfo: hasSt },
        'zz': { label: 'å¼±2æ®µç›®', isStrong: false, reqInfo: hasW2, children: ['zzz', 'zzx'] },
        'zx': { label: 'ãƒ”ã‚¢ã‚·ãƒ³ã‚°ãƒ»R', isStrong: true, reqInfo: hasC1 },
        'zzz': { label: 'å¼±3æ®µç›®', isStrong: false, reqInfo: hasW3 },
        'zzx': { label: 'Gãƒ»ã‚¯ãƒ­ã‚¹', isStrong: true, reqInfo: hasC2 }
    };

    const currentState = comboStr || 'root';

    // ç¡¬ç›´ä¸­ãƒã‚§ãƒƒã‚¯
    if (!comboTree[currentState]) {
       guideEl.innerHTML = `<div class="text-gray-400 text-xs font-bold py-1 px-4 text-center">--- ç¡¬ç›´ä¸­ ---</div>`;
       return;
    }

    // ç¾åœ¨ã®ãƒãƒ¼ãƒ‰ã¨ã€æ¬¡ã«æ´¾ç”Ÿå¯èƒ½ãªãƒãƒ¼ãƒ‰ã‚’å–å¾—
    const currentNode = comboTree[currentState];
    const nextIds = currentNode.children || [];

    // ãƒãƒ¼ãƒ‰ã‚’æç”»ã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
    function renderNode(id, isCurrent) {
        if (id === 'root') {
            return `<div class="relative flex items-center justify-center p-1 rounded border text-[10px] font-bold min-w-[60px] bg-gray-600 border-gray-500 text-white whitespace-nowrap overflow-hidden">
                å¾…æ©Ÿ
                <div class="absolute bottom-0 left-0 h-1 bg-green-400 transition-all duration-75" id="ui-combo-timer" style="width: 100%;"></div>
            </div>`;
        }

        const node = comboTree[id];
        const isUnlocked = node.reqInfo !== false;

        let bgClass = "bg-gray-800 border-gray-600 text-gray-400";
        let shadow = "";
        let timerBar = "";

        if (!isUnlocked) {
            bgClass = "bg-gray-900 border-gray-700 text-gray-600 opacity-50 block";
        } else if (isCurrent) {
            bgClass = node.isStrong ? "bg-red-800 border-red-400 text-white" : "bg-blue-800 border-blue-400 text-white";
            shadow = node.isStrong ? "shadow-[0_0_8px_rgba(239,68,68,0.8)]" : "shadow-[0_0_8px_rgba(59,130,246,0.8)]";
            timerBar = `<div class="absolute bottom-0 left-0 h-1 bg-green-400 transition-all duration-75" id="ui-combo-timer" style="width: 100%;"></div>`;
        } else {
            bgClass = node.isStrong ? "bg-gray-800 border-red-500 text-red-200" : "bg-gray-800 border-blue-500 text-blue-200";
        }

        const typeBadge = node.isStrong ? `<span class="bg-red-600 text-[8px] px-0.5 rounded mr-1">å¼·/F</span>` : `<span class="bg-blue-600 text-[8px] px-0.5 rounded mr-1">å¼±/T</span>`;
        const actionLabel = !isUnlocked ? "æœªè§£æ”¾" : node.label;

        return `
            <div class="relative flex items-center justify-center p-1 rounded border text-[10px] font-bold min-w-[70px] transition-all duration-200 ${bgClass} ${shadow} whitespace-nowrap overflow-hidden">
                ${isUnlocked ? typeBadge : ''}<span>${actionLabel}</span>
                ${timerBar}
            </div>
        `;
    }

    const renderArrow = () => `
        <div class="text-gray-400 mx-1 flex-shrink-0 flex items-center">
            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M9 5l7 7-7 7"></path></svg>
        </div>
    `;

    // æ¬¡ã®æ´¾ç”Ÿå…ˆã‚’ç”Ÿæˆ
    let nextNodesHtml = "";
    if (nextIds.length > 0) {
        nextNodesHtml = nextIds.map(id => renderNode(id, false)).join('<div class="w-1"></div>');
    } else {
        nextNodesHtml = `<div class="text-gray-500 text-[10px] font-bold italic ml-2">æ´¾ç”Ÿçµ‚äº†</div>`;
    }

    // ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’æ§‹ç¯‰
    guideEl.innerHTML = `
        <div class="flex flex-row items-center justify-center p-0.5 pointer-events-none">
            ${renderNode(currentState, true)}
            ${nextIds.length > 0 ? renderArrow() : ''}
            <div class="flex flex-col gap-1">
                ${nextNodesHtml}
            </div>
        </div>
    `;
}

function showSkillAnim(name, colorClass, isPractice) {
    const elId = isPractice ? 'prac-hud-skill' : 'hud-skill-name';
    const el = document.getElementById(elId);
    if (!el) return;

    el.innerText = name;
    
    // æ—¢å­˜ã®ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚«ãƒ©ãƒ¼ã‚¯ãƒ©ã‚¹ã‚’å‰Šé™¤
    const classesToRemove = [];
    for (const c of el.classList) {
        if (c.startsWith('from-') || c.startsWith('to-')) {
            classesToRemove.push(c);
        }
    }
    if (classesToRemove.length > 0) {
        el.classList.remove(...classesToRemove);
    }

    // æ–°ã—ã„ã‚«ãƒ©ãƒ¼ã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ 
    const newColorClasses = colorClass.split(' ');
    el.classList.add(...newColorClasses);

    // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¦å†å®Ÿè¡Œ
    el.classList.remove('animate-skill-pop');
    requestAnimationFrame(() => {
        el.classList.add('animate-skill-pop');
    });
}

function executeHitCheck(tPlayer, ad, dmgMult, isPractice) {
    tPlayer.isAttacking = true;
    ad.duration = ad.maxDuration;
    tPlayer.attackData = ad;

    // ãƒ¬ãƒ¼ãƒ³ç™ºå…‰ãƒˆãƒªã‚¬ãƒ¼ï¼ˆæ”»æ’ƒã—ãŸãƒ¬ãƒ¼ãƒ³ã‚’å…‰ã‚‰ã›ã‚‹ï¼‰
    if (ad.type === 'wide' || ad.type === 'front-wide') {
        // åºƒç¯„å›²æ”»æ’ƒ: ä¸Šä¸‹1ãƒ¬ãƒ¼ãƒ³ã‚‚ç™ºå…‰
        for (let r = Math.max(0, tPlayer.row - 1); r <= Math.min(currentRowCount - 1, tPlayer.row + 1); r++) {
            laneGlow[r] = 1.0;
        }
    } else {
        laneGlow[tPlayer.row] = 1.0;
    }

    let baseDamage = GameState.playerStats.atk * dmgMult;
    const isCritical = Math.random() < 0.0025;
    const cvsW = isPractice ? pCanvas.width : canvas.width;
    const cvsH = isPractice ? pCanvas.height : canvas.height;
    const cx = cvsW / 2;
    
    let partsArr = isPractice ? pParticles : particles;
    let dmgTxtArr = isPractice ? pDamageTexts : damageTexts;
    let enemyArr = isPractice ? pEnemies : enemies;

    if (isCritical) {
        GameState.stats.critCount++; 
        baseDamage *= 10;
        ad.range = cvsW; ad.color = 'rgba(255, 0, 0, 0.8)';
        if(ad.type==='normal') ad.type = 'wide';
        showSkillAnim("CRITICAL!", "from-red-500 to-yellow-500", isPractice);
        for(let i=0; i<30; i++) partsArr.push(new Particle(cx, getLaneY(tPlayer.row, cvsH, currentRowCount), (Math.random()-0.5)*1000, (Math.random()-0.5)*1000, 0.5, '#fbbf24', Math.random()*10+5));
    }

    const hitEnemies = [];
    
    enemyArr.forEach(e => {
        let hit = false;
        let eLeft, eRight;
        if (tPlayer.facing === 1) { eLeft = cx; eRight = cx + ad.range; }
        else { eRight = cx; eLeft = cx - ad.range; }
        
        if (ad.type === 'wide') {
            // ä¸­å¿ƒãƒ¬ãƒ¼ãƒ³ï¼‹ä¸Šä¸‹1ãƒ¬ãƒ¼ãƒ³ï¼åˆè¨ˆ3ãƒ¬ãƒ¼ãƒ³ã€ã•ã‚‰ã«è‡ªåˆ†ã®å¾Œã‚å°‘ã—ã‹ã‚‰å‰æ–¹ã®æ”»æ’ƒç¯„å›²
            let bLeft, bRight;
            if (tPlayer.facing === 1) { bRight = cx + ad.range; bLeft = cx - 50; }
            else { bLeft = cx - ad.range; bRight = cx + 50; }
            if (Math.abs(e.row - tPlayer.row) <= 1) {
                if (e.x + e.size >= bLeft && e.x - e.size <= bRight) hit = true;
            }
        } else if (ad.type === 'front-wide') {
            // ä¸­å¿ƒãƒ¬ãƒ¼ãƒ³ï¼‹ä¸Šä¸‹1ãƒ¬ãƒ¼ãƒ³ï¼åˆè¨ˆ3ãƒ¬ãƒ¼ãƒ³ã€å‰æ–¹ã®ã¿
            if (Math.abs(e.row - tPlayer.row) <= 1) {
                if (e.x + e.size >= eLeft && e.x - e.size <= eRight) hit = true;
            }
        } else {
            // normal, pierce (åŒä¸€ãƒ¬ãƒ¼ãƒ³ã®ã¿)
            if (e.row === tPlayer.row) {
                if (e.x + e.size >= eLeft && e.x - e.size <= eRight) hit = true;
            }
        }

        if (hit) {
            hitEnemies.push(e);
            e.hp -= baseDamage;
            e.knockback = ad.knockback;
            dmgTxtArr.push(new DamageText(e.x, e.y - e.size, baseDamage, isCritical));
            for(let i=0; i<3; i++) partsArr.push(new Particle(e.x, e.y, (Math.random()-0.5)*300, (Math.random()-0.5)*300, 0.2, '#fff', 3));
        }
    });

    if (!isPractice) {
        hitEnemies.forEach(e => {
            if (e.hp <= 0) {
                GameState.sessionMoney += e.value;
                GameState.stats.kills++;
                for(let i=0; i<8; i++) partsArr.push(new Particle(e.x, e.y, (Math.random()-0.5)*400, (Math.random()-0.5)*400, 0.4, e.color, Math.random()*4+2));
                enemies.splice(enemies.indexOf(e), 1);
            }
        });
        updateHUD();
        checkWaveEnd();
    } else {
        hitEnemies.forEach(e => { e.hp = e.maxHp; });
    }
}


// === ç·´ç¿’ã‚­ãƒ£ãƒ³ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ ===
let pPlayer;
let pEnemies = [];
let pParticles = [];
let pDamageTexts = [];

function initPractice() {
    pCanvas.width = pCanvas.parentElement.clientWidth;
    pCanvas.height = pCanvas.parentElement.clientHeight;
    
    // â˜…æ‹ ç‚¹ç”»é¢ã§é¸æŠä¸­ã®Waveã«åˆã‚ã›ã¦ãƒ¬ãƒ¼ãƒ³æ•°ã‚’æ›´æ–°
    currentRowCount = Math.min(5, GameState.selectedWave);
    
    pPlayer = new Player();
    pEnemies = [];
    
    // â˜…ãƒ¬ãƒ¼ãƒ³æ•°ã«åˆã‚ã›ã¦æ•µã‚’é…ç½®ï¼ˆç·´ç¿’ç”¨ã«è¿‘ã‚ã«é…ç½®ï¼†ä¸­å¤®ã«å¯†é›†ï¼‰
    for(let i=0; i<currentRowCount; i++) {
        let e = new Enemy(i, -1, 1, i===Math.floor(currentRowCount/2));
        e.speed = 0; e.hp = 9999; e.maxHp = 9999;
        e.x = (pCanvas.width / 2) + 80; // è¿‘ã¥ã‘ã‚‹
        e.y = getLaneY(i, pCanvas.height, currentRowCount);
        pEnemies.push(e);
        
        let e2 = new Enemy(i, 1, 1, false); 
        e2.speed = 0; e2.hp = 9999; e2.maxHp = 9999;
        e2.x = (pCanvas.width / 2) - 80; // è¿‘ã¥ã‘ã‚‹
        e2.y = getLaneY(i, pCanvas.height, currentRowCount);
        pEnemies.push(e2);
    }
    updateComboGuideUI([], true);
}


// === ãƒ¡ã‚¤ãƒ³ãƒãƒˆãƒ«ãƒ­ã‚¸ãƒƒã‚¯ ===

function commitSessionRewards() {
    GameState.money += GameState.sessionMoney;
    
    let newArchivesCount = 0;
    GameState.sessionDrops.forEach(dropItem => {
        if (dropItem.storyTitle && !GameState.inventory.some(i => i.id === dropItem.id)) {
            newArchivesCount++;
        }
        let emptyId = null;
        for (let i=0; i<40; i++) { if (!GameState.inventory.some(item => item.cellId === `cell_${i}`)) { emptyId = `cell_${i}`; break; } }
        if (emptyId) { dropItem.cellId = emptyId; GameState.inventory.push(dropItem); }
    });

    if (newArchivesCount > 0) {
        const buffAtk = newArchivesCount * 2;
        const buffHp = newArchivesCount * 20;
        GameState.playerStats.atk += buffAtk;
        GameState.playerStats.maxHp += buffHp;
        setTimeout(() => showMessageToast("æ–‡æ˜ã®å¾©å…ƒãƒœãƒ¼ãƒŠã‚¹", `åŸºç¤æ”»æ’ƒåŠ›+${buffAtk} / æœ€å¤§HP+${buffHp}`, "bg-yellow-700"), 500);
    }
    
    GameState.sessionMoney = 0;
    GameState.sessionDrops = [];
}

function startBattleSession() {
    GameState.sessionMoney = 0; GameState.sessionDrops = []; GameState.playerStats.hp = GameState.playerStats.maxHp;
    
    // â˜…å‡ºæ’ƒã™ã‚‹Waveã«åˆã‚ã›ã¦ãƒ¬ãƒ¼ãƒ³æ•°ã‚’æ›´æ–°
    currentRowCount = Math.min(5, GameState.currentWave);
    
    player = new Player();
    startWave(GameState.currentWave);
    updateComboGuideUI([], false);
}

function startWave(waveNum) {
    waveModal.classList.add('hidden'); enemies = []; particles = []; damageTexts = []; isWaveActive = true;
    hudWave.innerText = waveNum;
    enemiesToSpawn = 15 + waveNum * 10; 
    spawnTimer = 0;
    currentWaveMult = 1 + ((waveNum - 1) * 0.2); 
    updateHUD();
}

function updateHUD() {
    hudBaseMoney.innerText = GameState.money;
    hudSessionMoney.innerText = GameState.sessionMoney;
    hudHpVal.innerText = Math.max(0, Math.floor(GameState.playerStats.hp));
    hudMaxHpVal.innerText = GameState.playerStats.maxHp;
    hudEnemies.innerText = enemies.length + enemiesToSpawn;
    const hpPercent = Math.max(0, GameState.playerStats.hp / GameState.playerStats.maxHp) * 100;
    hudHpBar.style.width = hpPercent + '%';
    hudHpBar.className = `h-full w-full transition-all duration-200 ${hpPercent < 30 ? 'bg-red-500' : 'bg-green-500'}`;
}

function checkWaveEnd() {
    if (enemiesToSpawn <= 0 && enemies.length === 0 && isWaveActive) { 
        isWaveActive = false; 
        if (GameState.currentWave >= GameState.maxWave) GameState.maxWave = GameState.currentWave + 1;
        showWaveModal(); 
    }
}

function checkBaseDamage(dt) {
    const cx = canvas.width / 2;
    enemies.forEach(e => {
        if (Math.abs(e.x - cx) <= 40) {
            GameState.playerStats.hp -= e.damage * dt;
            ctx.fillStyle = 'rgba(255,0,0,0.1)'; ctx.fillRect(0,0,canvas.width,canvas.height);
            if (GameState.playerStats.hp <= 0) {
                isWaveActive = false;
                GameState.sessionMoney = Math.floor(GameState.sessionMoney / 2);
                GameState.sessionDrops = []; 
                GameState.money += GameState.sessionMoney; 
                GameState.sessionMoney = 0;
                deathModal.classList.remove('hidden');
            }
        }
    });
    updateHUD();
}

// â˜…å‹•çš„ãƒ¬ãƒ¼ãƒ³æç”»ã«å¯¾å¿œ
function drawCommonBg(c_ctx, w, h, rowCount) {
    c_ctx.strokeStyle = '#334155'; c_ctx.lineWidth = 2;
    for (let i = 0; i < rowCount; i++) {
        const y = getLaneY(i, h, rowCount);
        // ãƒ¬ãƒ¼ãƒ³ç™ºå…‰æ¼”å‡ºï¼ˆæ”»æ’ƒæ™‚ã«ãƒ¬ãƒ¼ãƒ³ãŒç™½ãå…‰ã‚‹ï¼‰
        if (laneGlow[i] > 0) {
            c_ctx.save();
            c_ctx.fillStyle = `rgba(255, 255, 255, ${laneGlow[i] * 0.15})`;
            c_ctx.fillRect(0, y - LANE_HEIGHT/2, w, LANE_HEIGHT);
            c_ctx.restore();
            laneGlow[i] -= 0.05;
        }
        c_ctx.beginPath(); c_ctx.moveTo(0, y); c_ctx.lineTo(w, y); c_ctx.stroke();
        c_ctx.strokeStyle = '#1e293b'; 
        c_ctx.beginPath(); c_ctx.moveTo(0, y - LANE_HEIGHT/2); c_ctx.lineTo(w, y - LANE_HEIGHT/2); c_ctx.stroke();
        c_ctx.strokeStyle = '#334155';
    }
    // ä¸€ç•ªä¸‹ã®ãƒ¬ãƒ¼ãƒ³ã®ä¸‹æ ã‚‚æç”»
    const bottomY = getLaneY(rowCount - 1, h, rowCount) + LANE_HEIGHT/2;
    c_ctx.strokeStyle = '#1e293b'; 
    c_ctx.beginPath(); c_ctx.moveTo(0, bottomY); c_ctx.lineTo(w, bottomY); c_ctx.stroke();

    const cx = w/2;
    c_ctx.fillStyle = 'rgba(59, 130, 246, 0.1)'; c_ctx.fillRect(cx - 40, 0, 80, h);
    c_ctx.strokeStyle = '#3b82f6';
    c_ctx.beginPath(); c_ctx.moveTo(cx - 40, 0); c_ctx.lineTo(cx - 40, h); c_ctx.stroke();
    c_ctx.beginPath(); c_ctx.moveTo(cx + 40, 0); c_ctx.lineTo(cx + 40, h); c_ctx.stroke();
}


// === çµ±åˆã‚²ãƒ¼ãƒ ãƒ«ãƒ¼ãƒ— ===
function gameLoop(timestamp) {
    const dt = Math.min((timestamp - lastTime) / 1000, 0.1);
    lastTime = timestamp;

    if (screens.battle && screens.battle.classList.contains('active')) {
        // Battle Loop
        const container = document.getElementById('canvas-container');
        if (container && (canvas.width !== container.clientWidth || canvas.height !== container.clientHeight)) {
            canvas.width = container.clientWidth;
            canvas.height = container.clientHeight;
        }
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        drawCommonBg(ctx, canvas.width, canvas.height, currentRowCount);

        if (isWaveActive) {
            if (enemiesToSpawn > 0) {
                spawnTimer -= dt;
                if (spawnTimer <= 0) {
                    let maxSpawn = GameState.currentWave === 1 ? 1 : (GameState.currentWave === 2 ? 2 : 3);
                    let spawnCount = Math.floor(Math.random() * maxSpawn) + 1;
                    for (let i = 0; i < spawnCount && enemiesToSpawn > 0; i++) {
                        const row = Math.floor(Math.random() * currentRowCount); // â˜…å‹•çš„ãƒ¬ãƒ¼ãƒ³æ•°ã‹ã‚‰ã‚¹ãƒãƒ¼ãƒ³
                        const side = Math.random() > 0.5 ? 1 : -1;
                        const isTough = Math.random() < Math.min(0.4, GameState.currentWave * 0.08);
                        let e = new Enemy(row, side, currentWaveMult, isTough);
                        e.x = side === 1 ? -50 : canvas.width + 50;
                        e.y = getLaneY(row, canvas.height, currentRowCount) + (Math.random()*20-10);
                        enemies.push(e);
                        enemiesToSpawn--;
                    }
                    spawnTimer = 0.4 + Math.random() * 0.6;
                    updateHUD();
                }
            }

            if (player) player.update(dt, () => updateComboGuideUI([], false));
            enemies.forEach(e => e.update(dt, canvas.width));
            checkBaseDamage(dt);
            enemies.forEach(e => e.draw(ctx, canvas.width, canvas.height));
            if (player) player.draw(ctx, canvas.width, canvas.height);
            for (let i = particles.length - 1; i >= 0; i--) {
                const p = particles[i]; p.update(dt); p.draw(ctx, canvas.width, canvas.height);
                if (p.life <= 0) particles.splice(i, 1);
            }
            for (let i = damageTexts.length - 1; i >= 0; i--) {
                const dtObj = damageTexts[i]; dtObj.update(dt); dtObj.draw(ctx);
                if (dtObj.life <= 0) damageTexts.splice(i, 1);
            }
        } else if (player && GameState.playerStats.hp > 0) {
            player.draw(ctx, canvas.width, canvas.height);
        }

    } else if (screens.base && screens.base.classList.contains('active')) {
        const isStatusVisible = !document.getElementById('tab-status').classList.contains('hidden');
        const isBaseHomeVisible = !document.getElementById('tab-base-home').classList.contains('hidden');
        if (isStatusVisible || isBaseHomeVisible) {
            // Practice Loop
            const pContainer = pCanvas ? pCanvas.parentElement : null;
            if (pContainer && pCanvas && (pCanvas.width !== pContainer.clientWidth || pCanvas.height !== pContainer.clientHeight)) {
                pCanvas.width = pContainer.clientWidth;
                pCanvas.height = pContainer.clientHeight;
            }
            const _pCtx = pCanvas.getContext('2d');
            _pCtx.clearRect(0, 0, pCanvas.width, pCanvas.height);
            drawCommonBg(_pCtx, pCanvas.width, pCanvas.height, currentRowCount);

            if (pPlayer) {
                pPlayer.update(dt, () => updateComboGuideUI([], true));
                pEnemies.forEach(e => {
                    if (e.knockback > 0) {
                        e.x -= e.side * e.knockback * dt * 10;
                        e.knockback -= dt * 20;
                    } else {
                        let targetX = (pCanvas.width/2) + (e.side * -120);
                        e.x += (targetX - e.x) * dt * 5;
                    }
                    e.draw(_pCtx, pCanvas.width, pCanvas.height);
                });
                pPlayer.draw(_pCtx, pCanvas.width, pCanvas.height);
                for (let i = pParticles.length - 1; i >= 0; i--) { pParticles[i].update(dt); pParticles[i].draw(_pCtx); if (pParticles[i].life <= 0) pParticles.splice(i, 1); }
                for (let i = pDamageTexts.length - 1; i >= 0; i--) { pDamageTexts[i].update(dt); pDamageTexts[i].draw(_pCtx); if (pDamageTexts[i].life <= 0) pDamageTexts.splice(i, 1); }
            }
        }
    }

    const timerEl = document.getElementById('ui-combo-timer');
    if (timerEl) {
        let activePlayer = (screens.battle && screens.battle.classList.contains('active')) ? player : pPlayer;
        if (activePlayer && activePlayer.comboTimer > 0) {
            let ratio = Math.max(0, activePlayer.comboTimer / 1.0);
            timerEl.style.width = (ratio * 100) + '%';
            timerEl.className = `absolute bottom-0 left-0 h-1 transition-all duration-75 ${ratio > 0.5 ? 'bg-green-400' : (ratio > 0.2 ? 'bg-yellow-400' : 'bg-red-500')}`;
        } else {
            timerEl.style.width = '0%';
        }
    }

    requestAnimationFrame(gameLoop);
}

// === ãƒ¢ãƒ¼ãƒ€ãƒ«ãƒœã‚¿ãƒ³å‡¦ç† ===
function showWaveModal() {
    modalMoney.innerText = GameState.sessionMoney;
    
    let droppedItem = null;
    const specialArchive = ArchiveDB.find(a => a.targetWave === GameState.currentWave && !GameState.inventory.some(i => i.id === a.id));
    
    if (specialArchive) {
        droppedItem = Object.assign({}, specialArchive);
    } else {
        const dropChance = Math.min(0.8, 0.2 + (GameState.currentWave * 0.1));
        if (Math.random() < dropChance) {
            droppedItem = Object.assign({ id: 'junk_' + Date.now() }, GameState.itemDB[Math.floor(Math.random() * GameState.itemDB.length)]);
        }
    }

    if (droppedItem) {
        GameState.sessionDrops.push(droppedItem);
        dropItemIcon.innerText = droppedItem.icon;
        dropItemName.innerText = droppedItem.name;
        dropTitle.innerText = droppedItem.storyTitle ? "â˜… éºç‰©ã‚’å›å" : "ã‚¸ãƒ£ãƒ³ã‚¯å“ã‚’å›å";
        dropNotification.classList.remove('hidden');
    } else { 
        dropNotification.classList.add('hidden'); 
    }
    
    waveModal.classList.remove('hidden');
}

btnNextWave.addEventListener('click', () => { 
    commitSessionRewards(); 
    GameState.currentWave++; GameState.selectedWave = GameState.currentWave;
    // â˜…ãƒ¬ãƒ¼ãƒ³æ•°ã‚‚æ¬¡ã®WAVEã«åˆã‚ã›ã¦æ›´æ–°ï¼ˆã“ã‚ŒãŒãªã„ã¨å¢—ãˆãªã„ã¾ã¾ï¼ï¼‰
    currentRowCount = Math.min(5, GameState.currentWave);
    player.row = Math.min(player.row, currentRowCount - 1);
    saveGame(); // ğŸ’¾ ã‚¦ã‚§ãƒ¼ãƒ–é–“ã§ã‚‚ã¡ã‚ƒã‚“ã¨ã‚»ãƒ¼ãƒ–ã€‚æ²¹æ–­å¤§æ•µã€‚
    startWave(GameState.currentWave); 
});

btnReturn.addEventListener('click', () => {
    commitSessionRewards(); 
    waveModal.classList.add('hidden'); isWaveActive = false;
    GameState.selectedWave = Math.max(1, GameState.maxWave - 1);
    saveGame(); // ğŸ’¾ å¸°é‚„ï¼ã‚»ãƒ¼ãƒ–ãƒã‚¤ãƒ³ãƒˆã€‚RPGã®é‰„å‰‡ã€‚
    showScreen('base');
});

btnDeathReturn.addEventListener('click', () => { 
    deathModal.classList.add('hidden'); isWaveActive = false;
    GameState.selectedWave = Math.max(1, GameState.maxWave - 1);
    saveGame(); // ğŸ’¾ æ­»ã‚“ã§ã‚‚ã‚»ãƒ¼ãƒ–ã¯æ®‹ã‚‹ã€‚ãã†ã€Supabaseãªã‚‰ã­ã€‚
    showScreen('base'); 
});


// === åˆæœŸåŒ– ===
    // ğŸ’¾ ã¾ãšã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ­ãƒ¼ãƒ‰ã€‚ãªã‘ã‚Œã°æ–°è¦å†’é™ºã®å§‹ã¾ã‚Šã ï¼
    await loadGame();
    resizeCanvas();
    showScreen('base');
    lastTime = performance.now();
    requestAnimationFrame(gameLoop);

window.addEventListener('resize', resizeCanvas);

window.tryMove = tryMove;
window.tryTurn = tryTurn;
window.triggerAction = triggerAction;

});
</script> </main>  </body></html>